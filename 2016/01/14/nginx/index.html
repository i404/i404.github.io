
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>nginx | i404&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="i404">
    

    
    <meta name="description" content="nginx平台初探(100%)初探nginx架构(100%)众所周知，nginx性能高，而nginx的高性能与其架构是分不开的。那么nginx究竟是怎么样的呢？这一节我们先来初识一下nginx框架吧。
nginx在启动后，在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。我们也可以手动地关掉后台模式，让nginx在前台运行，并且通过配置让ng">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx">
<meta property="og:url" content="http://i404.github.io/2016/01/14/nginx/index.html">
<meta property="og:site_name" content="i404's Blog">
<meta property="og:description" content="nginx平台初探(100%)初探nginx架构(100%)众所周知，nginx性能高，而nginx的高性能与其架构是分不开的。那么nginx究竟是怎么样的呢？这一节我们先来初识一下nginx框架吧。
nginx在启动后，在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。我们也可以手动地关掉后台模式，让nginx在前台运行，并且通过配置让ng">
<meta property="og:updated_time" content="2016-01-14T05:23:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx">
<meta name="twitter:description" content="nginx平台初探(100%)初探nginx架构(100%)众所周知，nginx性能高，而nginx的高性能与其架构是分不开的。那么nginx究竟是怎么样的呢？这一节我们先来初识一下nginx框架吧。
nginx在启动后，在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。我们也可以手动地关掉后台模式，让nginx在前台运行，并且通过配置让ng">

    
    <link rel="alternative" href="/atom.xml" title="i404&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="i404&#39;s Blog" title="i404&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="i404&#39;s Blog">i404&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">i404</a></li>
					
						<li><a href="/atom.xml">RSS</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="ts-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/nginx/" title="nginx" itemprop="url">nginx</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="i404" target="_blank" itemprop="author">i404</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T04:08:39.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx平台初探(100%)"><span class="toc-number">1.</span> <span class="toc-text">nginx平台初探(100%)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初探nginx架构(100%)"><span class="toc-number">1.1.</span> <span class="toc-text">初探nginx架构(100%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx基础概念(100%)"><span class="toc-number">1.2.</span> <span class="toc-text">nginx基础概念(100%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本数据结构(99%)"><span class="toc-number">1.3.</span> <span class="toc-text">基本数据结构(99%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx的请求处理"><span class="toc-number">1.4.</span> <span class="toc-text">nginx的请求处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_操作系统提供的机制（例如epoll,_kqueue等）产生相关的事件。"><span class="toc-number">2.</span> <span class="toc-text">) 操作系统提供的机制（例如epoll, kqueue等）产生相关的事件。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_接收和处理这些事件，如是接受到数据，则产生更高层的request对象。"><span class="toc-number">3.</span> <span class="toc-text">) 接收和处理这些事件，如是接受到数据，则产生更高层的request对象。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理request的header和body。"><span class="toc-number">4.</span> <span class="toc-text">) 处理request的header和body。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_产生响应，并发送回客户端。"><span class="toc-number">5.</span> <span class="toc-text">) 产生响应，并发送回客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_完成request的处理。"><span class="toc-number">6.</span> <span class="toc-text">) 完成request的处理。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_重新初始化定时器及其他事件。"><span class="toc-number">7.</span> <span class="toc-text">) 重新初始化定时器及其他事件。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_初始化HTTP_Request（读取来自客户端的数据，生成HTTP_Request对象，该对象含有该请求所有的信息）。"><span class="toc-number">8.</span> <span class="toc-text">) 初始化HTTP Request（读取来自客户端的数据，生成HTTP Request对象，该对象含有该请求所有的信息）。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理请求头。"><span class="toc-number">9.</span> <span class="toc-text">) 处理请求头。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理请求体。"><span class="toc-number">10.</span> <span class="toc-text">) 处理请求体。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果有的话，调用与此请求（URL或者Location）关联的handler。"><span class="toc-number">11.</span> <span class="toc-text">) 如果有的话，调用与此请求（URL或者Location）关联的handler。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_依次调用各phase_handler进行处理。"><span class="toc-number">12.</span> <span class="toc-text">) 依次调用各phase handler进行处理。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_获取location配置。"><span class="toc-number">13.</span> <span class="toc-text">) 获取location配置。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_产生适当的响应。"><span class="toc-number">14.</span> <span class="toc-text">) 产生适当的响应。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_发送response_header。"><span class="toc-number">15.</span> <span class="toc-text">) 发送response header。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_发送response_body。"><span class="toc-number">16.</span> <span class="toc-text">) 发送response body。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_random_index_on，那么随机选择一个文件，发送给客户端。"><span class="toc-number">17.</span> <span class="toc-text">) 如果一个location里面有配置  random_index  on，那么随机选择一个文件，发送给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_index指令，那么发送index指令指明的文件，给客户端。"><span class="toc-number">18.</span> <span class="toc-text">) 如果一个location里面有配置 index指令，那么发送index指令指明的文件，给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_autoindex_on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。"><span class="toc-number">19.</span> <span class="toc-text">) 如果一个location里面有配置 autoindex  on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果这个request对应的location上有设置gzip_static_on，那么就查找是否有对应的-gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。"><span class="toc-number">20.</span> <span class="toc-text">) 如果这个request对应的location上有设置gzip_static on，那么就查找是否有对应的.gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_请求的URI如果对应一个静态文件，static_module就发送静态文件的内容到客户端。"><span class="toc-number">21.</span> <span class="toc-text">) 请求的URI如果对应一个静态文件，static module就发送静态文件的内容到客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_server-side_includes。"><span class="toc-number">22.</span> <span class="toc-text">) server-side includes。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_XSLT_filtering。"><span class="toc-number">23.</span> <span class="toc-text">) XSLT filtering。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_图像缩放之类的。"><span class="toc-number">24.</span> <span class="toc-text">) 图像缩放之类的。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_gzip压缩。"><span class="toc-number">25.</span> <span class="toc-text">) gzip压缩。</span></a></li></ol>
		
		</div>
		
		<h1 id="nginx平台初探(100%)">nginx平台初探(100%)</h1><h2 id="初探nginx架构(100%)">初探nginx架构(100%)</h2><p>众所周知，nginx性能高，而nginx的高性能与其架构是分不开的。那么nginx究竟是怎么样的呢？这一节我们先来初识一下nginx框架吧。</p>
<p>nginx在启动后，在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。我们也可以手动地关掉后台模式，让nginx在前台运行，并且通过配置让nginx取消master进程，从而可以使nginx以单进程方式运行。很显然，生产环境下我们肯定不会这么做，所以关闭后台模式，一般是用来调试用的，在后面的章节里面，我们会详细地讲解如何调试nginx。所以，我们可以看到，nginx是以多进程的方式来工作的，当然nginx也是支持多线程的方式的，只是我们主流的方式还是多进程的方式，也是nginx的默认方式。nginx采用多进程的方式有诸多好处，所以我就主要讲解nginx的多进程模式吧。</p>
<p>刚才讲到，nginx在启动后，会有一个master进程和多个worker进程。master进程主要用来管理worker进程，包含：接收来自外界的信号，向各worker进程发送信号，监控worker进程的运行状态，当worker进程退出后(异常情况下)，会自动重新启动新的worker进程。而基本的网络事件，则是放在worker进程中来处理了。多个worker进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个worker进程中处理，一个worker进程，不可能处理其它进程的请求。worker进程的个数是可以设置的，一般我们会设置与机器cpu核数一致，这里面的原因与nginx的进程模型以及事件处理模型是分不开的。nginx的进程模型，可以由下图来表示：</p>
<p>.. image:: <a href="http://tengine.taobao.org/book/_images/chapter-2-1.PNG" target="_blank" rel="external">http://tengine.taobao.org/book/_images/chapter-2-1.PNG</a><br>    :alt: nginx进程模型<br>    :align: center</p>
<p>在nginx启动后，如果我们要操作nginx，要怎么做呢？从上文中我们可以看到，master来管理worker进程，所以我们只需要与master进程通信就行了。master进程会接收来自外界发来的信号，再根据信号做不同的事情。所以我们要控制nginx，只需要通过kill向master进程发送信号就行了。比如kill -HUP pid，则是告诉nginx，从容地重启nginx，我们一般用这个信号来重启nginx，或重新加载配置，因为是从容地重启，因此服务是不中断的。master进程在接收到HUP信号后是怎么做的呢？首先master进程在接到信号后，会先重新加载配置文件，然后再启动新的worker进程，并向所有老的worker进程发送信号，告诉他们可以光荣退休了。新的worker在启动后，就开始接收新的请求，而老的worker在收到来自master的信号后，就不再接收新的请求，并且在当前进程中的所有未处理完的请求处理完成后，再退出。当然，直接给master进程发送信号，这是比较老的操作方式，nginx在0.8版本之后，引入了一系列命令行参数，来方便我们管理。比如，./nginx -s reload，就是来重启nginx，./nginx -s stop，就是来停止nginx的运行。如何做到的呢？我们还是拿reload来说，我们看到，执行命令时，我们是启动一个新的nginx进程，而新的nginx进程在解析到reload参数后，就知道我们的目的是控制nginx来重新加载配置文件了，它会向master进程发送信号，然后接下来的动作，就和我们直接向master进程发送信号一样了。</p>
<p>现在，我们知道了当我们在操作nginx的时候，nginx内部做了些什么事情，那么，worker进程又是如何处理请求的呢？我们前面有提到，worker进程之间是平等的，每个进程，处理请求的机会也是一样的。当我们提供80端口的http服务时，一个连接请求过来，每个进程都有可能处理这个连接，怎么做到的呢？首先，每个worker进程都是从master进程fork过来，在master进程里面，先建立好需要listen的socket（listenfd）之后，然后再fork出多个worker进程。所有worker进程的listenfd会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有worker进程在注册listenfd读事件前抢accept_mutex，抢到互斥锁的那个进程注册listenfd读事件，在读事件里调用accept接受该连接。当一个worker进程在accept这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接，这样一个完整的请求就是这样的了。我们可以看到，一个请求，完全由worker进程来处理，而且只在一个worker进程中处理。</p>
<p>那么，nginx采用这种进程模型有什么好处呢？当然，好处肯定会很多了。首先，对于每个worker进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查找时，也会方便很多。其次，采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快启动新的worker进程。当然，worker进程的异常退出，肯定是程序有bug了，异常退出，会导致当前worker上的所有请求失败，不过不会影响到所有请求，所以降低了风险。当然，好处还有很多，大家可以慢慢体会。</p>
<p>上面讲了很多关于nginx的进程模型，接下来，我们来看看nginx是如何处理事件的。</p>
<p>有人可能要问了，nginx采用多worker的方式来处理请求，每个worker里面只有一个主线程，那能够处理的并发数很有限啊，多少个worker就能处理多少个并发，何来高并发呢？非也，这就是nginx的高明之处，nginx采用了异步非阻塞的方式来处理请求，也就是说，nginx是可以同时处理成千上万个请求的。想想apache的常用工作方式（apache也有异步非阻塞版本，但因其与自带某些模块冲突，所以不常用），每个请求会独占一个工作线程，当并发数上到几千时，就同时有几千的线程在处理请求了。这对操作系统来说，是个不小的挑战，线程带来的内存占用非常大，线程的上下文切换带来的cpu开销很大，自然性能就上不去了，而这些开销完全是没有意义的。</p>
<p>为什么nginx可以采用异步非阻塞的方式来处理呢，或者异步非阻塞到底是怎么回事呢？我们先回到原点，看看一个请求的完整过程。首先，请求过来，要建立连接，然后再接收数据，接收数据后，再发送数据。具体到系统底层，就是读写事件，而当读写事件没有准备好时，必然不可操作，如果不用非阻塞的方式来调用，那就得阻塞调用了，事件没有准备好，那就只能等了，等事件准备好了，你再继续吧。阻塞调用会进入内核等待，cpu就会让出去给别人用了，对单线程的worker来说，显然不合适，当网络事件越多时，大家都在等待呢，cpu空闲下来没人用，cpu利用率自然上不去了，更别谈高并发了。好吧，你说加进程数，这跟apache的线程模型有什么区别，注意，别增加无谓的上下文切换。所以，在nginx里面，最忌讳阻塞的系统调用了。不要阻塞，那就非阻塞喽。非阻塞就是，事件没有准备好，马上返回EAGAIN，告诉你，事件还没准备好呢，你慌什么，过会再来吧。好吧，你过一会，再来检查一下事件，直到事件准备好了为止，在这期间，你就可以先去做其它事情，然后再来看看事件好了没。虽然不阻塞了，但你得不时地过来检查一下事件的状态，你可以做更多的事情了，但带来的开销也是不小的。所以，才会有了异步非阻塞的事件处理机制，具体到系统调用就是像select/poll/epoll/kqueue这样的系统调用。它们提供了一种机制，让你可以同时监控多个事件，调用他们是阻塞的，但可以设置超时时间，在超时时间之内，如果有事件准备好了，就返回。这种机制正好解决了我们上面的两个问题，拿epoll为例(在后面的例子中，我们多以epoll为例子，以代表这一类函数)，当事件没准备好时，放到epoll里面，事件准备好了，我们就去读写，当读写返回EAGAIN时，我们将它再次加入到epoll里面。这样，只要有事件准备好了，我们就去处理它，只有当所有事件都没准备好时，才在epoll里面等着。这样，我们就可以并发处理大量的并发了，当然，这里的并发请求，是指未处理完的请求，线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求间进行不断地切换而已，切换也是因为异步事件未准备好，而主动让出的。这里的切换是没有任何代价，你可以理解为循环处理多个准备好的事件，事实上就是这样的。与多线程相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的内存也很少，没有上下文切换，事件处理非常的轻量级。并发数再多也不会导致无谓的资源浪费（上下文切换）。更多的并发数，只是会占用更多的内存而已。 我之前有对连接数进行过测试，在24G内存的机器上，处理的并发请求数达到过200万。现在的网络服务器基本都采用这种方式，这也是nginx性能高效的主要原因。</p>
<p>我们之前说过，推荐设置worker的个数为cpu的核数，在这里就很容易理解了，更多的worker数，只会导致进程来竞争cpu资源了，从而带来不必要的上下文切换。而且，nginx为了更好的利用多核特性，提供了cpu亲缘性的绑定选项，我们可以将某一个进程绑定在某一个核上，这样就不会因为进程的切换带来cache的失效。像这种小的优化在nginx中非常常见，同时也说明了nginx作者的苦心孤诣。比如，nginx在做4个字节的字符串比较时，会将4个字符转换成一个int型，再作比较，以减少cpu的指令数等等。</p>
<p>现在，知道了nginx为什么会选择这样的进程模型与事件模型了。对于一个基本的web服务器来说，事件通常有三种类型，网络事件、信号、定时器。从上面的讲解中知道，网络事件通过异步非阻塞可以很好的解决掉。如何处理信号与定时器？</p>
<p>首先，信号的处理。对nginx来说，有一些特定的信号，代表着特定的意义。信号会中断掉程序当前的运行，在改变状态后，继续执行。如果是系统调用，则可能会导致系统调用的失败，需要重入。关于信号的处理，大家可以学习一些专业书籍，这里不多说。对于nginx来说，如果nginx正在等待事件（epoll_wait时），如果程序收到信号，在信号处理函数处理完后，epoll_wait会返回错误，然后程序可再次进入epoll_wait调用。</p>
<p>另外，再来看看定时器。由于epoll_wait等函数在调用的时候是可以设置一个超时时间的，所以nginx借助这个超时时间来实现定时器。nginx里面的定时器事件是放在一颗维护定时器的红黑树里面，每次在进入epoll_wait前，先从该红黑树里面拿到所有定时器事件的最小时间，在计算出epoll_wait的超时时间后进入epoll_wait。所以，当没有事件产生，也没有中断信号时，epoll_wait会超时，也就是说，定时器事件到了。这时，nginx会检查所有的超时事件，将他们的状态设置为超时，然后再去处理网络事件。由此可以看出，当我们写nginx代码时，在处理网络事件的回调函数时，通常做的第一个事情就是判断超时，然后再去处理网络事件。</p>
<p>我们可以用一段伪代码来总结一下nginx的事件处理模型：</p>
<p>.. code:: c</p>
<pre><code><span class="keyword">while</span> (<span class="literal">true</span>) {
    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="string">run_tasks:</span>
        t.handler();
    update_time(&amp;now);
    timeout = ETERNITY;
    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="string">wait_tasks:</span> <span class="comment">/* sorted already */</span>
        <span class="keyword">if</span> (t.time &lt;= now) {
            t.timeout_handler();
        } <span class="keyword">else</span> {
            timeout = t.time - now;
            <span class="keyword">break</span>;
        }
    nevents = poll_function(events, timeout);
    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">nevents:</span>
        task t;
        <span class="keyword">if</span> (events[i].type == READ) {
            t.handler = read_handler;
        } <span class="keyword">else</span> { <span class="comment">/* events[i].type == WRITE */</span>
            t.handler = write_handler;
        }
        run_tasks_add(t);
}
</code></pre><p>好，本节我们讲了进程模型，事件模型，包括网络事件，信号，定时器事件。</p>
<h2 id="nginx基础概念(100%)">nginx基础概念(100%)</h2><p>connection<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#22312;nginx&#20013;connection&#23601;&#26159;&#23545;tcp&#36830;&#25509;&#30340;&#23553;&#35013;&#65292;&#20854;&#20013;&#21253;&#25324;&#36830;&#25509;&#30340;socket&#65292;&#35835;&#20107;&#20214;&#65292;&#20889;&#20107;&#20214;&#12290;&#21033;&#29992;nginx&#23553;&#35013;&#30340;connection&#65292;&#25105;&#20204;&#21487;&#20197;&#24456;&#26041;&#20415;&#30340;&#20351;&#29992;nginx&#26469;&#22788;&#29702;&#19982;&#36830;&#25509;&#30456;&#20851;&#30340;&#20107;&#24773;&#65292;&#27604;&#22914;&#65292;&#24314;&#31435;&#36830;&#25509;&#65292;&#21457;&#36865;&#19982;&#25509;&#21463;&#25968;&#25454;&#31561;&#12290;&#32780;nginx&#20013;&#30340;http&#35831;&#27714;&#30340;&#22788;&#29702;&#23601;&#26159;&#24314;&#31435;&#22312;connection&#20043;&#19978;&#30340;&#65292;&#25152;&#20197;nginx&#19981;&#20165;&#21487;&#20197;&#20316;&#20026;&#19968;&#20010;web&#26381;&#21153;&#22120;&#65292;&#20063;&#21487;&#20197;&#20316;&#20026;&#37038;&#20214;&#26381;&#21153;&#22120;&#12290;&#24403;&#28982;&#65292;&#21033;&#29992;nginx&#25552;&#20379;&#30340;connection&#65292;&#25105;&#20204;&#21487;&#20197;&#19982;&#20219;&#20309;&#21518;&#31471;&#26381;&#21153;&#25171;&#20132;&#36947;&#12290;&#10;&#10;&#32467;&#21512;&#19968;&#20010;tcp&#36830;&#25509;&#30340;&#29983;&#21629;&#21608;&#26399;&#65292;&#25105;&#20204;&#30475;&#30475;nginx&#26159;&#22914;&#20309;&#22788;&#29702;&#19968;&#20010;&#36830;&#25509;&#30340;&#12290;&#39318;&#20808;&#65292;nginx&#22312;&#21551;&#21160;&#26102;&#65292;&#20250;&#35299;&#26512;&#37197;&#32622;&#25991;&#20214;&#65292;&#24471;&#21040;&#38656;&#35201;&#30417;&#21548;&#30340;&#31471;&#21475;&#19982;ip&#22320;&#22336;&#65292;&#28982;&#21518;&#22312;nginx&#30340;master&#36827;&#31243;&#37324;&#38754;&#65292;&#20808;&#21021;&#22987;&#21270;&#22909;&#36825;&#20010;&#30417;&#25511;&#30340;socket(&#21019;&#24314;socket&#65292;&#35774;&#32622;addrreuse&#31561;&#36873;&#39033;&#65292;&#32465;&#23450;&#21040;&#25351;&#23450;&#30340;ip&#22320;&#22336;&#31471;&#21475;&#65292;&#20877;listen)&#65292;&#28982;&#21518;&#20877;fork&#20986;&#22810;&#20010;&#23376;&#36827;&#31243;&#20986;&#26469;&#65292;&#28982;&#21518;&#23376;&#36827;&#31243;&#20250;&#31454;&#20105;accept&#26032;&#30340;&#36830;&#25509;&#12290;&#27492;&#26102;&#65292;&#23458;&#25143;&#31471;&#23601;&#21487;&#20197;&#21521;nginx&#21457;&#36215;&#36830;&#25509;&#20102;&#12290;&#24403;&#23458;&#25143;&#31471;&#19982;&#26381;&#21153;&#31471;&#36890;&#36807;&#19977;&#27425;&#25569;&#25163;&#24314;&#31435;&#22909;&#19968;&#20010;&#36830;&#25509;&#21518;&#65292;nginx&#30340;&#26576;&#19968;&#20010;&#23376;&#36827;&#31243;&#20250;accept&#25104;&#21151;&#65292;&#24471;&#21040;&#36825;&#20010;&#24314;&#31435;&#22909;&#30340;&#36830;&#25509;&#30340;socket&#65292;&#28982;&#21518;&#21019;&#24314;nginx&#23545;&#36830;&#25509;&#30340;&#23553;&#35013;&#65292;&#21363;ngx_connection_t&#32467;&#26500;&#20307;&#12290;&#25509;&#30528;&#65292;&#35774;&#32622;&#35835;&#20889;&#20107;&#20214;&#22788;&#29702;&#20989;&#25968;&#24182;&#28155;&#21152;&#35835;&#20889;&#20107;&#20214;&#26469;&#19982;&#23458;&#25143;&#31471;&#36827;&#34892;&#25968;&#25454;&#30340;&#20132;&#25442;&#12290;&#26368;&#21518;&#65292;nginx&#25110;&#23458;&#25143;&#31471;&#26469;&#20027;&#21160;&#20851;&#25481;&#36830;&#25509;&#65292;&#21040;&#27492;&#65292;&#19968;&#20010;&#36830;&#25509;&#23601;&#23551;&#32456;&#27491;&#23517;&#20102;&#12290;&#10;&#10;&#24403;&#28982;&#65292;nginx&#20063;&#26159;&#21487;&#20197;&#20316;&#20026;&#23458;&#25143;&#31471;&#26469;&#35831;&#27714;&#20854;&#23427;server&#30340;&#25968;&#25454;&#30340;&#65288;&#22914;upstream&#27169;&#22359;&#65289;&#65292;&#27492;&#26102;&#65292;&#19982;&#20854;&#23427;server&#21019;&#24314;&#30340;&#36830;&#25509;&#65292;&#20063;&#23553;&#35013;&#22312;ngx_connection_t&#20013;&#12290;&#20316;&#20026;&#23458;&#25143;&#31471;&#65292;nginx&#20808;&#33719;&#21462;&#19968;&#20010;ngx_connection_t&#32467;&#26500;&#20307;&#65292;&#28982;&#21518;&#21019;&#24314;socket&#65292;&#24182;&#35774;&#32622;socket&#30340;&#23646;&#24615;&#65288; &#27604;&#22914;&#38750;&#38459;&#22622;&#65289;&#12290;&#28982;&#21518;&#20877;&#36890;&#36807;&#28155;&#21152;&#35835;&#20889;&#20107;&#20214;&#65292;&#35843;&#29992;connect/read/write&#26469;&#35843;&#29992;&#36830;&#25509;&#65292;&#26368;&#21518;&#20851;&#25481;&#36830;&#25509;&#65292;&#24182;&#37322;&#25918;ngx_connection_t&#12290;&#10;&#10;&#22312;nginx&#20013;&#65292;&#27599;&#20010;&#36827;&#31243;&#20250;&#26377;&#19968;&#20010;&#36830;&#25509;&#25968;&#30340;&#26368;&#22823;&#19978;&#38480;&#65292;&#36825;&#20010;&#19978;&#38480;&#19982;&#31995;&#32479;&#23545;fd&#30340;&#38480;&#21046;&#19981;&#19968;&#26679;&#12290;&#22312;&#25805;&#20316;&#31995;&#32479;&#20013;&#65292;&#36890;&#36807;ulimit -n&#65292;&#25105;&#20204;&#21487;&#20197;&#24471;&#21040;&#19968;&#20010;&#36827;&#31243;&#25152;&#33021;&#22815;&#25171;&#24320;&#30340;fd&#30340;&#26368;&#22823;&#25968;&#65292;&#21363;nofile&#65292;&#22240;&#20026;&#27599;&#20010;socket&#36830;&#25509;&#20250;&#21344;&#29992;&#25481;&#19968;&#20010;fd&#65292;&#25152;&#20197;&#36825;&#20063;&#20250;&#38480;&#21046;&#25105;&#20204;&#36827;&#31243;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#65292;&#24403;&#28982;&#20063;&#20250;&#30452;&#25509;&#24433;&#21709;&#21040;&#25105;&#20204;&#31243;&#24207;&#25152;&#33021;&#25903;&#25345;&#30340;&#26368;&#22823;&#24182;&#21457;&#25968;&#65292;&#24403;fd&#29992;&#23436;&#21518;&#65292;&#20877;&#21019;&#24314;socket&#26102;&#65292;&#23601;&#20250;&#22833;&#36133;&#12290;nginx&#36890;&#36807;&#35774;&#32622;worker_connectons&#26469;&#35774;&#32622;&#27599;&#20010;&#36827;&#31243;&#25903;&#25345;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#12290;&#22914;&#26524;&#35813;&#20540;&#22823;&#20110;nofile&#65292;&#37027;&#20040;&#23454;&#38469;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#26159;nofile&#65292;nginx&#20250;&#26377;&#35686;&#21578;&#12290;nginx&#22312;&#23454;&#29616;&#26102;&#65292;&#26159;&#36890;&#36807;&#19968;&#20010;&#36830;&#25509;&#27744;&#26469;&#31649;&#29702;&#30340;&#65292;&#27599;&#20010;worker&#36827;&#31243;&#37117;&#26377;&#19968;&#20010;&#29420;&#31435;&#30340;&#36830;&#25509;&#27744;&#65292;&#36830;&#25509;&#27744;&#30340;&#22823;&#23567;&#26159;worker_connections&#12290;&#36825;&#37324;&#30340;&#36830;&#25509;&#27744;&#37324;&#38754;&#20445;&#23384;&#30340;&#20854;&#23454;&#19981;&#26159;&#30495;&#23454;&#30340;&#36830;&#25509;&#65292;&#23427;&#21482;&#26159;&#19968;&#20010;worker_connections&#22823;&#23567;&#30340;&#19968;&#20010;ngx_connection_t&#32467;&#26500;&#30340;&#25968;&#32452;&#12290;&#24182;&#19988;&#65292;nginx&#20250;&#36890;&#36807;&#19968;&#20010;&#38142;&#34920;free_connections&#26469;&#20445;&#23384;&#25152;&#26377;&#30340;&#31354;&#38386;ngx_connection_t&#65292;&#27599;&#27425;&#33719;&#21462;&#19968;&#20010;&#36830;&#25509;&#26102;&#65292;&#23601;&#20174;&#31354;&#38386;&#36830;&#25509;&#38142;&#34920;&#20013;&#33719;&#21462;&#19968;&#20010;&#65292;&#29992;&#23436;&#21518;&#65292;&#20877;&#25918;&#22238;&#31354;&#38386;&#36830;&#25509;&#38142;&#34920;&#37324;&#38754;&#12290;&#10;&#10;&#22312;&#36825;&#37324;&#65292;&#24456;&#22810;&#20154;&#20250;&#35823;&#35299;worker_connections&#36825;&#20010;&#21442;&#25968;&#30340;&#24847;&#24605;&#65292;&#35748;&#20026;&#36825;&#20010;&#20540;&#23601;&#26159;nginx&#25152;&#33021;&#24314;&#31435;&#36830;&#25509;&#30340;&#26368;&#22823;&#20540;&#12290;&#20854;&#23454;&#19981;&#28982;&#65292;&#36825;&#20010;&#20540;&#26159;&#34920;&#31034;&#27599;&#20010;worker&#36827;&#31243;&#25152;&#33021;&#24314;&#31435;&#36830;&#25509;&#30340;&#26368;&#22823;&#20540;&#65292;&#25152;&#20197;&#65292;&#19968;&#20010;nginx&#33021;&#24314;&#31435;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#65292;&#24212;&#35813;&#26159;worker_connections * worker_processes&#12290;&#24403;&#28982;&#65292;&#36825;&#37324;&#35828;&#30340;&#26159;&#26368;&#22823;&#36830;&#25509;&#25968;&#65292;&#23545;&#20110;HTTP&#35831;&#27714;&#26412;&#22320;&#36164;&#28304;&#26469;&#35828;&#65292;&#33021;&#22815;&#25903;&#25345;&#30340;&#26368;&#22823;&#24182;&#21457;&#25968;&#37327;&#26159;worker_connections * worker_processes&#65292;&#32780;&#22914;&#26524;&#26159;HTTP&#20316;&#20026;&#21453;&#21521;&#20195;&#29702;&#26469;&#35828;&#65292;&#26368;&#22823;&#24182;&#21457;&#25968;&#37327;&#24212;&#35813;&#26159;worker_connections * worker_processes/2&#12290;&#22240;&#20026;&#20316;&#20026;&#21453;&#21521;&#20195;&#29702;&#26381;&#21153;&#22120;&#65292;&#27599;&#20010;&#24182;&#21457;&#20250;&#24314;&#31435;&#19982;&#23458;&#25143;&#31471;&#30340;&#36830;&#25509;&#21644;&#19982;&#21518;&#31471;&#26381;&#21153;&#30340;&#36830;&#25509;&#65292;&#20250;&#21344;&#29992;&#20004;&#20010;&#36830;&#25509;&#12290;&#10;&#10;&#37027;&#20040;&#65292;&#25105;&#20204;&#21069;&#38754;&#26377;&#35828;&#36807;&#19968;&#20010;&#23458;&#25143;&#31471;&#36830;&#25509;&#36807;&#26469;&#21518;&#65292;&#22810;&#20010;&#31354;&#38386;&#30340;&#36827;&#31243;&#65292;&#20250;&#31454;&#20105;&#36825;&#20010;&#36830;&#25509;&#65292;&#24456;&#23481;&#26131;&#30475;&#21040;&#65292;&#36825;&#31181;&#31454;&#20105;&#20250;&#23548;&#33268;&#19981;&#20844;&#24179;&#65292;&#22914;&#26524;&#26576;&#20010;&#36827;&#31243;&#24471;&#21040;accept&#30340;&#26426;&#20250;&#27604;&#36739;&#22810;&#65292;&#23427;&#30340;&#31354;&#38386;&#36830;&#25509;&#24456;&#24555;&#23601;&#29992;&#23436;&#20102;&#65292;&#22914;&#26524;&#19981;&#25552;&#21069;&#20570;&#19968;&#20123;&#25511;&#21046;&#65292;&#24403;accept&#21040;&#19968;&#20010;&#26032;&#30340;tcp&#36830;&#25509;&#21518;&#65292;&#22240;&#20026;&#26080;&#27861;&#24471;&#21040;&#31354;&#38386;&#36830;&#25509;&#65292;&#32780;&#19988;&#26080;&#27861;&#23558;&#27492;&#36830;&#25509;&#36716;&#20132;&#32473;&#20854;&#23427;&#36827;&#31243;&#65292;&#26368;&#32456;&#20250;&#23548;&#33268;&#27492;tcp&#36830;&#25509;&#24471;&#19981;&#21040;&#22788;&#29702;&#65292;&#23601;&#20013;&#27490;&#25481;&#20102;&#12290;&#24456;&#26174;&#28982;&#65292;&#36825;&#26159;&#19981;&#20844;&#24179;&#30340;&#65292;&#26377;&#30340;&#36827;&#31243;&#26377;&#31354;&#20313;&#36830;&#25509;&#65292;&#21364;&#27809;&#26377;&#22788;&#29702;&#26426;&#20250;&#65292;&#26377;&#30340;&#36827;&#31243;&#22240;&#20026;&#27809;&#26377;&#31354;&#20313;&#36830;&#25509;&#65292;&#21364;&#20154;&#20026;&#22320;&#20002;&#24323;&#36830;&#25509;&#12290;&#37027;&#20040;&#65292;&#22914;&#20309;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#21602;&#65311;&#39318;&#20808;&#65292;nginx&#30340;&#22788;&#29702;&#24471;&#20808;&#25171;&#24320;accept_mutex&#36873;&#39033;&#65292;&#27492;&#26102;&#65292;&#21482;&#26377;&#33719;&#24471;&#20102;accept_mutex&#30340;&#36827;&#31243;&#25165;&#20250;&#21435;&#28155;&#21152;accept&#20107;&#20214;&#65292;&#20063;&#23601;&#26159;&#35828;&#65292;nginx&#20250;&#25511;&#21046;&#36827;&#31243;&#26159;&#21542;&#28155;&#21152;accept&#20107;&#20214;&#12290;nginx&#20351;&#29992;&#19968;&#20010;&#21483;ngx_accept_disabled&#30340;&#21464;&#37327;&#26469;&#25511;&#21046;&#26159;&#21542;&#21435;&#31454;&#20105;accept_mutex&#38145;&#12290;&#22312;&#31532;&#19968;&#27573;&#20195;&#30721;&#20013;&#65292;&#35745;&#31639;ngx_accept_disabled&#30340;&#20540;&#65292;&#36825;&#20010;&#20540;&#26159;nginx&#21333;&#36827;&#31243;&#30340;&#25152;&#26377;&#36830;&#25509;&#24635;&#25968;&#30340;&#20843;&#20998;&#20043;&#19968;&#65292;&#20943;&#21435;&#21097;&#19979;&#30340;&#31354;&#38386;&#36830;&#25509;&#25968;&#37327;&#65292;&#24471;&#21040;&#30340;&#36825;&#20010;ngx_accept_disabled&#26377;&#19968;&#20010;&#35268;&#24459;&#65292;&#24403;&#21097;&#20313;&#36830;&#25509;&#25968;&#23567;&#20110;&#24635;&#36830;&#25509;&#25968;&#30340;&#20843;&#20998;&#20043;&#19968;&#26102;&#65292;&#20854;&#20540;&#25165;&#22823;&#20110;0&#65292;&#32780;&#19988;&#21097;&#20313;&#30340;&#36830;&#25509;&#25968;&#36234;&#23567;&#65292;&#36825;&#20010;&#20540;&#36234;&#22823;&#12290;&#20877;&#30475;&#31532;&#20108;&#27573;&#20195;&#30721;&#65292;&#24403;ngx_accept_disabled&#22823;&#20110;0&#26102;&#65292;&#19981;&#20250;&#21435;&#23581;&#35797;&#33719;&#21462;accept_mutex&#38145;&#65292;&#24182;&#19988;&#23558;ngx_accept_disabled&#20943;1&#65292;&#20110;&#26159;&#65292;&#27599;&#27425;&#25191;&#34892;&#21040;&#27492;&#22788;&#26102;&#65292;&#37117;&#20250;&#21435;&#20943;1&#65292;&#30452;&#21040;&#23567;&#20110;0&#12290;&#19981;&#21435;&#33719;&#21462;accept_mutex&#38145;&#65292;&#23601;&#26159;&#31561;&#20110;&#35753;&#20986;&#33719;&#21462;&#36830;&#25509;&#30340;&#26426;&#20250;&#65292;&#24456;&#26174;&#28982;&#21487;&#20197;&#30475;&#20986;&#65292;&#24403;&#31354;&#20313;&#36830;&#25509;&#36234;&#23569;&#26102;&#65292;ngx_accept_disable&#36234;&#22823;&#65292;&#20110;&#26159;&#35753;&#20986;&#30340;&#26426;&#20250;&#23601;&#36234;&#22810;&#65292;&#36825;&#26679;&#20854;&#23427;&#36827;&#31243;&#33719;&#21462;&#38145;&#30340;&#26426;&#20250;&#20063;&#23601;&#36234;&#22823;&#12290;&#19981;&#21435;accept&#65292;&#33258;&#24049;&#30340;&#36830;&#25509;&#23601;&#25511;&#21046;&#19979;&#26469;&#20102;&#65292;&#20854;&#23427;&#36827;&#31243;&#30340;&#36830;&#25509;&#27744;&#23601;&#20250;&#24471;&#21040;&#21033;&#29992;&#65292;&#36825;&#26679;&#65292;nginx&#23601;&#25511;&#21046;&#20102;&#22810;&#36827;&#31243;&#38388;&#36830;&#25509;&#30340;&#24179;&#34913;&#20102;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_accept_disabled = ngx_cycle-&#62;connection_n / 8&#10;        - ngx_cycle-&#62;free_connection_n;&#10;&#10;    if (ngx_accept_disabled &#62; 0) &#123;&#10;        ngx_accept_disabled--;&#10;&#10;    &#125; else &#123;&#10;        if (ngx_trylock_accept_mutex(cycle) == NGX_ERROR) &#123;&#10;            return;&#10;        &#125;&#10;&#10;        if (ngx_accept_mutex_held) &#123;&#10;            flags |= NGX_POST_EVENTS;&#10;&#10;        &#125; else &#123;&#10;            if (timer == NGX_TIMER_INFINITE&#10;                    || timer &#62; ngx_accept_mutex_delay)&#10;            &#123;&#10;                timer = ngx_accept_mutex_delay;&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;&#10;&#22909;&#20102;&#65292;&#36830;&#25509;&#23601;&#20808;&#20171;&#32461;&#21040;&#36825;&#65292;&#26412;&#31456;&#30340;&#30446;&#30340;&#26159;&#20171;&#32461;&#22522;&#26412;&#27010;&#24565;&#65292;&#30693;&#36947;&#22312;nginx&#20013;&#36830;&#25509;&#26159;&#20010;&#20160;&#20040;&#19996;&#35199;&#23601;&#34892;&#20102;&#65292;&#32780;&#19988;&#36830;&#25509;&#26159;&#23646;&#20110;&#27604;&#36739;&#39640;&#32423;&#30340;&#29992;&#27861;&#65292;&#22312;&#21518;&#38754;&#30340;&#27169;&#22359;&#24320;&#21457;&#39640;&#32423;&#31687;&#20250;&#26377;&#19987;&#38376;&#30340;&#31456;&#33410;&#26469;&#35762;&#35299;&#36830;&#25509;&#19982;&#20107;&#20214;&#30340;&#23454;&#29616;&#21450;&#20351;&#29992;&#12290;&#10;&#10;&#10;&#10;request</span><br></pre></td></tr></table></figure></p>
<p>这节我们讲request，在nginx中我们指的是http请求，具体到nginx中的数据结构是ngx_http_request_t。ngx_http_request_t是对一个http请求的封装。 我们知道，一个http请求，包含请求行、请求头、请求体、响应行、响应头、响应体。</p>
<p>http请求是典型的请求-响应类型的的网络协议，而http是文件协议，所以我们在分析请求行与请求头，以及输出响应行与响应头，往往是一行一行的进行处理。如果我们自己来写一个http服务器，通常在一个连接建立好后，客户端会发送请求过来。然后我们读取一行数据，分析出请求行中包含的method、uri、http_version信息。然后再一行一行处理请求头，并根据请求method与请求头的信息来决定是否有请求体以及请求体的长度，然后再去读取请求体。得到请求后，我们处理请求产生需要输出的数据，然后再生成响应行，响应头以及响应体。在将响应发送给客户端之后，一个完整的请求就处理完了。当然这是最简单的webserver的处理方式，其实nginx也是这样做的，只是有一些小小的区别，比如，当请求头读取完成后，就开始进行请求的处理了。nginx通过ngx_http_request_t来保存解析请求与输出响应相关的数据。</p>
<p>那接下来，简要讲讲nginx是如何处理一个完整的请求的。对于nginx来说，一个请求是从ngx_http_init_request开始的，在这个函数中，会设置读事件为ngx_http_process_request_line，也就是说，接下来的网络事件，会由ngx_http_process_request_line来执行。从ngx_http_process_request_line的函数名，我们可以看到，这就是来处理请求行的，正好与之前讲的，处理请求的第一件事就是处理请求行是一致的。通过ngx_http_read_request_header来读取请求数据。然后调用ngx_http_parse_request_line函数来解析请求行。nginx为提高效率，采用状态机来解析请求行，而且在进行method的比较时，没有直接使用字符串比较，而是将四个字符转换成一个整型，然后一次比较以减少cpu的指令数，这个前面有说过。很多人可能很清楚一个请求行包含请求的方法，uri，版本，却不知道其实在请求行中，也是可以包含有host的。比如一个请求GET    <a href="http://www.taobao.com/uri" target="_blank" rel="external">http://www.taobao.com/uri</a> HTTP/1.0这样一个请求行也是合法的，而且host是www.taobao.com，这个时候，nginx会忽略请求头中的host域，而以请求行中的这个为准来查找虚拟主机。另外，对于对于http0.9版来说，是不支持请求头的，所以这里也是要特别的处理。所以，在后面解析请求头时，协议版本都是1.0或1.1。整个请求行解析到的参数，会保存到ngx_http_request_t结构当中。</p>
<p>在解析完请求行后，nginx会设置读事件的handler为ngx_http_process_request_headers，然后后续的请求就在ngx_http_process_request_headers中进行读取与解析。ngx_http_process_request_headers函数用来读取请求头，跟请求行一样，还是调用ngx_http_read_request_header来读取请求头，调用ngx_http_parse_header_line来解析一行请求头，解析到的请求头会保存到ngx_http_request_t的域headers_in中，headers_in是一个链表结构，保存所有的请求头。而HTTP中有些请求是需要特别处理的，这些请求头与请求处理函数存放在一个映射表里面，即ngx_http_headers_in，在初始化时，会生成一个hash表，当每解析到一个请求头后，就会先在这个hash表中查找，如果有找到，则调用相应的处理函数来处理这个请求头。比如:Host头的处理函数是ngx_http_process_host。</p>
<p>当nginx解析到两个回车换行符时，就表示请求头的结束，此时就会调用ngx_http_process_request来处理请求了。ngx_http_process_request会设置当前的连接的读写事件处理函数为ngx_http_request_handler，然后再调用ngx_http_handler来真正开始处理一个完整的http请求。这里可能比较奇怪，读写事件处理函数都是ngx_http_request_handler，其实在这个函数中，会根据当前事件是读事件还是写事件，分别调用ngx_http_request_t中的read_event_handler或者是write_event_handler。由于此时，我们的请求头已经读取完成了，之前有说过，nginx的做法是先不读取请求body，所以这里面我们设置read_event_handler为ngx_http_block_reading，即不读取数据了。刚才说到，真正开始处理数据，是在ngx_http_handler这个函数里面，这个函数会设置write_event_handler为ngx_http_core_run_phases，并执行ngx_http_core_run_phases函数。ngx_http_core_run_phases这个函数将执行多阶段请求处理，nginx将一个http请求的处理分为多个阶段，那么这个函数就是执行这些阶段来产生数据。因为ngx_http_core_run_phases最后会产生数据，所以我们就很容易理解，为什么设置写事件的处理函数为ngx_http_core_run_phases了。在这里，我简要说明了一下函数的调用逻辑，我们需要明白最终是调用ngx_http_core_run_phases来处理请求，产生的响应头会放在ngx_http_request_t的headers_out中，这一部分内容，我会放在请求处理流程里面去讲。nginx的各种阶段会对请求进行处理，最后会调用filter来过滤数据，对数据进行加工，如truncked传输、gzip压缩等。这里的filter包括header filter与body filter，即对响应头或响应体进行处理。filter是一个链表结构，分别有header filter与body filter，先执行header filter中的所有filter，然后再执行body filter中的所有filter。在header filter中的最后一个filter，即ngx_http_header_filter，这个filter将会遍历所有的响应头，最后需要输出的响应头在一个连续的内存，然后调用ngx_http_write_filter进行输出。ngx_http_write_filter是body filter中的最后一个，所以nginx首先的body信息，在经过一系列的body filter之后，最后也会调用ngx_http_write_filter来进行输出(有图来说明)。</p>
<p>这里要注意的是，nginx会将整个请求头都放在一个buffer里面，这个buffer的大小通过配置项client_header_buffer_size来设置，如果用户的请求头太大，这个buffer装不下，那nginx就会重新分配一个新的更大的buffer来装请求头，这个大buffer可以通过large_client_header_buffers来设置，这个large_buffer这一组buffer，比如配置4 8k，就是表示有四个8k大小的buffer可以用。注意，为了保存请求行或请求头的完整性，一个完整的请求行或请求头，需要放在一个连续的内存里面，所以，一个完整的请求行或请求头，只会保存在一个buffer里面。这样，如果请求行大于一个buffer的大小，就会返回414错误，如果一个请求头大小大于一个buffer大小，就会返回400错误。在了解了这些参数的值，以及nginx实际的做法之后，在应用场景，我们就需要根据实际的需求来调整这些参数，来优化我们的程序了。</p>
<p>处理流程图：</p>
<p>.. image:: <a href="http://tengine.taobao.org/book/_images/chapter-2-2.PNG" target="_blank" rel="external">http://tengine.taobao.org/book/_images/chapter-2-2.PNG</a><br>    :alt: 请求处理流程<br>    :align: center</p>
<p>以上这些，就是nginx中一个http请求的生命周期了。我们再看看与请求相关的一些概念吧。</p>
<p>keepalive<br>^^^^^^^^^^^^^^^^^<br>当然，在nginx中，对于http1.0与http1.1也是支持长连接的。什么是长连接呢？我们知道，http请求是基于TCP协议之上的，那么，当客户端在发起请求前，需要先与服务端建立TCP连接，而每一次的TCP连接是需要三次握手来确定的，如果客户端与服务端之间网络差一点，这三次交互消费的时间会比较多，而且三次交互也会带来网络流量。当然，当连接断开后，也会有四次的交互，当然对用户体验来说就不重要了。而http请求是请求应答式的，如果我们能知道每个请求头与响应体的长度，那么我们是可以在一个连接上面执行多个请求的，这就是所谓的长连接，但前提条件是我们先得确定请求头与响应体的长度。对于请求来说，如果当前请求需要有body，如POST请求，那么nginx就需要客户端在请求头中指定content-length来表明body的大小，否则返回400错误。也就是说，请求体的长度是确定的，那么响应体的长度呢？先来看看http协议中关于响应body长度的确定：</p>
<ol>
<li><p>对于http1.0协议来说，如果响应头中有content-length头，则以content-length的长度就可以知道body的长度了，客户端在接收body时，就可以依照这个长度来接收数据，接收完后，就表示这个请求完成了。而如果没有content-length头，则客户端会一直接收数据，直到服务端主动断开连接，才表示body接收完了。</p>
</li>
<li><p>而对于http1.1协议来说，如果响应头中的Transfer-encoding为chunked传输，则表示body是流式输出，body会被分成多个块，每块的开始会标识出当前块的长度，此时，body不需要通过长度来指定。如果是非chunked传输，而且有content-length，则按照content-length来接收数据。否则，如果是非chunked，并且没有content-length，则客户端接收数据，直到服务端主动断开连接。</p>
</li>
</ol>
<p>从上面，我们可以看到，除了http1.0不带content-length以及http1.1非chunked不带content-length外，body的长度是可知的。此时，当服务端在输出完body之后，会可以考虑使用长连接。能否使用长连接，也是有条件限制的。如果客户端的请求头中的connection为close，则表示客户端需要关掉长连接，如果为keep-alive，则客户端需要打开长连接，如果客户端的请求中没有connection这个头，那么根据协议，如果是http1.0，则默认为close，如果是http1.1，则默认为keep-alive。如果结果为keepalive，那么，nginx在输出完响应体后，会设置当前连接的keepalive属性，然后等待客户端下一次请求。当然，nginx不可能一直等待下去，如果客户端一直不发数据过来，岂不是一直占用这个连接？所以当nginx设置了keepalive等待下一次的请求时，同时也会设置一个最大等待时间，这个时间是通过选项keepalive_timeout来配置的，如果配置为0，则表示关掉keepalive，此时，http版本无论是1.1还是1.0，客户端的connection不管是close还是keepalive，都会强制为close。</p>
<p>如果服务端最后的决定是keepalive打开，那么在响应的http头里面，也会包含有connection头域，其值是”Keep-Alive”，否则就是”Close”。如果connection值为close，那么在nginx响应完数据后，会主动关掉连接。所以，对于请求量比较大的nginx来说，关掉keepalive最后会产生比较多的time-wait状态的socket。一般来说，当客户端的一次访问，需要多次访问同一个server时，打开keepalive的优势非常大，比如图片服务器，通常一个网页会包含很多个图片。打开keepalive也会大量减少time-wait的数量。</p>
<p>pipe<br>^^^^^^^^^^^^^^^^^<br>在http1.1中，引入了一种新的特性，即pipeline。那么什么是pipeline呢？pipeline其实就是流水线作业，它可以看作为keepalive的一种升华，因为pipeline也是基于长连接的，目的就是利用一个连接做多次请求。如果客户端要提交多个请求，对于keepalive来说，那么第二个请求，必须要等到第一个请求的响应接收完全后，才能发起，这和TCP的停止等待协议是一样的，得到两个响应的时间至少为2<em>RTT。而对pipeline来说，客户端不必等到第一个请求处理完后，就可以马上发起第二个请求。得到两个响应的时间可能能够达到1</em>RTT。nginx是直接支持pipeline的，但是，nginx对pipeline中的多个请求的处理却不是并行的，依然是一个请求接一个请求的处理，只是在处理第一个请求的时候，客户端就可以发起第二个请求。这样，nginx利用pipeline减少了处理完一个请求后，等待第二个请求的请求头数据的时间。其实nginx的做法很简单，前面说到，nginx在读取数据时，会将读取的数据放到一个buffer里面，所以，如果nginx在处理完前一个请求后，如果发现buffer里面还有数据，就认为剩下的数据是下一个请求的开始，然后就接下来处理下一个请求，否则就设置keepalive。</p>
<p>lingering_close<br>^^^^^^^^^^^^^^^^^<br>lingering_close，字面意思就是延迟关闭，也就是说，当nginx要关闭连接时，并非立即关闭连接，而是先关闭tcp连接的写，再等待一段时间后再关掉连接的读。为什么要这样呢？我们先来看看这样一个场景。nginx在接收客户端的请求时，可能由于客户端或服务端出错了，要立即响应错误信息给客户端，而nginx在响应错误信息后，大分部情况下是需要关闭当前连接。nginx执行完write()系统调用把错误信息发送给客户端，write()系统调用返回成功并不表示数据已经发送到客户端，有可能还在tcp连接的write buffer里。接着如果直接执行close()系统调用关闭tcp连接，内核会首先检查tcp的read buffer里有没有客户端发送过来的数据留在内核态没有被用户态进程读取，如果有则发送给客户端RST报文来关闭tcp连接丢弃write buffer里的数据，如果没有则等待write buffer里的数据发送完毕，然后再经过正常的4次分手报文断开连接。所以,当在某些场景下出现tcp write buffer里的数据在write()系统调用之后到close()系统调用执行之前没有发送完毕，且tcp read buffer里面还有数据没有读，close()系统调用会导致客户端收到RST报文且不会拿到服务端发送过来的错误信息数据。那客户端肯定会想，这服务器好霸道，动不动就reset我的连接，连个错误信息都没有。</p>
<p>在上面这个场景中，我们可以看到，关键点是服务端给客户端发送了RST包，导致自己发送的数据在客户端忽略掉了。所以，解决问题的重点是，让服务端别发RST包。再想想，我们发送RST是因为我们关掉了连接，关掉连接是因为我们不想再处理此连接了，也不会有任何数据产生了。对于全双工的TCP连接来说，我们只需要关掉写就行了，读可以继续进行，我们只需要丢掉读到的任何数据就行了，这样的话，当我们关掉连接后，客户端再发过来的数据，就不会再收到RST了。当然最终我们还是需要关掉这个读端的，所以我们会设置一个超时时间，在这个时间过后，就关掉读，客户端再发送数据来就不管了，作为服务端我会认为，都这么长时间了，发给你的错误信息也应该读到了，再慢就不关我事了，要怪就怪你RP不好了。当然，正常的客户端，在读取到数据后，会关掉连接，此时服务端就会在超时时间内关掉读端。这些正是lingering_close所做的事情。协议栈提供 SO_LINGER 这个选项，它的一种配置情况就是来处理lingering_close的情况的，不过nginx是自己实现的lingering_close。lingering_close存在的意义就是来读取剩下的客户端发来的数据，所以nginx会有一个读超时时间，通过lingering_timeout选项来设置，如果在lingering_timeout时间内还没有收到数据，则直接关掉连接。nginx还支持设置一个总的读取时间，通过lingering_time来设置，这个时间也就是nginx在关闭写之后，保留socket的时间，客户端需要在这个时间内发送完所有的数据，否则nginx在这个时间过后，会直接关掉连接。当然，nginx是支持配置是否打开lingering_close选项的，通过lingering_close选项来配置。<br>那么，我们在实际应用中，是否应该打开lingering_close呢？这个就没有固定的推荐值了，如Maxim Dounin所说，lingering_close的主要作用是保持更好的客户端兼容性，但是却需要消耗更多的额外资源（比如连接会一直占着）。</p>
<p>这节，我们介绍了nginx中，连接与请求的基本概念，下节，我们讲基本的数据结构。</p>
<h2 id="基本数据结构(99%)">基本数据结构(99%)</h2><p>nginx的作者为追求极致的高效，自己实现了很多颇具特色的nginx风格的数据结构以及公共函数。比如，nginx提供了带长度的字符串，根据编译器选项优化过的字符串拷贝函数ngx_copy等。所以，在我们写nginx模块时，应该尽量调用nginx提供的api，尽管有些api只是对glibc的宏定义。本节，我们介绍string、list、buffer、chain等一系列最基本的数据结构及相关api的使用技巧以及注意事项。</p>
<p>ngx_str_t(100%)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#22312;nginx&#28304;&#30721;&#30446;&#24405;&#30340;src/core&#19979;&#38754;&#30340;ngx_string.h|c&#37324;&#38754;&#65292;&#21253;&#21547;&#20102;&#23383;&#31526;&#20018;&#30340;&#23553;&#35013;&#20197;&#21450;&#23383;&#31526;&#20018;&#30456;&#20851;&#25805;&#20316;&#30340;api&#12290;nginx&#25552;&#20379;&#20102;&#19968;&#20010;&#24102;&#38271;&#24230;&#30340;&#23383;&#31526;&#20018;&#32467;&#26500;ngx_str_t&#65292;&#23427;&#30340;&#21407;&#22411;&#22914;&#19979;&#65306;&#10;&#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        size_t      len;&#10;        u_char     *data;&#10;    &#125; ngx_str_t;&#10;&#10;&#22312;&#32467;&#26500;&#20307;&#24403;&#20013;&#65292;data&#25351;&#21521;&#23383;&#31526;&#20018;&#25968;&#25454;&#30340;&#31532;&#19968;&#20010;&#23383;&#31526;&#65292;&#23383;&#31526;&#20018;&#30340;&#32467;&#26463;&#29992;&#38271;&#24230;&#26469;&#34920;&#31034;&#65292;&#32780;&#19981;&#26159;&#30001;&#39;\\0&#39;&#26469;&#34920;&#31034;&#32467;&#26463;&#12290;&#25152;&#20197;&#65292;&#22312;&#20889;nginx&#20195;&#30721;&#26102;&#65292;&#22788;&#29702;&#23383;&#31526;&#20018;&#30340;&#26041;&#27861;&#36319;&#25105;&#20204;&#24179;&#26102;&#20351;&#29992;&#26377;&#24456;&#22823;&#30340;&#19981;&#19968;&#26679;&#65292;&#20294;&#35201;&#26102;&#21051;&#35760;&#20303;&#65292;&#23383;&#31526;&#20018;&#19981;&#20197;&#39;\\0&#39;&#32467;&#26463;&#65292;&#23613;&#37327;&#20351;&#29992;nginx&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#25805;&#20316;&#30340;api&#26469;&#25805;&#20316;&#23383;&#31526;&#20018;&#12290;&#10;&#37027;&#20040;&#65292;nginx&#36825;&#26679;&#20570;&#26377;&#20160;&#20040;&#22909;&#22788;&#21602;&#65311;&#39318;&#20808;&#65292;&#36890;&#36807;&#38271;&#24230;&#26469;&#34920;&#31034;&#23383;&#31526;&#20018;&#38271;&#24230;&#65292;&#20943;&#23569;&#35745;&#31639;&#23383;&#31526;&#20018;&#38271;&#24230;&#30340;&#27425;&#25968;&#12290;&#20854;&#27425;&#65292;nginx&#21487;&#20197;&#37325;&#22797;&#24341;&#29992;&#19968;&#27573;&#23383;&#31526;&#20018;&#20869;&#23384;&#65292;data&#21487;&#20197;&#25351;&#21521;&#20219;&#24847;&#20869;&#23384;&#65292;&#38271;&#24230;&#34920;&#31034;&#32467;&#26463;&#65292;&#32780;&#19981;&#29992;&#21435;copy&#19968;&#20221;&#33258;&#24049;&#30340;&#23383;&#31526;&#20018;(&#22240;&#20026;&#22914;&#26524;&#35201;&#20197;&#39;\\0&#39;&#32467;&#26463;&#65292;&#32780;&#19981;&#33021;&#26356;&#25913;&#21407;&#23383;&#31526;&#20018;&#65292;&#25152;&#20197;&#21183;&#24517;&#35201;copy&#19968;&#27573;&#23383;&#31526;&#20018;)&#12290;&#25105;&#20204;&#22312;ngx_http_request_t&#32467;&#26500;&#20307;&#30340;&#25104;&#21592;&#20013;&#65292;&#21487;&#20197;&#25214;&#21040;&#24456;&#22810;&#23383;&#31526;&#20018;&#24341;&#29992;&#19968;&#27573;&#20869;&#23384;&#30340;&#20363;&#23376;&#65292;&#27604;&#22914;request_line&#12289;uri&#12289;args&#31561;&#31561;&#65292;&#36825;&#20123;&#23383;&#31526;&#20018;&#30340;data&#37096;&#20998;&#65292;&#37117;&#26159;&#25351;&#21521;&#22312;&#25509;&#25910;&#25968;&#25454;&#26102;&#21019;&#24314;buffer&#25152;&#25351;&#21521;&#30340;&#20869;&#23384;&#20013;&#65292;uri&#65292;args&#23601;&#27809;&#26377;&#24517;&#35201;copy&#19968;&#20221;&#20986;&#26469;&#12290;&#36825;&#26679;&#30340;&#35805;&#65292;&#20943;&#23569;&#20102;&#24456;&#22810;&#19981;&#24517;&#35201;&#30340;&#20869;&#23384;&#20998;&#37197;&#19982;&#25335;&#36125;&#12290;&#10;&#27491;&#26159;&#22522;&#20110;&#27492;&#29305;&#24615;&#65292;&#22312;nginx&#20013;&#65292;&#24517;&#39035;&#35880;&#24910;&#30340;&#21435;&#20462;&#25913;&#19968;&#20010;&#23383;&#31526;&#20018;&#12290;&#22312;&#20462;&#25913;&#23383;&#31526;&#20018;&#26102;&#38656;&#35201;&#35748;&#30495;&#30340;&#21435;&#32771;&#34385;&#65306;&#26159;&#21542;&#21487;&#20197;&#20462;&#25913;&#35813;&#23383;&#31526;&#20018;&#65307;&#23383;&#31526;&#20018;&#20462;&#25913;&#21518;&#65292;&#26159;&#21542;&#20250;&#23545;&#20854;&#23427;&#30340;&#24341;&#29992;&#36896;&#25104;&#24433;&#21709;&#12290;&#22312;&#21518;&#38754;&#20171;&#32461;ngx_unescape_uri&#20989;&#25968;&#30340;&#26102;&#20505;&#65292;&#23601;&#20250;&#30475;&#21040;&#36825;&#19968;&#28857;&#12290;&#20294;&#26159;&#65292;&#20351;&#29992;nginx&#30340;&#23383;&#31526;&#20018;&#20250;&#20135;&#29983;&#19968;&#20123;&#38382;&#39064;&#65292;glibc&#25552;&#20379;&#30340;&#24456;&#22810;&#31995;&#32479;api&#20989;&#25968;&#22823;&#22810;&#26159;&#36890;&#36807;&#39;\\0&#39;&#26469;&#34920;&#31034;&#23383;&#31526;&#20018;&#30340;&#32467;&#26463;&#65292;&#25152;&#20197;&#25105;&#20204;&#22312;&#35843;&#29992;&#31995;&#32479;api&#26102;&#65292;&#23601;&#19981;&#33021;&#30452;&#25509;&#20256;&#20837;str-&#62;data&#20102;&#12290;&#27492;&#26102;&#65292;&#36890;&#24120;&#30340;&#20570;&#27861;&#26159;&#21019;&#24314;&#19968;&#27573;str-&#62;len + 1&#22823;&#23567;&#30340;&#20869;&#23384;&#65292;&#28982;&#21518;copy&#23383;&#31526;&#20018;&#65292;&#26368;&#21518;&#19968;&#20010;&#23383;&#33410;&#32622;&#20026;&#39;\\0&#39;&#12290;&#27604;&#36739;hack&#30340;&#20570;&#27861;&#26159;&#65292;&#23558;&#23383;&#31526;&#20018;&#26368;&#21518;&#19968;&#20010;&#23383;&#31526;&#30340;&#21518;&#19968;&#20010;&#23383;&#31526;backup&#19968;&#20010;&#65292;&#28982;&#21518;&#35774;&#32622;&#20026;&#39;\\0&#39;&#65292;&#22312;&#20570;&#23436;&#35843;&#29992;&#21518;&#65292;&#20877;&#30001;backup&#25913;&#22238;&#26469;&#65292;&#20294;&#21069;&#25552;&#26465;&#20214;&#26159;&#65292;&#20320;&#24471;&#30830;&#23450;&#36825;&#20010;&#23383;&#31526;&#26159;&#21487;&#20197;&#20462;&#25913;&#30340;&#65292;&#32780;&#19988;&#26159;&#26377;&#20869;&#23384;&#20998;&#37197;&#65292;&#19981;&#20250;&#36234;&#30028;&#65292;&#20294;&#19968;&#33324;&#19981;&#24314;&#35758;&#36825;&#20040;&#20570;&#12290;&#10;&#25509;&#19979;&#26469;&#65292;&#30475;&#30475;nginx&#25552;&#20379;&#30340;&#25805;&#20316;&#23383;&#31526;&#20018;&#30456;&#20851;&#30340;api&#12290;&#10;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_string(str)     &#123; sizeof(str) - 1, (u_char *) str &#125;&#10;&#10;ngx_string(str)&#26159;&#19968;&#20010;&#23439;&#65292;&#23427;&#36890;&#36807;&#19968;&#20010;&#20197;&#39;\\0&#39;&#32467;&#23614;&#30340;&#26222;&#36890;&#23383;&#31526;&#20018;str&#26500;&#36896;&#19968;&#20010;nginx&#30340;&#23383;&#31526;&#20018;&#65292;&#37492;&#20110;&#20854;&#20013;&#37319;&#29992;sizeof&#25805;&#20316;&#31526;&#35745;&#31639;&#23383;&#31526;&#20018;&#38271;&#24230;&#65292;&#22240;&#27492;&#21442;&#25968;&#24517;&#39035;&#26159;&#19968;&#20010;&#24120;&#37327;&#23383;&#31526;&#20018;&#12290;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_null_string     &#123; 0, NULL &#125;&#10;&#10;&#23450;&#20041;&#21464;&#37327;&#26102;&#65292;&#20351;&#29992;ngx_null_string&#21021;&#22987;&#21270;&#23383;&#31526;&#20018;&#20026;&#31354;&#23383;&#31526;&#20018;&#65292;&#31526;&#20018;&#30340;&#38271;&#24230;&#20026;0&#65292;data&#20026;NULL&#12290;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_str_set(str, text)                                               \&#10;        (str)-&#62;len = sizeof(text) - 1; (str)-&#62;data = (u_char *) text&#10;&#10;ngx_str_set&#29992;&#20110;&#35774;&#32622;&#23383;&#31526;&#20018;str&#20026;text&#65292;&#30001;&#20110;&#20351;&#29992;sizeof&#35745;&#31639;&#38271;&#24230;&#65292;&#25925;text&#24517;&#39035;&#20026;&#24120;&#37327;&#23383;&#31526;&#20018;&#12290;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_str_null(str)   (str)-&#62;len = 0; (str)-&#62;data = NULL&#10;&#10;ngx_str_null&#29992;&#20110;&#35774;&#32622;&#23383;&#31526;&#20018;str&#20026;&#31354;&#20018;&#65292;&#38271;&#24230;&#20026;0&#65292;data&#20026;NULL&#12290;&#10;&#10;&#19978;&#38754;&#36825;&#22235;&#20010;&#20989;&#25968;&#65292;&#20351;&#29992;&#26102;&#19968;&#23450;&#35201;&#23567;&#24515;&#65292;ngx_string&#19982;ngx_null_string&#26159;&#8220;&#123;*&#65292;*&#125;&#8221;&#26684;&#24335;&#30340;&#65292;&#25925;&#21482;&#33021;&#29992;&#20110;&#36171;&#20540;&#26102;&#21021;&#22987;&#21270;&#65292;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_str_t str = ngx_string(&#34;hello world&#34;);&#10;    ngx_str_t str1 = ngx_null_string;&#10;&#10;&#22914;&#26524;&#21521;&#19979;&#38754;&#36825;&#26679;&#20351;&#29992;&#65292;&#23601;&#20250;&#26377;&#38382;&#39064;&#65292;&#36825;&#37324;&#28041;&#21450;&#21040;c&#35821;&#35328;&#20013;&#23545;&#32467;&#26500;&#20307;&#21464;&#37327;&#36171;&#20540;&#25805;&#20316;&#30340;&#35821;&#27861;&#35268;&#21017;&#65292;&#22312;&#27492;&#19981;&#20570;&#20171;&#32461;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_str_t str, str1;&#10;    str = ngx_string(&#34;hello world&#34;);    // &#32534;&#35793;&#20986;&#38169;&#10;    str1 = ngx_null_string;                // &#32534;&#35793;&#20986;&#38169;&#10;&#10;&#36825;&#31181;&#24773;&#20917;&#65292;&#21487;&#20197;&#35843;&#29992;ngx_str_set&#19982;ngx_str_null&#36825;&#20004;&#20010;&#20989;&#25968;&#26469;&#20570;:&#10;&#10;.. code:: c&#10;&#10;    ngx_str_t str, str1;&#10;    ngx_str_set(&#38;str, &#34;hello world&#34;);    &#10;    ngx_str_null(&#38;str1);&#10;&#10;&#25353;&#29031;C99&#26631;&#20934;&#65292;&#24744;&#20063;&#21487;&#20197;&#36825;&#20040;&#20570;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_str_t str, str1;&#10;    str  = (ngx_str_t) ngx_string(&#34;hello world&#34;);&#10;    str1 = (ngx_str_t) ngx_null_string;&#10;&#10;&#21478;&#22806;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;ngx_string&#19982;ngx_str_set&#22312;&#35843;&#29992;&#26102;&#65292;&#20256;&#36827;&#21435;&#30340;&#23383;&#31526;&#20018;&#19968;&#23450;&#26159;&#24120;&#37327;&#23383;&#31526;&#20018;&#65292;&#21542;&#21017;&#20250;&#24471;&#21040;&#24847;&#24819;&#19981;&#21040;&#30340;&#38169;&#35823;(&#22240;&#20026;ngx_str_set&#20869;&#37096;&#20351;&#29992;&#20102;sizeof()&#65292;&#22914;&#26524;&#20256;&#20837;&#30340;&#26159;u_char*&#65292;&#37027;&#20040;&#35745;&#31639;&#30340;&#26159;&#36825;&#20010;&#25351;&#38024;&#30340;&#38271;&#24230;&#65292;&#32780;&#19981;&#26159;&#23383;&#31526;&#20018;&#30340;&#38271;&#24230;)&#12290;&#22914;&#65306; &#10;&#10;.. code:: c&#10;&#10;   ngx_str_t str;&#10;   u_char *a = &#34;hello world&#34;;&#10;   ngx_str_set(&#38;str, a);    // &#38382;&#39064;&#20135;&#29983;&#10;&#10;&#27492;&#22806;&#65292;&#20540;&#24471;&#27880;&#24847;&#30340;&#26159;&#65292;&#30001;&#20110;ngx_str_set&#19982;ngx_str_null&#23454;&#38469;&#19978;&#26159;&#20004;&#34892;&#35821;&#21477;&#65292;&#25925;&#22312;if/for/while&#31561;&#35821;&#21477;&#20013;&#21333;&#29420;&#20351;&#29992;&#38656;&#35201;&#29992;&#33457;&#25324;&#21495;&#25324;&#36215;&#26469;&#65292;&#20363;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;   ngx_str_t str;&#10;   if (cond)&#10;      ngx_str_set(&#38;str, &#34;true&#34;);     // &#38382;&#39064;&#20135;&#29983;&#10;   else&#10;      ngx_str_set(&#38;str, &#34;false&#34;);    // &#38382;&#39064;&#20135;&#29983;&#10;&#10;&#10;.. code:: c&#10;&#10;   void ngx_strlow(u_char *dst, u_char *src, size_t n);&#10;&#10;&#23558;src&#30340;&#21069;n&#20010;&#23383;&#31526;&#36716;&#25442;&#25104;&#23567;&#20889;&#23384;&#25918;&#22312;dst&#23383;&#31526;&#20018;&#24403;&#20013;&#65292;&#35843;&#29992;&#32773;&#38656;&#35201;&#20445;&#35777;dst&#25351;&#21521;&#30340;&#31354;&#38388;&#22823;&#20110;&#31561;&#20110;n&#65292;&#19988;&#25351;&#21521;&#30340;&#31354;&#38388;&#24517;&#39035;&#21487;&#20889;&#12290;&#25805;&#20316;&#19981;&#20250;&#23545;&#21407;&#23383;&#31526;&#20018;&#20135;&#29983;&#21464;&#21160;&#12290;&#22914;&#35201;&#26356;&#25913;&#21407;&#23383;&#31526;&#20018;&#65292;&#21487;&#20197;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_strlow(str-&#62;data, str-&#62;data, str-&#62;len);&#10;&#10;&#10;.. code:: c&#10;&#10;    ngx_strncmp(s1, s2, n)&#10;&#10;&#21306;&#20998;&#22823;&#23567;&#20889;&#30340;&#23383;&#31526;&#20018;&#27604;&#36739;&#65292;&#21482;&#27604;&#36739;&#21069;n&#20010;&#23383;&#31526;&#12290;&#10;&#10;&#10;.. code:: c&#10;&#10;    ngx_strcmp(s1, s2)&#10;&#10;&#21306;&#20998;&#22823;&#23567;&#20889;&#30340;&#19981;&#24102;&#38271;&#24230;&#30340;&#23383;&#31526;&#20018;&#27604;&#36739;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_int_t ngx_strcasecmp(u_char *s1, u_char *s2);&#10;&#10;&#19981;&#21306;&#20998;&#22823;&#23567;&#20889;&#30340;&#19981;&#24102;&#38271;&#24230;&#30340;&#23383;&#31526;&#20018;&#27604;&#36739;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_int_t ngx_strncasecmp(u_char *s1, u_char *s2, size_t n);&#10;&#10;&#19981;&#21306;&#20998;&#22823;&#23567;&#20889;&#30340;&#24102;&#38271;&#24230;&#30340;&#23383;&#31526;&#20018;&#27604;&#36739;&#65292;&#21482;&#27604;&#36739;&#21069;n&#20010;&#23383;&#31526;&#12290;&#10;&#10;.. code:: c&#10;&#10;    u_char * ngx_cdecl ngx_sprintf(u_char *buf, const char *fmt, ...);&#10;    u_char * ngx_cdecl ngx_snprintf(u_char *buf, size_t max, const char *fmt, ...);&#10;    u_char * ngx_cdecl ngx_slprintf(u_char *buf, u_char *last, const char *fmt, ...);&#10;&#10;&#19978;&#38754;&#36825;&#19977;&#20010;&#20989;&#25968;&#29992;&#20110;&#23383;&#31526;&#20018;&#26684;&#24335;&#21270;&#65292;ngx_snprintf&#30340;&#31532;&#20108;&#20010;&#21442;&#25968;max&#25351;&#26126;buf&#30340;&#31354;&#38388;&#22823;&#23567;&#65292;ngx_slprintf&#21017;&#36890;&#36807;last&#26469;&#25351;&#26126;buf&#31354;&#38388;&#30340;&#22823;&#23567;&#12290;&#25512;&#33616;&#20351;&#29992;&#31532;&#20108;&#20010;&#25110;&#31532;&#19977;&#20010;&#20989;&#25968;&#26469;&#26684;&#24335;&#21270;&#23383;&#31526;&#20018;&#65292;ngx_sprintf&#20989;&#25968;&#36824;&#26159;&#27604;&#36739;&#21361;&#38505;&#30340;&#65292;&#23481;&#26131;&#20135;&#29983;&#32531;&#20914;&#21306;&#28322;&#20986;&#28431;&#27934;&#12290;&#22312;&#36825;&#19968;&#31995;&#21015;&#20989;&#25968;&#20013;&#65292;nginx&#22312;&#20860;&#23481;glibc&#20013;&#26684;&#24335;&#21270;&#23383;&#31526;&#20018;&#30340;&#24418;&#24335;&#20043;&#22806;&#65292;&#36824;&#28155;&#21152;&#20102;&#19968;&#20123;&#26041;&#20415;&#26684;&#24335;&#21270;nginx&#31867;&#22411;&#30340;&#19968;&#20123;&#36716;&#20041;&#23383;&#31526;&#65292;&#27604;&#22914;%V&#29992;&#20110;&#26684;&#24335;&#21270;ngx_str_t&#32467;&#26500;&#12290;&#22312;nginx&#28304;&#25991;&#20214;&#30340;ngx_string.c&#20013;&#26377;&#35828;&#26126;&#65306;&#10;&#10;.. code:: c&#10;&#10;    /*&#10;     * supported formats:&#10;     *    %[0][width][x][X]O        off_t&#10;     *    %[0][width]T              time_t&#10;     *    %[0][width][u][x|X]z      ssize_t/size_t&#10;     *    %[0][width][u][x|X]d      int/u_int&#10;     *    %[0][width][u][x|X]l      long&#10;     *    %[0][width|m][u][x|X]i    ngx_int_t/ngx_uint_t&#10;     *    %[0][width][u][x|X]D      int32_t/uint32_t&#10;     *    %[0][width][u][x|X]L      int64_t/uint64_t&#10;     *    %[0][width|m][u][x|X]A    ngx_atomic_int_t/ngx_atomic_uint_t&#10;     *    %[0][width][.width]f      double, max valid number fits to %18.15f&#10;     *    %P                        ngx_pid_t&#10;     *    %M                        ngx_msec_t&#10;     *    %r                        rlim_t&#10;     *    %p                        void *&#10;     *    %V                        ngx_str_t *&#10;     *    %v                        ngx_variable_value_t *&#10;     *    %s                        null-terminated string&#10;     *    %*s                       length and string&#10;     *    %Z                        &#39;\0&#39;&#10;     *    %N                        &#39;\n&#39;&#10;     *    %c                        char&#10;     *    %%                        %&#10;     *&#10;     *  reserved:&#10;     *    %t                        ptrdiff_t&#10;     *    %S                        null-terminated wchar string&#10;     *    %C                        wchar&#10;     */&#10;&#10;&#36825;&#37324;&#29305;&#21035;&#35201;&#25552;&#37266;&#30340;&#26159;&#65292;&#25105;&#20204;&#26368;&#24120;&#29992;&#20110;&#26684;&#24335;&#21270;ngx_str_t&#32467;&#26500;&#65292;&#20854;&#23545;&#24212;&#30340;&#36716;&#20041;&#31526;&#26159;%V&#65292;&#20256;&#32473;&#20989;&#25968;&#30340;&#19968;&#23450;&#35201;&#26159;&#25351;&#38024;&#31867;&#22411;&#65292;&#21542;&#21017;&#31243;&#24207;&#23601;&#20250;coredump&#25481;&#12290;&#36825;&#20063;&#26159;&#25105;&#20204;&#26368;&#23481;&#26131;&#29359;&#30340;&#38169;&#12290;&#27604;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_str_t str = ngx_string(&#34;hello world&#34;);&#10;    char buffer[1024];&#10;    ngx_snprintf(buffer, 1024, &#34;%V&#34;, &#38;str);    // &#27880;&#24847;&#65292;str&#21462;&#22320;&#22336;&#10;&#10;.. code:: c&#10;&#10;    void ngx_encode_base64(ngx_str_t *dst, ngx_str_t *src);&#10;    ngx_int_t ngx_decode_base64(ngx_str_t *dst, ngx_str_t *src);&#10;&#10;&#36825;&#20004;&#20010;&#20989;&#25968;&#29992;&#20110;&#23545;str&#36827;&#34892;base64&#32534;&#30721;&#19982;&#35299;&#30721;&#65292;&#35843;&#29992;&#21069;&#65292;&#38656;&#35201;&#20445;&#35777;dst&#20013;&#26377;&#36275;&#22815;&#30340;&#31354;&#38388;&#26469;&#23384;&#25918;&#32467;&#26524;&#65292;&#22914;&#26524;&#19981;&#30693;&#36947;&#20855;&#20307;&#22823;&#23567;&#65292;&#21487;&#20808;&#35843;&#29992;ngx_base64_encoded_length&#19982;ngx_base64_decoded_length&#26469;&#39044;&#20272;&#26368;&#22823;&#21344;&#29992;&#31354;&#38388;&#12290;&#10;&#10;.. code:: c&#10;&#10;    uintptr_t ngx_escape_uri(u_char *dst, u_char *src, size_t size,&#10;        ngx_uint_t type);&#10;&#10;&#23545;src&#36827;&#34892;&#32534;&#30721;&#65292;&#26681;&#25454;type&#26469;&#25353;&#19981;&#21516;&#30340;&#26041;&#24335;&#36827;&#34892;&#32534;&#30721;&#65292;&#22914;&#26524;dst&#20026;NULL&#65292;&#21017;&#36820;&#22238;&#38656;&#35201;&#36716;&#20041;&#30340;&#23383;&#31526;&#30340;&#25968;&#37327;&#65292;&#30001;&#27492;&#21487;&#24471;&#21040;&#38656;&#35201;&#30340;&#31354;&#38388;&#22823;&#23567;&#12290;type&#30340;&#31867;&#22411;&#21487;&#20197;&#26159;&#65306;&#10;&#10;.. code:: c&#10;&#10;    #define NGX_ESCAPE_URI         0&#10;    #define NGX_ESCAPE_ARGS        1&#10;    #define NGX_ESCAPE_HTML        2&#10;    #define NGX_ESCAPE_REFRESH     3&#10;    #define NGX_ESCAPE_MEMCACHED   4&#10;    #define NGX_ESCAPE_MAIL_AUTH   5&#10;&#10;.. code:: c&#10;&#10;    void ngx_unescape_uri(u_char **dst, u_char **src, size_t size, ngx_uint_t type);&#10;&#10;&#23545;src&#36827;&#34892;&#21453;&#32534;&#30721;&#65292;type&#21487;&#20197;&#26159;0&#12289;NGX_UNESCAPE_URI&#12289;NGX_UNESCAPE_REDIRECT&#36825;&#19977;&#20010;&#20540;&#12290;&#22914;&#26524;&#26159;0&#65292;&#21017;&#34920;&#31034;src&#20013;&#30340;&#25152;&#26377;&#23383;&#31526;&#37117;&#35201;&#36827;&#34892;&#36716;&#30721;&#12290;&#22914;&#26524;&#26159;NGX_UNESCAPE_URI&#19982;NGX_UNESCAPE_REDIRECT&#65292;&#21017;&#36935;&#21040;&#39;?&#39;&#21518;&#23601;&#32467;&#26463;&#20102;&#65292;&#21518;&#38754;&#30340;&#23383;&#31526;&#23601;&#19981;&#31649;&#20102;&#12290;&#32780;NGX_UNESCAPE_URI&#19982;NGX_UNESCAPE_REDIRECT&#20043;&#38388;&#30340;&#21306;&#21035;&#26159;NGX_UNESCAPE_URI&#23545;&#20110;&#36935;&#21040;&#30340;&#38656;&#35201;&#36716;&#30721;&#30340;&#23383;&#31526;&#65292;&#37117;&#20250;&#36716;&#30721;&#65292;&#32780;NGX_UNESCAPE_REDIRECT&#21017;&#21482;&#20250;&#23545;&#38750;&#21487;&#35265;&#23383;&#31526;&#36827;&#34892;&#36716;&#30721;&#12290;&#10;&#10;.. code:: c&#10;&#10;    uintptr_t ngx_escape_html(u_char *dst, u_char *src, size_t size);&#10;&#10;&#23545;html&#26631;&#31614;&#36827;&#34892;&#32534;&#30721;&#12290;&#10;&#10;&#24403;&#28982;&#65292;&#25105;&#36825;&#37324;&#21482;&#20171;&#32461;&#20102;&#19968;&#20123;&#24120;&#29992;&#30340;api&#30340;&#20351;&#29992;&#65292;&#22823;&#23478;&#21487;&#20197;&#20808;&#29087;&#24713;&#19968;&#19979;&#65292;&#22312;&#23454;&#38469;&#20351;&#29992;&#36807;&#31243;&#20013;&#65292;&#36935;&#21040;&#19981;&#26126;&#30333;&#30340;&#65292;&#26368;&#24555;&#26368;&#30452;&#25509;&#30340;&#26041;&#27861;&#23601;&#26159;&#21435;&#30475;&#28304;&#30721;&#65292;&#30475;api&#30340;&#23454;&#29616;&#25110;&#30475;nginx&#33258;&#36523;&#35843;&#29992;api&#30340;&#22320;&#26041;&#26159;&#24590;&#20040;&#20570;&#30340;&#65292;&#20195;&#30721;&#23601;&#26159;&#26368;&#22909;&#30340;&#25991;&#26723;&#12290;&#10;&#10;ngx_pool_t(100%)</span><br></pre></td></tr></table></figure></p>
<p>ngx_pool_t是一个非常重要的数据结构，在很多重要的场合都有使用，很多重要的数据结构也都在使用它。那么它究竟是一个什么东西呢？简单的说，它提供了一种机制，帮助管理一系列的资源（如内存，文件等），使得对这些资源的使用和释放统一进行，免除了使用过程中考虑到对各种各样资源的什么时候释放，是否遗漏了释放的担心。</p>
<p>例如对于内存的管理，如果我们需要使用内存，那么总是从一个ngx_pool_t的对象中获取内存，在最终的某个时刻，我们销毁这个ngx_pool_t对象，所有这些内存都被释放了。这样我们就不必要对对这些内存进行malloc和free的操作，不用担心是否某块被malloc出来的内存没有被释放。因为当ngx_pool_t对象被销毁的时候，所有从这个对象中分配出来的内存都会被统一释放掉。</p>
<p>再比如我们要使用一系列的文件，但是我们打开以后，最终需要都关闭，那么我们就把这些文件统一登记到一个ngx_pool_t对象中，当这个ngx_pool_t对象被销毁的时候，所有这些文件都将会被关闭。</p>
<p>从上面举的两个例子中我们可以看出，使用ngx_pool_t这个数据结构的时候，所有的资源的释放都在这个对象被销毁的时刻，统一进行了释放，那么就会带来一个问题，就是这些资源的生存周期（或者说被占用的时间）是跟ngx_pool_t的生存周期基本一致（ngx_pool_t也提供了少量操作可以提前释放资源）。从最高效的角度来说，这并不是最好的。比如，我们需要依次使用A，B，C三个资源，且使用完B的时候，A就不会再被使用了，使用C的时候A和B都不会被使用到。如果不使用ngx_pool_t来管理这三个资源，那我们可能从系统里面申请A，使用A，然后在释放A。接着申请B，使用B，再释放B。最后申请C，使用C，然后释放C。但是当我们使用一个ngx_pool_t对象来管理这三个资源的时候，A，B和C的释放是在最后一起发生的，也就是在使用完C以后。诚然，这在客观上增加了程序在一段时间的资源使用量。但是这也减轻了程序员分别管理三个资源的生命周期的工作。这也就是有所得，必有所失的道理。实际上是一个取舍的问题，要看在具体的情况下，你更在乎的是哪个。</p>
<p>可以看一下在nginx里面一个典型的使用ngx_pool_t的场景，对于nginx处理的每个http request, nginx会生成一个ngx_pool_t对象与这个http request关联，所有处理过程中需要申请的资源都从这个ngx_pool_t对象中获取，当这个http request处理完成以后，所有在处理过程中申请的资源，都将随着这个关联的ngx_pool_t对象的销毁而释放。</p>
<p>ngx_pool_t相关结构及操作被定义在文件src/core/ngx_palloc.h|c中。</p>
<p>.. code:: c </p>
<pre><code>typedef struct ngx_pool_s        ngx_pool_t; 

struct ngx_pool_s {
    ngx_pool_data_t       d;
    size_t                max;
    ngx_pool_t           <span class="keyword">*</span>current;
    ngx_chain_t          <span class="keyword">*</span>chain;
    ngx_pool_large_t     <span class="keyword">*</span>large;
    ngx_pool_cleanup_t   <span class="keyword">*</span>cleanup;
    ngx_log_t            <span class="keyword">*</span>log;
};
</code></pre><p>从ngx_pool_t的一般使用者的角度来说，可不用关注ngx_pool_t结构中各字段作用。所以这里也不会进行详细的解释，当然在说明某些操作函数的使用的时候，如有必要，会进行说明。</p>
<p>下面我们来分别解释下ngx_pool_t的相关操作。</p>
<p>.. code:: c  </p>
<pre><code>ngx_pool_t *ngx_create_pool(size_t size, ngx_<span class="built_in">log</span>_t *<span class="built_in">log</span>);
</code></pre><p>创建一个初始节点大小为size的pool，log为后续在该pool上进行操作时输出日志的对象。 需要说明的是size的选择，size的大小必须小于等于NGX_MAX_ALLOC_FROM_POOL，且必须大于sizeof(ngx_pool_t)。 </p>
<p>选择大于NGX_MAX_ALLOC_FROM_POOL的值会造成浪费，因为大于该限制的空间不会被用到（只是说在第一个由ngx_pool_t对象管理的内存块上的内存，后续的分配如果第一个内存块上的空闲部分已用完，会再分配的）。 </p>
<p>选择小于sizeof(ngx_pool_t)的值会造成程序崩溃。由于初始大小的内存块中要用一部分来存储ngx_pool_t这个信息本身。</p>
<p>当一个ngx_pool_t对象被创建以后，该对象的max字段被赋值为size-sizeof(ngx_pool_t)和NGX_MAX_ALLOC_FROM_POOL这两者中比较小的。后续的从这个pool中分配的内存块，在第一块内存使用完成以后，如果要继续分配的话，就需要继续从操作系统申请内存。当内存的大小小于等于max字段的时候，则分配新的内存块，链接在d这个字段（实际上是d.next字段）管理的一条链表上。当要分配的内存块是比max大的，那么从系统中申请的内存是被挂接在large字段管理的一条链表上。我们暂且把这个称之为大块内存链和小块内存链。</p>
<p>.. code:: c   </p>
<pre><code>void <span class="keyword">*</span>ngx_palloc(ngx_pool_t <span class="keyword">*</span>pool, size_t size); 
</code></pre><p>从这个pool中分配一块为size大小的内存。注意，此函数分配的内存的起始地址按照NGX_ALIGNMENT进行了对齐。对齐操作会提高系统处理的速度，但会造成少量内存的浪费。 </p>
<p>.. code:: c   </p>
<pre><code>void <span class="keyword">*</span>ngx_pnalloc(ngx_pool_t <span class="keyword">*</span>pool, size_t size); 
</code></pre><p>从这个pool中分配一块为size大小的内存。但是此函数分配的内存并没有像上面的函数那样进行过对齐。</p>
<p>.. code:: c</p>
<pre><code>void <span class="keyword">*</span>ngx_pcalloc(ngx_pool_t <span class="keyword">*</span>pool, size_t size);
</code></pre><p>该函数也是分配size大小的内存，并且对分配的内存块进行了清零。内部实际上是转调用ngx_palloc实现的。 </p>
<p>.. code:: c </p>
<pre><code>void <span class="keyword">*</span>ngx_pmemalign(ngx_pool_t <span class="keyword">*</span>pool, size_t size, size_t alignment);
</code></pre><p>按照指定对齐大小alignment来申请一块大小为size的内存。此处获取的内存不管大小都将被置于大内存块链中管理。 </p>
<p>.. code:: c  </p>
<pre><code>ngx_int_t ngx_pfree<span class="list">(<span class="keyword">ngx_pool_t</span> <span class="variable">*pool, void *</span>p)</span><span class="comment">;</span>
</code></pre><p>对于被置于大块内存链，也就是被large字段管理的一列内存中的某块进行释放。该函数的实现是顺序遍历large管理的大块内存链表。所以效率比较低下。如果在这个链表中找到了这块内存，则释放，并返回NGX_OK。否则返回NGX_DECLINED。</p>
<p>由于这个操作效率比较低下，除非必要，也就是说这块内存非常大，确应及时释放，否则一般不需要调用。反正内存在这个pool被销毁的时候，总归会都释放掉的嘛！</p>
<p>.. code:: c </p>
<pre><code>ngx_pool_cleanup_t <span class="keyword">*</span>ngx_pool_cleanup_add(ngx_pool_t <span class="keyword">*</span>p, size_t size); 
</code></pre><p>ngx_pool_t中的cleanup字段管理着一个特殊的链表，该链表的每一项都记录着一个特殊的需要释放的资源。对于这个链表中每个节点所包含的资源如何去释放，是自说明的。这也就提供了非常大的灵活性。意味着，ngx_pool_t不仅仅可以管理内存，通过这个机制，也可以管理任何需要释放的资源，例如，关闭文件，或者删除文件等等。下面我们看一下这个链表每个节点的类型: </p>
<p>.. code:: c  </p>
<pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> ngx_pool_cleanup_s  ngx_pool_cleanup_t;
<span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ngx_pool_cleanup_pt)</span><span class="params">(<span class="keyword">void</span> *data)</span></span>;

<span class="keyword">struct</span> ngx_pool_cleanup_s {
    ngx_pool_cleanup_pt   handler;
    <span class="keyword">void</span>                 *data;
    ngx_pool_cleanup_t   *next;
};
</code></pre><p>:data: 指明了该节点所对应的资源。 </p>
<p>:handler: 是一个函数指针，指向一个可以释放data所对应资源的函数。该函数只有一个参数，就是data。 </p>
<p>:next: 指向该链表中下一个元素。</p>
<p>看到这里，ngx_pool_cleanup_add这个函数的用法，我相信大家都应该有一些明白了。但是这个参数size是起什么作用的呢？这个 size就是要存储这个data字段所指向的资源的大小，该函数会为data分配size大小的空间。</p>
<p>比如我们需要最后删除一个文件。那我们在调用这个函数的时候，把size指定为存储文件名的字符串的大小，然后调用这个函数给cleanup链表中增加一项。该函数会返回新添加的这个节点。我们然后把这个节点中的data字段拷贝为文件名。把hander字段赋值为一个删除文件的函数（当然该函数的原型要按照void (*ngx_pool_cleanup_pt)(void *data)）。</p>
<p>.. code:: c </p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">ngx_destroy_pool</span><span class="params">(ngx_pool_t *pool)</span></span>;
</code></pre><p>该函数就是释放pool中持有的所有内存，以及依次调用cleanup字段所管理的链表中每个元素的handler字段所指向的函数，来释放掉所有该pool管理的资源。并且把pool指向的ngx_pool_t也释放掉了，完全不可用了。 </p>
<p>.. code:: c </p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">ngx_reset_pool</span><span class="params">(ngx_pool_t *pool)</span></span>;
</code></pre><p>该函数释放pool中所有大块内存链表上的内存，小块内存链上的内存块都修改为可用。但是不会去处理cleanup链表上的项目。 </p>
<p>ngx_array_t(100%)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;ngx_array_t&#26159;nginx&#20869;&#37096;&#20351;&#29992;&#30340;&#25968;&#32452;&#32467;&#26500;&#12290;nginx&#30340;&#25968;&#32452;&#32467;&#26500;&#22312;&#23384;&#20648;&#19978;&#19982;&#22823;&#23478;&#35748;&#30693;&#30340;C&#35821;&#35328;&#20869;&#32622;&#30340;&#25968;&#32452;&#26377;&#30456;&#20284;&#24615;&#65292;&#27604;&#22914;&#23454;&#38469;&#19978;&#23384;&#20648;&#25968;&#25454;&#30340;&#21306;&#22495;&#20063;&#26159;&#19968;&#22823;&#22359;&#36830;&#32493;&#30340;&#20869;&#23384;&#12290;&#20294;&#26159;&#25968;&#32452;&#38500;&#20102;&#23384;&#20648;&#25968;&#25454;&#30340;&#20869;&#23384;&#20197;&#22806;&#36824;&#21253;&#21547;&#19968;&#20123;&#20803;&#20449;&#24687;&#26469;&#25551;&#36848;&#30456;&#20851;&#30340;&#19968;&#20123;&#20449;&#24687;&#12290;&#19979;&#38754;&#25105;&#20204;&#20174;&#25968;&#32452;&#30340;&#23450;&#20041;&#19978;&#26469;&#35814;&#32454;&#30340;&#20102;&#35299;&#19968;&#19979;&#12290;ngx_array_t&#30340;&#23450;&#20041;&#20301;&#20110;src/core/ngx_array.c|h&#37324;&#38754;&#12290; &#10;&#10;.. code:: c&#10;&#10;    typedef struct ngx_array_s       ngx_array_t;&#10;    struct ngx_array_s &#123;&#10;        void        *elts;&#10;        ngx_uint_t   nelts;&#10;        size_t       size;&#10;        ngx_uint_t   nalloc;&#10;        ngx_pool_t  *pool;&#10;    &#125;;&#10;&#10;&#10;:elts: &#25351;&#21521;&#23454;&#38469;&#30340;&#25968;&#25454;&#23384;&#20648;&#21306;&#22495;&#12290; &#10;&#10;:nelts: &#25968;&#32452;&#23454;&#38469;&#20803;&#32032;&#20010;&#25968;&#12290;&#10; &#10;:size: &#25968;&#32452;&#21333;&#20010;&#20803;&#32032;&#30340;&#22823;&#23567;&#65292;&#21333;&#20301;&#26159;&#23383;&#33410;&#12290; &#10;&#10;:nalloc: &#25968;&#32452;&#30340;&#23481;&#37327;&#12290;&#34920;&#31034;&#35813;&#25968;&#32452;&#22312;&#19981;&#24341;&#21457;&#25193;&#23481;&#30340;&#21069;&#25552;&#19979;&#65292;&#21487;&#20197;&#26368;&#22810;&#23384;&#20648;&#30340;&#20803;&#32032;&#30340;&#20010;&#25968;&#12290;&#24403;nelts&#22686;&#38271;&#21040;&#36798;nalloc &#26102;&#65292;&#22914;&#26524;&#20877;&#24448;&#27492;&#25968;&#32452;&#20013;&#23384;&#20648;&#20803;&#32032;&#65292;&#21017;&#20250;&#24341;&#21457;&#25968;&#32452;&#30340;&#25193;&#23481;&#12290;&#25968;&#32452;&#30340;&#23481;&#37327;&#23558;&#20250;&#25193;&#23637;&#21040;&#21407;&#26377;&#23481;&#37327;&#30340;2&#20493;&#22823;&#23567;&#12290;&#23454;&#38469;&#19978;&#26159;&#20998;&#37197;&#26032;&#30340;&#19968;&#22359;&#20869;&#23384;&#65292;&#26032;&#30340;&#19968;&#22359;&#20869;&#23384;&#30340;&#22823;&#23567;&#26159;&#21407;&#26377;&#20869;&#23384;&#22823;&#23567;&#30340;2&#20493;&#12290;&#21407;&#26377;&#30340;&#25968;&#25454;&#20250;&#34987;&#25335;&#36125;&#21040;&#26032;&#30340;&#19968;&#22359;&#20869;&#23384;&#20013;&#12290; &#10;&#10;:pool: &#35813;&#25968;&#32452;&#29992;&#26469;&#20998;&#37197;&#20869;&#23384;&#30340;&#20869;&#23384;&#27744;&#12290;&#10;&#10;&#10;&#10;&#10;&#19979;&#38754;&#20171;&#32461;ngx_array_t&#30456;&#20851;&#25805;&#20316;&#20989;&#25968;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_array_t *ngx_array_create(ngx_pool_t *p, ngx_uint_t n, size_t size);&#10;&#10;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;&#25968;&#32452;&#23545;&#35937;&#65292;&#24182;&#36820;&#22238;&#36825;&#20010;&#23545;&#35937;&#12290; &#10;&#10;:p: &#25968;&#32452;&#20998;&#37197;&#20869;&#23384;&#20351;&#29992;&#30340;&#20869;&#23384;&#27744;&#65307;&#10;:n: &#25968;&#32452;&#30340;&#21021;&#22987;&#23481;&#37327;&#22823;&#23567;&#65292;&#21363;&#22312;&#19981;&#25193;&#23481;&#30340;&#24773;&#20917;&#19979;&#26368;&#22810;&#21487;&#20197;&#23481;&#32435;&#30340;&#20803;&#32032;&#20010;&#25968;&#12290;&#10;:size: &#21333;&#20010;&#20803;&#32032;&#30340;&#22823;&#23567;&#65292;&#21333;&#20301;&#26159;&#23383;&#33410;&#12290;&#10;&#10;&#10;.. code:: c &#10;&#10;    void ngx_array_destroy(ngx_array_t *a);&#10;&#10;&#38144;&#27585;&#35813;&#25968;&#32452;&#23545;&#35937;&#65292;&#24182;&#37322;&#25918;&#20854;&#20998;&#37197;&#30340;&#20869;&#23384;&#22238;&#20869;&#23384;&#27744;&#12290;&#10;&#10;&#10;.. code:: c &#10;&#10;    void *ngx_array_push(ngx_array_t *a);&#10;&#10;&#22312;&#25968;&#32452;a&#19978;&#26032;&#36861;&#21152;&#19968;&#20010;&#20803;&#32032;&#65292;&#24182;&#36820;&#22238;&#25351;&#21521;&#26032;&#20803;&#32032;&#30340;&#25351;&#38024;&#12290;&#38656;&#35201;&#25226;&#36820;&#22238;&#30340;&#25351;&#38024;&#20351;&#29992;&#31867;&#22411;&#36716;&#25442;&#65292;&#36716;&#25442;&#20026;&#20855;&#20307;&#30340;&#31867;&#22411;&#65292;&#28982;&#21518;&#20877;&#32473;&#26032;&#20803;&#32032;&#26412;&#36523;&#25110;&#32773;&#26159;&#21508;&#23383;&#27573;&#65288;&#22914;&#26524;&#25968;&#32452;&#30340;&#20803;&#32032;&#26159;&#22797;&#26434;&#31867;&#22411;&#65289;&#36171;&#20540;&#12290; &#10;&#10;&#10;.. code:: c &#10;&#10;    void *ngx_array_push_n(ngx_array_t *a, ngx_uint_t n);&#10;&#10;&#22312;&#25968;&#32452;a&#19978;&#36861;&#21152;n&#20010;&#20803;&#32032;&#65292;&#24182;&#36820;&#22238;&#25351;&#21521;&#36825;&#20123;&#36861;&#21152;&#20803;&#32032;&#30340;&#39318;&#20010;&#20803;&#32032;&#30340;&#20301;&#32622;&#30340;&#25351;&#38024;&#12290; &#10;&#10;&#10;.. code:: c&#10;&#10;    static ngx_inline ngx_int_t ngx_array_init(ngx_array_t *array, ngx_pool_t *pool, ngx_uint_t n, size_t size);&#10;&#10;&#22914;&#26524;&#19968;&#20010;&#25968;&#32452;&#23545;&#35937;&#26159;&#34987;&#20998;&#37197;&#22312;&#22534;&#19978;&#30340;&#65292;&#37027;&#20040;&#24403;&#35843;&#29992;ngx_array_destroy&#38144;&#27585;&#20197;&#21518;&#65292;&#22914;&#26524;&#24819;&#20877;&#27425;&#20351;&#29992;&#65292;&#23601;&#21487;&#20197;&#35843;&#29992;&#27492;&#20989;&#25968;&#12290;&#10;&#10;&#22914;&#26524;&#19968;&#20010;&#25968;&#32452;&#23545;&#35937;&#26159;&#34987;&#20998;&#37197;&#22312;&#26632;&#19978;&#30340;&#65292;&#37027;&#20040;&#23601;&#38656;&#35201;&#35843;&#29992;&#27492;&#20989;&#25968;&#65292;&#36827;&#34892;&#21021;&#22987;&#21270;&#30340;&#24037;&#20316;&#20197;&#21518;&#65292;&#25165;&#21487;&#20197;&#20351;&#29992;&#12290;&#10; &#10;&#10;**&#27880;&#24847;&#20107;&#39033;\:** &#10;&#30001;&#20110;&#20351;&#29992;ngx_palloc&#20998;&#37197;&#20869;&#23384;&#65292;&#25968;&#32452;&#22312;&#25193;&#23481;&#26102;&#65292;&#26087;&#30340;&#20869;&#23384;&#19981;&#20250;&#34987;&#37322;&#25918;&#65292;&#20250;&#36896;&#25104;&#20869;&#23384;&#30340;&#28010;&#36153;&#12290;&#22240;&#27492;&#65292;&#26368;&#22909;&#33021;&#25552;&#21069;&#35268;&#21010;&#22909;&#25968;&#32452;&#30340;&#23481;&#37327;&#65292;&#22312;&#21019;&#24314;&#25110;&#32773;&#21021;&#22987;&#21270;&#30340;&#26102;&#20505;&#19968;&#27425;&#25630;&#23450;&#65292;&#36991;&#20813;&#22810;&#27425;&#25193;&#23481;&#65292;&#36896;&#25104;&#20869;&#23384;&#28010;&#36153;&#12290;&#10;&#10;&#10;&#10;ngx_hash_t(100%)&#10;~~~~~~~~~~~~~~~~~~&#10;&#10;ngx_hash_t&#26159;nginx&#33258;&#24049;&#30340;hash&#34920;&#30340;&#23454;&#29616;&#12290;&#23450;&#20041;&#21644;&#23454;&#29616;&#20301;&#20110;src/core/ngx_hash.h|c&#20013;&#12290;ngx_hash_t&#30340;&#23454;&#29616;&#20063;&#19982;&#25968;&#25454;&#32467;&#26500;&#25945;&#31185;&#20070;&#19978;&#25152;&#25551;&#36848;&#30340;hash&#34920;&#30340;&#23454;&#29616;&#26159;&#22823;&#21516;&#23567;&#24322;&#12290;&#23545;&#20110;&#24120;&#29992;&#30340;&#35299;&#20915;&#20914;&#31361;&#30340;&#26041;&#27861;&#26377;&#32447;&#24615;&#25506;&#27979;&#65292;&#20108;&#27425;&#25506;&#27979;&#21644;&#24320;&#38142;&#27861;&#31561;&#12290;ngx_hash_t&#20351;&#29992;&#30340;&#26159;&#26368;&#24120;&#29992;&#30340;&#19968;&#31181;&#65292;&#20063;&#23601;&#26159;&#24320;&#38142;&#27861;&#65292;&#36825;&#20063;&#26159;STL&#20013;&#30340;hash&#34920;&#20351;&#29992;&#30340;&#26041;&#27861;&#12290; &#10;&#10;&#20294;&#26159;ngx_hash_t&#30340;&#23454;&#29616;&#21448;&#26377;&#20854;&#20960;&#20010;&#26174;&#33879;&#30340;&#29305;&#28857;:&#10;&#10;1. ngx_hash_t&#19981;&#20687;&#20854;&#20182;&#30340;hash&#34920;&#30340;&#23454;&#29616;&#65292;&#21487;&#20197;&#25554;&#20837;&#21024;&#38500;&#20803;&#32032;&#65292;&#23427;&#21482;&#33021;&#19968;&#27425;&#21021;&#22987;&#21270;&#65292;&#23601;&#26500;&#24314;&#36215;&#25972;&#20010;hash&#34920;&#20197;&#21518;&#65292;&#26082;&#19981;&#33021;&#20877;&#21024;&#38500;&#65292;&#20063;&#19981;&#33021;&#22312;&#25554;&#20837;&#20803;&#32032;&#20102;&#12290;&#10;2. ngx_hash_t&#30340;&#24320;&#38142;&#24182;&#19981;&#26159;&#30495;&#30340;&#24320;&#20102;&#19968;&#20010;&#38142;&#34920;&#65292;&#23454;&#38469;&#19978;&#26159;&#24320;&#20102;&#19968;&#27573;&#36830;&#32493;&#30340;&#23384;&#20648;&#31354;&#38388;&#65292;&#20960;&#20046;&#21487;&#20197;&#30475;&#20570;&#26159;&#19968;&#20010;&#25968;&#32452;&#12290;&#36825;&#26159;&#22240;&#20026;ngx_hash_t&#22312;&#21021;&#22987;&#21270;&#30340;&#26102;&#20505;&#65292;&#20250;&#32463;&#21382;&#19968;&#27425;&#39044;&#35745;&#31639;&#30340;&#36807;&#31243;&#65292;&#25552;&#21069;&#25226;&#27599;&#20010;&#26742;&#37324;&#38754;&#20250;&#26377;&#22810;&#23569;&#20803;&#32032;&#25918;&#36827;&#21435;&#32473;&#35745;&#31639;&#20986;&#26469;&#65292;&#36825;&#26679;&#23601;&#25552;&#21069;&#30693;&#36947;&#27599;&#20010;&#26742;&#30340;&#22823;&#23567;&#20102;&#12290;&#37027;&#20040;&#23601;&#19981;&#38656;&#35201;&#20351;&#29992;&#38142;&#34920;&#65292;&#19968;&#27573;&#36830;&#32493;&#30340;&#23384;&#20648;&#31354;&#38388;&#23601;&#36275;&#22815;&#20102;&#12290;&#36825;&#20063;&#20174;&#19968;&#23450;&#31243;&#24230;&#19978;&#33410;&#30465;&#20102;&#20869;&#23384;&#30340;&#20351;&#29992;&#12290;&#10;&#10;&#20174;&#19978;&#38754;&#30340;&#25551;&#36848;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#20986;&#26469;&#65292;&#36825;&#20010;&#20540;&#36234;&#22823;&#65292;&#36234;&#36896;&#25104;&#20869;&#23384;&#30340;&#28010;&#36153;&#12290;&#23601;&#20004;&#27493;&#65292;&#39318;&#20808;&#26159;&#21021;&#22987;&#21270;&#65292;&#28982;&#21518;&#23601;&#21487;&#20197;&#22312;&#37324;&#38754;&#36827;&#34892;&#26597;&#25214;&#20102;&#12290;&#19979;&#38754;&#25105;&#20204;&#35814;&#32454;&#26469;&#30475;&#19968;&#19979;&#12290;&#10;&#10;ngx_hash_t&#30340;&#21021;&#22987;&#21270;&#12290;&#10;&#10;&#10;.. code:: c&#10;&#10;    ngx_int_t ngx_hash_init(ngx_hash_init_t *hinit, ngx_hash_key_t *names,&#10; ngx_uint_t nelts);&#10;&#10;&#39318;&#20808;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#21021;&#22987;&#21270;&#20989;&#25968;&#12290;&#35813;&#20989;&#25968;&#30340;&#31532;&#19968;&#20010;&#21442;&#25968;hinit&#26159;&#21021;&#22987;&#21270;&#30340;&#19968;&#20123;&#21442;&#25968;&#30340;&#19968;&#20010;&#38598;&#21512;&#12290; names&#26159;&#21021;&#22987;&#21270;&#19968;&#20010;ngx_hash_t&#25152;&#38656;&#35201;&#30340;&#25152;&#26377;key&#30340;&#19968;&#20010;&#25968;&#32452;&#12290;&#32780;nelts&#23601;&#26159;key&#30340;&#20010;&#25968;&#12290;&#19979;&#38754;&#20808;&#30475;&#19968;&#19979;ngx_hash_init_t&#31867;&#22411;&#65292;&#35813;&#31867;&#22411;&#25552;&#20379;&#20102;&#21021;&#22987;&#21270;&#19968;&#20010;hash&#34920;&#25152;&#38656;&#35201;&#30340;&#19968;&#20123;&#22522;&#26412;&#20449;&#24687;&#12290; &#10;&#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        ngx_hash_t       *hash;&#10;        ngx_hash_key_pt   key;&#10;    &#10;        ngx_uint_t        max_size;&#10;        ngx_uint_t        bucket_size;&#10;    &#10;        char             *name;&#10;        ngx_pool_t       *pool;&#10;        ngx_pool_t       *temp_pool;&#10;    &#125; ngx_hash_init_t;&#10;&#10;&#10;:hash: &#35813;&#23383;&#27573;&#22914;&#26524;&#20026;NULL&#65292;&#37027;&#20040;&#35843;&#29992;&#23436;&#21021;&#22987;&#21270;&#20989;&#25968;&#21518;&#65292;&#35813;&#23383;&#27573;&#25351;&#21521;&#26032;&#21019;&#24314;&#20986;&#26469;&#30340;hash&#34920;&#12290;&#22914;&#26524;&#35813;&#23383;&#27573;&#19981;&#20026;NULL&#65292;&#37027;&#20040;&#22312;&#21021;&#22987;&#30340;&#26102;&#20505;&#65292;&#25152;&#26377;&#30340;&#25968;&#25454;&#34987;&#25554;&#20837;&#20102;&#36825;&#20010;&#23383;&#27573;&#25152;&#25351;&#30340;hash&#34920;&#20013;&#12290;&#10;&#10;:key: &#25351;&#21521;&#20174;&#23383;&#31526;&#20018;&#29983;&#25104;hash&#20540;&#30340;hash&#20989;&#25968;&#12290;nginx&#30340;&#28304;&#20195;&#30721;&#20013;&#25552;&#20379;&#20102;&#40664;&#35748;&#30340;&#23454;&#29616;&#20989;&#25968;ngx_hash_key_lc&#12290;&#10;&#10;:max_size: hash&#34920;&#20013;&#30340;&#26742;&#30340;&#20010;&#25968;&#12290;&#35813;&#23383;&#27573;&#36234;&#22823;&#65292;&#20803;&#32032;&#23384;&#20648;&#26102;&#20914;&#31361;&#30340;&#21487;&#33021;&#24615;&#36234;&#23567;&#65292;&#27599;&#20010;&#26742;&#20013;&#23384;&#20648;&#30340;&#20803;&#32032;&#20250;&#26356;&#23569;&#65292;&#21017;&#26597;&#35810;&#36215;&#26469;&#30340;&#36895;&#24230;&#26356;&#24555;&#12290;&#24403;&#28982;&#65292;&#36825;&#20010;&#20540;&#36234;&#22823;&#65292;&#36234;&#36896;&#25104;&#20869;&#23384;&#30340;&#28010;&#36153;&#20063;&#36234;&#22823;&#65292;(&#23454;&#38469;&#19978;&#20063;&#28010;&#36153;&#19981;&#20102;&#22810;&#23569;)&#12290;&#10;&#10;:bucket_size: &#27599;&#20010;&#26742;&#30340;&#26368;&#22823;&#38480;&#21046;&#22823;&#23567;&#65292;&#21333;&#20301;&#26159;&#23383;&#33410;&#12290;&#22914;&#26524;&#22312;&#21021;&#22987;&#21270;&#19968;&#20010;hash&#34920;&#30340;&#26102;&#20505;&#65292;&#21457;&#29616;&#26576;&#20010;&#26742;&#37324;&#38754;&#26080;&#27861;&#23384;&#30340;&#19979;&#25152;&#26377;&#23646;&#20110;&#35813;&#26742;&#30340;&#20803;&#32032;&#65292;&#21017;hash&#34920;&#21021;&#22987;&#21270;&#22833;&#36133;&#12290;&#10;&#10;:name: &#35813;hash&#34920;&#30340;&#21517;&#23383;&#12290;&#10;&#10;:pool: &#35813;hash&#34920;&#20998;&#37197;&#20869;&#23384;&#20351;&#29992;&#30340;pool&#12290;&#10; &#10;&#10;:temp_pool: &#35813;hash&#34920;&#20351;&#29992;&#30340;&#20020;&#26102;pool&#65292;&#22312;&#21021;&#22987;&#21270;&#23436;&#25104;&#20197;&#21518;&#65292;&#35813;pool&#21487;&#20197;&#34987;&#37322;&#25918;&#21644;&#38144;&#27585;&#25481;&#12290;&#10;&#10;&#10;&#19979;&#38754;&#26469;&#30475;&#19968;&#19979;&#23384;&#20648;hash&#34920;key&#30340;&#25968;&#32452;&#30340;&#32467;&#26500;&#12290;&#10;&#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        ngx_str_t         key;&#10;        ngx_uint_t        key_hash;&#10;        void             *value;&#10;    &#125; ngx_hash_key_t;&#10;&#10;&#10;key&#21644;value&#30340;&#21547;&#20041;&#26174;&#32780;&#26131;&#35265;&#65292;&#23601;&#19981;&#29992;&#35299;&#37322;&#20102;&#12290;key_hash&#26159;&#23545;key&#20351;&#29992;hash&#20989;&#25968;&#35745;&#31639;&#20986;&#26469;&#30340;&#20540;&#12290;&#10;&#23545;&#36825;&#20004;&#20010;&#32467;&#26500;&#20998;&#26512;&#23436;&#25104;&#20197;&#21518;&#65292;&#25105;&#24819;&#22823;&#23478;&#24212;&#35813;&#37117;&#24050;&#32463;&#26126;&#30333;&#36825;&#20010;&#20989;&#25968;&#24212;&#35813;&#26159;&#22914;&#20309;&#20351;&#29992;&#20102;&#21543;&#12290;&#35813;&#20989;&#25968;&#25104;&#21151;&#21021;&#22987;&#21270;&#19968;&#20010;hash&#34920;&#20197;&#21518;&#65292;&#36820;&#22238;NGX_OK&#65292;&#21542;&#21017;&#36820;&#22238;NGX_ERROR&#12290;&#10;&#10;&#10;&#10;.. code:: c&#10;&#10;    void *ngx_hash_find(ngx_hash_t *hash, ngx_uint_t key, u_char *name, size_t len);&#10;&#10;&#22312;hash&#37324;&#38754;&#26597;&#25214;key&#23545;&#24212;&#30340;value&#12290;&#23454;&#38469;&#19978;&#36825;&#37324;&#30340;key&#26159;&#23545;&#30495;&#27491;&#30340;key&#65288;&#20063;&#23601;&#26159;name&#65289;&#35745;&#31639;&#20986;&#30340;hash&#20540;&#12290;len&#26159;name&#30340;&#38271;&#24230;&#12290;&#10;&#10;&#22914;&#26524;&#26597;&#25214;&#25104;&#21151;&#65292;&#21017;&#36820;&#22238;&#25351;&#21521;value&#30340;&#25351;&#38024;&#65292;&#21542;&#21017;&#36820;&#22238;NULL&#12290;&#10;&#10;&#10;ngx_hash_wildcard_t(100%)&#10;~~~~~~~~</span><br></pre></td></tr></table></figure></p>
<p>nginx为了处理带有通配符的域名的匹配问题，实现了ngx_hash_wildcard_t这样的hash表。他可以支持两种类型的带有通配符的域名。一种是通配符在前的，例如：“*.abc.com”，也可以省略掉星号，直接写成”.abc.com”。这样的key，可以匹配www.abc.com，qqq.www.abc.com之类的。另外一种是通配符在末尾的，例如：“mail.xxx.*”，请特别注意通配符在末尾的不像位于开始的通配符可以被省略掉。这样的通配符，可以匹配mail.xxx.com、mail.xxx.com.cn、mail.xxx.net之类的域名。</p>
<p>有一点必须说明，就是一个ngx_hash_wildcard_t类型的hash表只能包含通配符在前的key或者是通配符在后的key。不能同时包含两种类型的通配符的key。ngx_hash_wildcard_t类型变量的构建是通过函数ngx_hash_wildcard_init完成的，而查询是通过函数ngx_hash_find_wc_head或者ngx_hash_find_wc_tail来做的。ngx_hash_find_wc_head是查询包含通配符在前的key的hash表的，而ngx_hash_find_wc_tail是查询包含通配符在后的key的hash表的。</p>
<p>下面详细说明这几个函数的用法。</p>
<p>.. code:: c</p>
<pre><code>ngx_int_t ngx_<span class="built_in">hash</span>_wildcard_init(ngx_<span class="built_in">hash</span>_init_t *hinit, ngx_<span class="built_in">hash</span>_key_t *names,
    ngx_uint_t nelts);
</code></pre><p>该函数迎来构建一个可以包含通配符key的hash表。</p>
<p>:hinit: 构造一个通配符hash表的一些参数的一个集合。关于该参数对应的类型的说明，请参见ngx_hash_t类型中ngx_hash_init函数的说明。</p>
<p>:names: 构造此hash表的所有的通配符key的数组。特别要注意的是这里的key已经都是被预处理过的。例如：“*.abc.com”或者“.abc.com”被预处理完成以后，变成了“com.abc.”。而“mail.xxx.*”则被预处理为“mail.xxx.”。为什么会被处理这样？这里不得不简单地描述一下通配符hash表的实现原理。当构造此类型的hash表的时候，实际上是构造了一个hash表的一个“链表”，是通过hash表中的key“链接”起来的。比如：对于“*.abc.com”将会构造出2个hash表，第一个hash表中有一个key为com的表项，该表项的value包含有指向第二个hash表的指针，而第二个hash表中有一个表项abc，该表项的value包含有指向*.abc.com对应的value的指针。那么查询的时候，比如查询www.abc.com的时候，先查com，通过查com可以找到第二级的hash表，在第二级hash表中，再查找abc，依次类推，直到在某一级的hash表中查到的表项对应的value对应一个真正的值而非一个指向下一级hash表的指针的时候，查询过程结束。<strong>这里有一点需要特别注意的，就是names数组中元素的value值低两位bit必须为0（有特殊用途）。如果不满足这个条件，这个hash表查询不出正确结果。</strong></p>
<p>:nelts: names数组元素的个数。</p>
<p>该函数执行成功返回NGX_OK，否则NGX_ERROR。</p>
<p>.. code:: c</p>
<pre><code>void <span class="keyword">*</span>ngx_hash_find_wc_head(ngx_hash_wildcard_t <span class="keyword">*</span>hwc, u_char <span class="keyword">*</span>name, size_t len);
</code></pre><p>该函数查询包含通配符在前的key的hash表的。</p>
<p>:hwc: hash表对象的指针。<br>:name: 需要查询的域名，例如: www.abc.com。<br>:len: name的长度。</p>
<p>该函数返回匹配的通配符对应value。如果没有查到，返回NULL。</p>
<p>.. code:: c</p>
<pre><code>void <span class="keyword">*</span>ngx_hash_find_wc_tail(ngx_hash_wildcard_t <span class="keyword">*</span>hwc, u_char <span class="keyword">*</span>name, size_t len);
</code></pre><p>该函数查询包含通配符在末尾的key的hash表的。<br>参数及返回值请参加上个函数的说明。</p>
<p>ngx_hash_combined_t(100%)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#32452;&#21512;&#31867;&#22411;hash&#34920;&#65292;&#35813;hash&#34920;&#30340;&#23450;&#20041;&#22914;&#19979;&#65306;&#10; &#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        ngx_hash_t            hash;&#10;        ngx_hash_wildcard_t  *wc_head;&#10;        ngx_hash_wildcard_t  *wc_tail;&#10;    &#125; ngx_hash_combined_t;&#10;&#10;&#10;&#20174;&#20854;&#23450;&#20041;&#26174;&#35265;&#65292;&#35813;&#31867;&#22411;&#23454;&#38469;&#19978;&#21253;&#21547;&#20102;&#19977;&#20010;hash&#34920;&#65292;&#19968;&#20010;&#26222;&#36890;hash&#34920;&#65292;&#19968;&#20010;&#21253;&#21547;&#21069;&#21521;&#36890;&#37197;&#31526;&#30340;hash&#34920;&#21644;&#19968;&#20010;&#21253;&#21547;&#21518;&#21521;&#36890;&#37197;&#31526;&#30340;hash&#34920;&#12290;&#10;&#10;nginx&#25552;&#20379;&#35813;&#31867;&#22411;&#30340;&#20316;&#29992;&#65292;&#22312;&#20110;&#25552;&#20379;&#19968;&#20010;&#26041;&#20415;&#30340;&#23481;&#22120;&#21253;&#21547;&#19977;&#20010;&#31867;&#22411;&#30340;hash&#34920;&#65292;&#24403;&#26377;&#21253;&#21547;&#36890;&#37197;&#31526;&#30340;&#21644;&#19981;&#21253;&#21547;&#36890;&#37197;&#31526;&#30340;&#19968;&#32452;key&#26500;&#24314;hash&#34920;&#20197;&#21518;&#65292;&#20197;&#19968;&#31181;&#26041;&#20415;&#30340;&#26041;&#24335;&#26469;&#26597;&#35810;&#65292;&#20320;&#19981;&#38656;&#35201;&#20877;&#32771;&#34385;&#19968;&#20010;key&#21040;&#24213;&#26159;&#24212;&#35813;&#21040;&#21738;&#20010;&#31867;&#22411;&#30340;hash&#34920;&#37324;&#21435;&#26597;&#20102;&#12290;&#10;&#10;&#26500;&#36896;&#36825;&#26679;&#19968;&#32452;&#21512;hash&#34920;&#30340;&#26102;&#20505;&#65292;&#39318;&#20808;&#23450;&#20041;&#19968;&#20010;&#35813;&#31867;&#22411;&#30340;&#21464;&#37327;&#65292;&#20877;&#20998;&#21035;&#26500;&#36896;&#20854;&#21253;&#21547;&#30340;&#19977;&#20010;&#23376;hash&#34920;&#21363;&#21487;&#12290;&#10;&#10;&#23545;&#20110;&#35813;&#31867;&#22411;hash&#34920;&#30340;&#26597;&#35810;&#65292;nginx&#25552;&#20379;&#20102;&#19968;&#20010;&#26041;&#20415;&#30340;&#20989;&#25968;ngx_hash_find_combined&#12290;&#10;&#10;.. code:: c&#10;&#10;    void *ngx_hash_find_combined(ngx_hash_combined_t *hash, ngx_uint_t key,&#10;    u_char *name, size_t len);&#10;&#10;&#35813;&#20989;&#25968;&#22312;&#27492;&#32452;&#21512;hash&#34920;&#20013;&#65292;&#20381;&#27425;&#26597;&#35810;&#20854;&#19977;&#20010;&#23376;hash&#34920;&#65292;&#30475;&#26159;&#21542;&#21305;&#37197;&#65292;&#19968;&#26086;&#25214;&#21040;&#65292;&#31435;&#21363;&#36820;&#22238;&#26597;&#25214;&#32467;&#26524;&#65292;&#20063;&#23601;&#26159;&#35828;&#22914;&#26524;&#26377;&#22810;&#20010;&#21487;&#33021;&#21305;&#37197;&#65292;&#21017;&#21482;&#36820;&#22238;&#31532;&#19968;&#20010;&#21305;&#37197;&#30340;&#32467;&#26524;&#12290;&#10;&#10;:hash: &#27492;&#32452;&#21512;hash&#34920;&#23545;&#35937;&#12290;&#10;:key: &#26681;&#25454;name&#35745;&#31639;&#20986;&#30340;hash&#20540;&#12290;&#10;:name: key&#30340;&#20855;&#20307;&#20869;&#23481;&#12290;&#10;:len: name&#30340;&#38271;&#24230;&#12290;&#10;&#10;&#36820;&#22238;&#26597;&#35810;&#30340;&#32467;&#26524;&#65292;&#26410;&#26597;&#21040;&#21017;&#36820;&#22238;NULL&#12290;&#10;&#10;&#10;ngx_hash_keys_arrays_t(100%) &#10;~~</span><br></pre></td></tr></table></figure></p>
<p>大家看到在构建一个ngx_hash_wildcard_t的时候，需要对通配符的哪些key进行预处理。这个处理起来比较麻烦。而当有一组key，这些里面既有无通配符的key，也有包含通配符的key的时候。我们就需要构建三个hash表，一个包含普通的key的hash表，一个包含前向通配符的hash表，一个包含后向通配符的hash表（或者也可以把这三个hash表组合成一个ngx_hash_combined_t）。在这种情况下，为了让大家方便的构造这些hash表，nginx提供给了此辅助类型。</p>
<p>该类型以及相关的操作函数也定义在src/core/ngx_hash.h|c里。我们先来看一下该类型的定义。</p>
<p>.. code:: c</p>
<pre><code>typedef struct {
    ngx_uint_t        hsize;

    ngx_pool_t       <span class="keyword">*</span>pool;
    ngx_pool_t       <span class="keyword">*</span>temp_pool;

    ngx_array_t       keys;
    ngx_array_t      <span class="keyword">*</span>keys_hash;

    ngx_array_t       dns_wc_head;
    ngx_array_t      <span class="keyword">*</span>dns_wc_head_hash;

    ngx_array_t       dns_wc_tail;
    ngx_array_t      <span class="keyword">*</span>dns_wc_tail_hash;
} ngx_hash_keys_arrays_t;
</code></pre><p>:hsize: 将要构建的hash表的桶的个数。对于使用这个结构中包含的信息构建的三种类型的hash表都会使用此参数。</p>
<p>:pool: 构建这些hash表使用的pool。</p>
<p>:temp_pool: 在构建这个类型以及最终的三个hash表过程中可能用到临时pool。该temp_pool可以在构建完成以后，被销毁掉。这里只是存放临时的一些内存消耗。</p>
<p>:keys: 存放所有非通配符key的数组。</p>
<p>:keys_hash: 这是个二维数组，第一个维度代表的是bucket的编号，那么keys_hash[i]中存放的是所有的key算出来的hash值对hsize取模以后的值为i的key。假设有3个key,分别是key1,key2和key3假设hash值算出来以后对hsize取模的值都是i，那么这三个key的值就顺序存放在keys_hash[i][0],keys_hash[i][1], keys_hash[i][2]。该值在调用的过程中用来保存和检测是否有冲突的key值，也就是是否有重复。</p>
<p>:dns_wc_head: 放前向通配符key被处理完成以后的值。比如：“*.abc.com” 被处理完成以后，变成 “com.abc.” 被存放在此数组中。</p>
<p>:dns_wc_tail: 存放后向通配符key被处理完成以后的值。比如：“mail.xxx.*” 被处理完成以后，变成 “mail.xxx.” 被存放在此数组中。</p>
<p>:dns_wc_head_hash: 该值在调用的过程中用来保存和检测是否有冲突的前向通配符的key值，也就是是否有重复。</p>
<p>:dns_wc_tail_hash: 该值在调用的过程中用来保存和检测是否有冲突的后向通配符的key值，也就是是否有重复。</p>
<p>在定义一个这个类型的变量，并对字段pool和temp_pool赋值以后，就可以调用函数ngx_hash_add_key把所有的key加入到这个结构中了，该函数会自动实现普通key，带前向通配符的key和带后向通配符的key的分类和检查，并将这个些值存放到对应的字段中去，<br>然后就可以通过检查这个结构体中的keys、dns_wc_head、dns_wc_tail三个数组是否为空，来决定是否构建普通hash表，前向通配符hash表和后向通配符hash表了（在构建这三个类型的hash表的时候，可以分别使用keys、dns_wc_head、dns_wc_tail三个数组）。</p>
<p>构建出这三个hash表以后，可以组合在一个ngx_hash_combined_t对象中，使用ngx_hash_find_combined进行查找。或者是仍然保持三个独立的变量对应这三个hash表，自己决定何时以及在哪个hash表中进行查询。</p>
<p>.. code:: c</p>
<pre><code>ngx_int_t ngx_<span class="built_in">hash</span>_keys_array_init(ngx_<span class="built_in">hash</span>_keys_arrays_t *ha, ngx_uint_t <span class="built_in">type</span>);
</code></pre><p>初始化这个结构，主要是对这个结构中的ngx_array_t类型的字段进行初始化，成功返回NGX_OK。</p>
<p>:ha: 该结构的对象指针。</p>
<p>:type: 该字段有2个值可选择，即NGX_HASH_SMALL和NGX_HASH_LARGE。用来指明将要建立的hash表的类型，如果是NGX_HASH_SMALL，则有比较小的桶的个数和数组元素大小。NGX_HASH_LARGE则相反。</p>
<p>.. code:: c</p>
<pre><code><span class="function">ngx_int_t <span class="title">ngx_hash_add_key</span><span class="params">(ngx_hash_keys_arrays_t *ha, ngx_str_t *key,
<span class="keyword">void</span> *<span class="keyword">value</span>, ngx_uint_t flags)</span></span>;
</code></pre><p>一般是循环调用这个函数，把一组键值对加入到这个结构体中。返回NGX_OK是加入成功。返回NGX_BUSY意味着key值重复。</p>
<p>:ha: 该结构的对象指针。</p>
<p>:key: 参数名自解释了。</p>
<p>:value: 参数名自解释了。</p>
<p>:flags: 有两个标志位可以设置，NGX_HASH_WILDCARD_KEY和NGX_HASH_READONLY_KEY。同时要设置的使用逻辑与操作符就可以了。NGX_HASH_READONLY_KEY被设置的时候，在计算hash值的时候，key的值不会被转成小写字符，否则会。NGX_HASH_WILDCARD_KEY被设置的时候，说明key里面可能含有通配符，会进行相应的处理。如果两个标志位都不设置，传0。</p>
<p>有关于这个数据结构的使用，可以参考src/http/ngx_http.c中的ngx_http_server_names函数。</p>
<p>ngx_chain_t(100%)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;&#10;nginx&#30340;filter&#27169;&#22359;&#22312;&#22788;&#29702;&#20174;&#21035;&#30340;filter&#27169;&#22359;&#25110;&#32773;&#26159;handler&#27169;&#22359;&#20256;&#36882;&#36807;&#26469;&#30340;&#25968;&#25454;&#65288;&#23454;&#38469;&#19978;&#23601;&#26159;&#38656;&#35201;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;&#30340;http response&#65289;&#12290;&#36825;&#20010;&#20256;&#36882;&#36807;&#26469;&#30340;&#25968;&#25454;&#26159;&#20197;&#19968;&#20010;&#38142;&#34920;&#30340;&#24418;&#24335;(ngx_chain_t)&#12290;&#32780;&#19988;&#25968;&#25454;&#21487;&#33021;&#34987;&#20998;&#22810;&#27425;&#20256;&#36882;&#36807;&#26469;&#12290;&#20063;&#23601;&#26159;&#22810;&#27425;&#35843;&#29992;filter&#30340;&#22788;&#29702;&#20989;&#25968;&#65292;&#20197;&#19981;&#21516;&#30340;ngx_chain_t&#12290;&#10;&#10;&#35813;&#32467;&#26500;&#34987;&#23450;&#20041;&#22312;src/core/ngx_buf.h|c&#12290;&#19979;&#38754;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;ngx_chain_t&#30340;&#23450;&#20041;&#12290;&#10;&#10;.. code:: c&#10;&#10;    typedef struct ngx_chain_s       ngx_chain_t;&#10;&#10;    struct ngx_chain_s &#123;&#10;        ngx_buf_t    *buf;&#10;        ngx_chain_t  *next;&#10;    &#125;;&#10;&#10;&#10;&#23601;2&#20010;&#23383;&#27573;&#65292;next&#25351;&#21521;&#36825;&#20010;&#38142;&#34920;&#30340;&#19979;&#20010;&#33410;&#28857;&#12290;buf&#25351;&#21521;&#23454;&#38469;&#30340;&#25968;&#25454;&#12290;&#25152;&#20197;&#22312;&#36825;&#20010;&#38142;&#34920;&#19978;&#36861;&#21152;&#33410;&#28857;&#20063;&#26159;&#38750;&#24120;&#23481;&#26131;&#65292;&#21482;&#35201;&#25226;&#26411;&#23614;&#20803;&#32032;&#30340;next&#25351;&#38024;&#25351;&#21521;&#26032;&#30340;&#33410;&#28857;&#65292;&#25226;&#26032;&#33410;&#28857;&#30340;next&#36171;&#20540;&#20026;NULL&#21363;&#21487;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_chain_t *ngx_alloc_chain_link(ngx_pool_t *pool);&#10;&#10;&#35813;&#20989;&#25968;&#21019;&#24314;&#19968;&#20010;ngx_chain_t&#30340;&#23545;&#35937;&#65292;&#24182;&#36820;&#22238;&#25351;&#21521;&#23545;&#35937;&#30340;&#25351;&#38024;&#65292;&#22833;&#36133;&#36820;&#22238;NULL&#12290;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_free_chain(pool, cl)                                             \&#10;        cl-&#62;next = pool-&#62;chain;                                                  \&#10;    pool-&#62;chain = cl&#10;&#10;&#35813;&#23439;&#37322;&#25918;&#19968;&#20010;ngx_chain_t&#31867;&#22411;&#30340;&#23545;&#35937;&#12290;&#22914;&#26524;&#35201;&#37322;&#25918;&#25972;&#20010;chain&#65292;&#21017;&#36845;&#20195;&#27492;&#38142;&#34920;&#65292;&#23545;&#27599;&#20010;&#33410;&#28857;&#20351;&#29992;&#27492;&#23439;&#21363;&#21487;&#12290;&#10;&#10;**&#27880;&#24847;\:** &#23545;ngx_chaint_t&#31867;&#22411;&#30340;&#37322;&#25918;&#65292;&#24182;&#19981;&#26159;&#30495;&#30340;&#37322;&#25918;&#20102;&#20869;&#23384;&#65292;&#32780;&#20165;&#20165;&#26159;&#25226;&#36825;&#20010;&#23545;&#35937;&#25346;&#22312;&#20102;&#36825;&#20010;pool&#23545;&#35937;&#30340;&#19968;&#20010;&#21483;&#20570;chain&#30340;&#23383;&#27573;&#23545;&#24212;&#30340;chain&#19978;&#65292;&#20197;&#20379;&#19979;&#27425;&#20174;&#36825;&#20010;pool&#19978;&#20998;&#37197;ngx_chain_t&#31867;&#22411;&#23545;&#35937;&#30340;&#26102;&#20505;&#65292;&#24555;&#36895;&#30340;&#20174;&#36825;&#20010;pool-&#62;chain&#19978;&#21462;&#19979;&#38142;&#39318;&#20803;&#32032;&#23601;&#36820;&#22238;&#20102;&#65292;&#24403;&#28982;&#65292;&#22914;&#26524;&#36825;&#20010;&#38142;&#26159;&#31354;&#30340;&#65292;&#25165;&#20250;&#30495;&#30340;&#22312;&#36825;&#20010;pool&#19978;&#20351;&#29992;ngx_palloc&#20989;&#25968;&#36827;&#34892;&#20998;&#37197;&#12290; &#10;&#10;&#10;&#10;&#10;ngx_buf_t(99%)</span><br></pre></td></tr></table></figure></p>
<p>这个ngx_buf_t就是这个ngx_chain_t链表的每个节点的实际数据。该结构实际上是一种抽象的数据结构，它代表某种具体的数据。这个数据可能是指向内存中的某个缓冲区，也可能指向一个文件的某一部分，也可能是一些纯元数据（元数据的作用在于指示这个链表的读取者对读取的数据进行不同的处理）。</p>
<p>该数据结构位于src/core/ngx_buf.h|c文件中。我们来看一下它的定义。</p>
<p>.. code:: c</p>
<pre><code><span class="keyword">struct</span> ngx_buf_s {
    u_char          *pos;
    u_char          *last;
    off_t            file_pos;
    off_t            file_last;

    u_char          *start;         <span class="comment">/* start of buffer */</span>
    u_char          *end;           <span class="comment">/* end of buffer */</span>
    ngx_buf_tag_t    tag;
    ngx_file_t      *file;
    ngx_buf_t       *shadow;


    <span class="comment">/* the buf's content could be changed */</span>
    <span class="keyword">unsigned</span>         temporary:<span class="number">1</span>;

    <span class="comment">/*
     * the buf's content is in a memory cache or in a read only memory
     * and must not be changed
     */</span>
    <span class="keyword">unsigned</span>         memory:<span class="number">1</span>;

    <span class="comment">/* the buf's content is mmap()ed and must not be changed */</span>
    <span class="keyword">unsigned</span>         mmap:<span class="number">1</span>;

    <span class="keyword">unsigned</span>         recycled:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         in_file:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         flush:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         sync:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         last_buf:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         last_in_chain:<span class="number">1</span>;

    <span class="keyword">unsigned</span>         last_shadow:<span class="number">1</span>;
    <span class="keyword">unsigned</span>         temp_file:<span class="number">1</span>;

    <span class="comment">/* STUB */</span> <span class="keyword">int</span>   num;
};
</code></pre><p>:pos: 当buf所指向的数据在内存里的时候，pos指向的是这段数据开始的位置。</p>
<p>:last: 当buf所指向的数据在内存里的时候，last指向的是这段数据结束的位置。</p>
<p>:file_pos: 当buf所指向的数据是在文件里的时候，file_pos指向的是这段数据的开始位置在文件中的偏移量。</p>
<p>:file_last: 当buf所指向的数据是在文件里的时候，file_last指向的是这段数据的结束位置在文件中的偏移量。</p>
<p>:start: 当buf所指向的数据在内存里的时候，这一整块内存包含的内容可能被包含在多个buf中(比如在某段数据中间插入了其他的数据，这一块数据就需要被拆分开)。那么这些buf中的start和end都指向这一块内存的开始地址和结束地址。而pos和last指向本buf所实际包含的数据的开始和结尾。</p>
<p>:end: 解释参见start。</p>
<p>:tag: 实际上是一个void*类型的指针，使用者可以关联任意的对象上去，只要对使用者有意义。</p>
<p>:file: 当buf所包含的内容在文件中时，file字段指向对应的文件对象。</p>
<p>:shadow: 当这个buf完整copy了另外一个buf的所有字段的时候，那么这两个buf指向的实际上是同一块内存，或者是同一个文件的同一部分，此时这两个buf的shadow字段都是指向对方的。那么对于这样的两个buf，在释放的时候，就需要使用者特别小心，具体是由哪里释放，要提前考虑好，如果造成资源的多次释放，可能会造成程序崩溃！</p>
<p>:temporary: 为1时表示该buf所包含的内容是在一个用户创建的内存块中，并且可以被在filter处理的过程中进行变更，而不会造成问题。</p>
<p>:memory: 为1时表示该buf所包含的内容是在内存中，但是这些内容却不能被进行处理的filter进行变更。</p>
<p>:mmap: 为1时表示该buf所包含的内容是在内存中, 是通过mmap使用内存映射从文件中映射到内存中的，这些内容却不能被进行处理的filter进行变更。</p>
<p>:recycled: 可以回收的。也就是这个buf是可以被释放的。这个字段通常是配合shadow字段一起使用的，对于使用ngx_create_temp_buf 函数创建的buf，并且是另外一个buf的shadow，那么可以使用这个字段来标示这个buf是可以被释放的。</p>
<p>:in_file: 为1时表示该buf所包含的内容是在文件中。</p>
<p>:flush: 遇到有flush字段被设置为1的的buf的chain，则该chain的数据即便不是最后结束的数据（last_buf被设置，标志所有要输出的内容都完了），也会进行输出，不会受postpone_output配置的限制，但是会受到发送速率等其他条件的限制。</p>
<p>:sync:</p>
<p>:last_buf: 数据被以多个chain传递给了过滤器，此字段为1表明这是最后一个buf。</p>
<p>:last_in_chain: 在当前的chain里面，此buf是最后一个。特别要注意的是last_in_chain的buf不一定是last_buf，但是last_buf的buf一定是last_in_chain的。这是因为数据会被以多个chain传递给某个filter模块。</p>
<p>:last_shadow:<br> 在创建一个buf的shadow的时候，通常将新创建的一个buf的last_shadow置为1。 </p>
<p>:temp_file:<br> 由于受到内存使用的限制，有时候一些buf的内容需要被写到磁盘上的临时文件中去，那么这时，就设置此标志<br> 。</p>
<p>对于此对象的创建，可以直接在某个ngx_pool_t上分配，然后根据需要，给对应的字段赋值。也可以使用定义好的2个宏：</p>
<p>.. code:: c</p>
<pre><code><span class="hexcolor">#def</span>ine <span class="function"><span class="title">ngx_alloc_buf</span><span class="params">(pool)</span></span>  <span class="function"><span class="title">ngx_palloc</span><span class="params">(pool, sizeof(ngx_buf_t)</span></span>)
<span class="hexcolor">#def</span>ine <span class="function"><span class="title">ngx_calloc_buf</span><span class="params">(pool)</span></span> <span class="function"><span class="title">ngx_pcalloc</span><span class="params">(pool, sizeof(ngx_buf_t)</span></span>)
</code></pre><p>这两个宏使用类似函数，也是不说自明的。</p>
<p>对于创建temporary字段为1的buf（就是其内容可以被后续的filter模块进行修改），可以直接使用函数ngx_create_temp_buf进行创建。</p>
<p>.. code:: c</p>
<pre><code>ngx_buf_t <span class="keyword">*</span>ngx_create_temp_buf(ngx_pool_t <span class="keyword">*</span>pool, size_t size);
</code></pre><p>该函数创建一个ngx_but_t类型的对象，并返回指向这个对象的指针，创建失败返回NULL。</p>
<p>对于创建的这个对象，它的start和end指向新分配内存开始和结束的地方。pos和last都指向这块新分配内存的开始处，这样，后续的操作可以在这块新分配的内存上存入数据。</p>
<p>:pool: 分配该buf和buf使用的内存所使用的pool。<br>:size: 该buf使用的内存的大小。</p>
<p>为了配合对ngx_buf_t的使用，nginx定义了以下的宏方便操作。</p>
<p>.. code:: c</p>
<pre><code>#define ngx_buf_in_memory<span class="list">(<span class="keyword">b</span>)</span>        <span class="list">(<span class="keyword">b-&gt;temporary</span> || b-&gt;memory || b-&gt;mmap)</span>
</code></pre><p>返回这个buf里面的内容是否在内存里。</p>
<p>.. code:: c</p>
<pre><code><span class="hexcolor">#def</span>ine <span class="function"><span class="title">ngx_buf_in_memory_only</span><span class="params">(b)</span></span>   (<span class="function"><span class="title">ngx_buf_in_memory</span><span class="params">(b)</span></span> &amp;&amp; !b-&gt;in_file)
</code></pre><p>返回这个buf里面的内容是否仅仅在内存里，并且没有在文件里。</p>
<p>.. code:: c</p>
<pre><code>#<span class="function_or_atom">define</span> <span class="function_or_atom">ngx_buf_special</span>(<span class="function_or_atom">b</span>)                                                   \
    ((<span class="function_or_atom">b</span><span class="arrow">-&gt;</span><span class="function_or_atom">flush</span> || <span class="function_or_atom">b</span><span class="arrow">-&gt;</span><span class="function_or_atom">last_buf</span> || <span class="function_or_atom">b</span><span class="arrow">-&gt;</span><span class="function_or_atom">sync</span>)                                    \
     &amp;&amp; <span class="exclamation_mark">!</span><span class="function_or_atom">ngx_buf_in_memory</span>(<span class="function_or_atom">b</span>) &amp;&amp; <span class="exclamation_mark">!</span><span class="function_or_atom">b</span><span class="arrow">-&gt;</span><span class="function_or_atom">in_file</span>)
</code></pre><p>返回该buf是否是一个特殊的buf，只含有特殊的标志和没有包含真正的数据。</p>
<p>.. code:: c</p>
<pre><code><span class="hexcolor">#def</span>ine <span class="function"><span class="title">ngx_buf_sync_only</span><span class="params">(b)</span></span>                                                 \
    (b-&gt;sync                                                                 \
     &amp;&amp; !<span class="function"><span class="title">ngx_buf_in_memory</span><span class="params">(b)</span></span> &amp;&amp; !b-&gt;in_file &amp;&amp; !b-&gt;flush &amp;&amp; !b-&gt;last_buf)
</code></pre><p>返回该buf是否是一个只包含sync标志而不包含真正数据的特殊buf。</p>
<p>.. code:: c</p>
<pre><code><span class="id">#define</span> <span class="tag">ngx_buf_size</span>(b)                                                      \
    (<span class="function">ngx_buf_in_memory</span>(b) ? (off_t) (b-&gt;last - b-&gt;pos):                      \
                            (b-&gt;file_last - b-&gt;file_pos))
</code></pre><p>返回该buf所含数据的大小，不管这个数据是在文件里还是在内存里。</p>
<p>ngx_list_t(100%)<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;ngx_list_t&#39038;&#21517;&#24605;&#20041;&#65292;&#30475;&#36215;&#26469;&#22909;&#20687;&#26159;&#19968;&#20010;list&#30340;&#25968;&#25454;&#32467;&#26500;&#12290;&#36825;&#26679;&#30340;&#35828;&#27861;&#65292;&#31639;&#23545;&#20063;&#19981;&#31639;&#23545;&#12290;&#22240;&#20026;&#23427;&#31526;&#21512;list&#31867;&#22411;&#25968;&#25454;&#32467;&#26500;&#30340;&#19968;&#20123;&#29305;&#28857;&#65292;&#27604;&#22914;&#21487;&#20197;&#28155;&#21152;&#20803;&#32032;&#65292;&#23454;&#29616;&#33258;&#22686;&#38271;&#65292;&#19981;&#20250;&#20687;&#25968;&#32452;&#31867;&#22411;&#30340;&#25968;&#25454;&#32467;&#26500;&#65292;&#21463;&#21040;&#21021;&#22987;&#35774;&#23450;&#30340;&#25968;&#32452;&#23481;&#37327;&#30340;&#38480;&#21046;&#65292;&#24182;&#19988;&#23427;&#36319;&#25105;&#20204;&#24120;&#35265;&#30340;list&#22411;&#25968;&#25454;&#32467;&#26500;&#20063;&#26159;&#19968;&#26679;&#30340;&#65292;&#20869;&#37096;&#23454;&#29616;&#20351;&#29992;&#20102;&#19968;&#20010;&#38142;&#34920;&#12290;&#10;&#10;&#37027;&#20040;&#23427;&#36319;&#25105;&#20204;&#24120;&#35265;&#30340;&#38142;&#34920;&#23454;&#29616;&#30340;list&#26377;&#20160;&#20040;&#19981;&#21516;&#21602;&#65311;&#19981;&#21516;&#28857;&#23601;&#22312;&#20110;&#23427;&#30340;&#33410;&#28857;&#65292;&#23427;&#30340;&#33410;&#28857;&#19981;&#20687;&#25105;&#20204;&#24120;&#35265;&#30340;list&#30340;&#33410;&#28857;&#65292;&#21482;&#33021;&#23384;&#25918;&#19968;&#20010;&#20803;&#32032;&#65292;ngx_list_t&#30340;&#33410;&#28857;&#23454;&#38469;&#19978;&#26159;&#19968;&#20010;&#22266;&#23450;&#22823;&#23567;&#30340;&#25968;&#32452;&#12290;&#10;&#10;&#22312;&#21021;&#22987;&#21270;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#38656;&#35201;&#35774;&#23450;&#20803;&#32032;&#38656;&#35201;&#21344;&#29992;&#30340;&#31354;&#38388;&#22823;&#23567;&#65292;&#27599;&#20010;&#33410;&#28857;&#25968;&#32452;&#30340;&#23481;&#37327;&#22823;&#23567;&#12290;&#22312;&#28155;&#21152;&#20803;&#32032;&#21040;&#36825;&#20010;list&#37324;&#38754;&#30340;&#26102;&#20505;&#65292;&#20250;&#22312;&#26368;&#23614;&#37096;&#30340;&#33410;&#28857;&#37324;&#30340;&#25968;&#32452;&#19978;&#28155;&#21152;&#20803;&#32032;&#65292;&#22914;&#26524;&#36825;&#20010;&#33410;&#28857;&#30340;&#25968;&#32452;&#23384;&#28385;&#20102;&#65292;&#23601;&#20877;&#22686;&#21152;&#19968;&#20010;&#26032;&#30340;&#33410;&#28857;&#21040;&#36825;&#20010;list&#37324;&#38754;&#21435;&#12290;&#10;&#10;&#22909;&#20102;&#65292;&#30475;&#21040;&#36825;&#37324;&#65292;&#22823;&#23478;&#24212;&#35813;&#22522;&#26412;&#19978;&#26126;&#30333;&#36825;&#20010;list&#32467;&#26500;&#20102;&#21543;&#65311;&#36824;&#19981;&#26126;&#30333;&#20063;&#27809;&#26377;&#20851;&#31995;&#65292;&#19979;&#38754;&#25105;&#20204;&#26469;&#20855;&#20307;&#30475;&#19968;&#19979;&#23427;&#30340;&#23450;&#20041;&#65292;&#36825;&#20123;&#23450;&#20041;&#21644;&#30456;&#20851;&#30340;&#25805;&#20316;&#20989;&#25968;&#23450;&#20041;&#22312;src/core/ngx_list.h|c&#25991;&#20214;&#20013;&#12290;&#10;&#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        ngx_list_part_t  *last;&#10;        ngx_list_part_t   part;&#10;        size_t            size;&#10;        ngx_uint_t        nalloc;&#10;        ngx_pool_t       *pool;&#10;    &#125; ngx_list_t;&#10;&#10;:last: &#25351;&#21521;&#35813;&#38142;&#34920;&#30340;&#26368;&#21518;&#19968;&#20010;&#33410;&#28857;&#12290;&#10;:part: &#35813;&#38142;&#34920;&#30340;&#39318;&#20010;&#23384;&#25918;&#20855;&#20307;&#20803;&#32032;&#30340;&#33410;&#28857;&#12290;&#10;:size: &#38142;&#34920;&#20013;&#23384;&#25918;&#30340;&#20855;&#20307;&#20803;&#32032;&#25152;&#38656;&#20869;&#23384;&#22823;&#23567;&#12290;&#10;:nalloc: &#27599;&#20010;&#33410;&#28857;&#25152;&#21547;&#30340;&#22266;&#23450;&#22823;&#23567;&#30340;&#25968;&#32452;&#30340;&#23481;&#37327;&#12290;&#10;:pool: &#35813;list&#20351;&#29992;&#30340;&#20998;&#37197;&#20869;&#23384;&#30340;pool&#12290;&#10;&#10;&#22909;&#65292;&#25105;&#20204;&#22312;&#30475;&#19968;&#19979;&#27599;&#20010;&#33410;&#28857;&#30340;&#23450;&#20041;&#12290;&#10;&#10;.. code:: c&#10;&#10;    typedef struct ngx_list_part_s  ngx_list_part_t;&#10;    struct ngx_list_part_s &#123;&#10;        void             *elts;&#10;        ngx_uint_t        nelts;&#10;        ngx_list_part_t  *next;&#10;    &#125;;&#10;&#10;&#10;:elts: &#33410;&#28857;&#20013;&#23384;&#25918;&#20855;&#20307;&#20803;&#32032;&#30340;&#20869;&#23384;&#30340;&#24320;&#22987;&#22320;&#22336;&#12290;&#10;&#10;:nelts: &#33410;&#28857;&#20013;&#24050;&#26377;&#20803;&#32032;&#20010;&#25968;&#12290;&#36825;&#20010;&#20540;&#26159;&#19981;&#33021;&#22823;&#20110;&#38142;&#34920;&#22836;&#33410;&#28857;ngx_list_t&#31867;&#22411;&#20013;&#30340;nalloc&#23383;&#27573;&#30340;&#12290;&#10;&#10;:next: &#25351;&#21521;&#19979;&#19968;&#20010;&#33410;&#28857;&#12290;&#10;&#10;&#10;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#25552;&#20379;&#30340;&#19968;&#20010;&#25805;&#20316;&#30340;&#20989;&#25968;&#12290;&#10;&#10;.. code:: c&#10;&#10;    ngx_list_t *ngx_list_create(ngx_pool_t *pool, ngx_uint_t n, size_t size);&#10;&#10;&#35813;&#20989;&#25968;&#21019;&#24314;&#19968;&#20010;ngx_list_t&#31867;&#22411;&#30340;&#23545;&#35937;,&#24182;&#23545;&#35813;list&#30340;&#31532;&#19968;&#20010;&#33410;&#28857;&#20998;&#37197;&#23384;&#25918;&#20803;&#32032;&#30340;&#20869;&#23384;&#31354;&#38388;&#12290;&#10;&#10;:pool: &#20998;&#37197;&#20869;&#23384;&#20351;&#29992;&#30340;pool&#12290;&#10;&#10;:n: &#27599;&#20010;&#33410;&#28857;&#22266;&#23450;&#38271;&#24230;&#30340;&#25968;&#32452;&#30340;&#38271;&#24230;&#12290;&#10;&#10;:size: &#23384;&#25918;&#30340;&#20855;&#20307;&#20803;&#32032;&#30340;&#20010;&#25968;&#12290;&#10;&#10;:&#36820;&#22238;&#20540;: &#25104;&#21151;&#36820;&#22238;&#25351;&#21521;&#21019;&#24314;&#30340;ngx_list_t&#23545;&#35937;&#30340;&#25351;&#38024;&#65292;&#22833;&#36133;&#36820;&#22238;NULL&#12290;&#10;&#10;.. code:: c&#10;&#10;    void *ngx_list_push(ngx_list_t *list);&#10;&#10;&#35813;&#20989;&#25968;&#22312;&#32473;&#23450;&#30340;list&#30340;&#23614;&#37096;&#36861;&#21152;&#19968;&#20010;&#20803;&#32032;&#65292;&#24182;&#36820;&#22238;&#25351;&#21521;&#26032;&#20803;&#32032;&#23384;&#25918;&#31354;&#38388;&#30340;&#25351;&#38024;&#12290;&#22914;&#26524;&#36861;&#21152;&#22833;&#36133;&#65292;&#21017;&#36820;&#22238;NULL&#12290;&#10;&#10;.. code:: c&#10;&#10;    static ngx_inline ngx_int_t&#10;    ngx_list_init(ngx_list_t *list, ngx_pool_t *pool, ngx_uint_t n, size_t size);&#10;&#10;&#35813;&#20989;&#25968;&#26159;&#29992;&#20110;ngx_list_t&#31867;&#22411;&#30340;&#23545;&#35937;&#24050;&#32463;&#23384;&#22312;&#65292;&#20294;&#26159;&#20854;&#31532;&#19968;&#20010;&#33410;&#28857;&#23384;&#25918;&#20803;&#32032;&#30340;&#20869;&#23384;&#31354;&#38388;&#36824;&#26410;&#20998;&#37197;&#30340;&#24773;&#20917;&#19979;&#65292;&#21487;&#20197;&#35843;&#29992;&#27492;&#20989;&#25968;&#26469;&#32473;&#36825;&#20010;list&#30340;&#39318;&#33410;&#28857;&#26469;&#20998;&#37197;&#23384;&#25918;&#20803;&#32032;&#30340;&#20869;&#23384;&#31354;&#38388;&#12290;&#10;&#10;&#37027;&#20040;&#20160;&#20040;&#26102;&#20505;&#20250;&#20986;&#29616;&#24050;&#32463;&#26377;&#20102;ngx_list_t&#31867;&#22411;&#30340;&#23545;&#35937;&#65292;&#32780;&#20854;&#39318;&#33410;&#28857;&#23384;&#25918;&#20803;&#32032;&#30340;&#20869;&#23384;&#23578;&#26410;&#20998;&#37197;&#30340;&#24773;&#20917;&#21602;&#65311;&#37027;&#23601;&#26159;&#36825;&#20010;ngx_list_t&#31867;&#22411;&#30340;&#21464;&#37327;&#24182;&#19981;&#26159;&#36890;&#36807;&#35843;&#29992;ngx_list_create&#20989;&#25968;&#21019;&#24314;&#30340;&#12290;&#20363;&#22914;&#65306;&#22914;&#26524;&#26576;&#20010;&#32467;&#26500;&#20307;&#30340;&#19968;&#20010;&#25104;&#21592;&#21464;&#37327;&#26159;ngx_list_t&#31867;&#22411;&#30340;&#65292;&#37027;&#20040;&#24403;&#36825;&#20010;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;&#23545;&#35937;&#34987;&#21019;&#24314;&#20986;&#26469;&#30340;&#26102;&#20505;&#65292;&#36825;&#20010;&#25104;&#21592;&#21464;&#37327;&#20063;&#34987;&#21019;&#24314;&#20986;&#26469;&#20102;&#65292;&#20294;&#26159;&#23427;&#30340;&#39318;&#33410;&#28857;&#30340;&#23384;&#25918;&#20803;&#32032;&#30340;&#20869;&#23384;&#24182;&#26410;&#34987;&#20998;&#37197;&#12290;&#10;&#10;&#24635;&#20043;&#65292;&#22914;&#26524;&#36825;&#20010;ngx_list_t&#31867;&#22411;&#30340;&#21464;&#37327;&#65292;&#22914;&#26524;&#19981;&#26159;&#20320;&#36890;&#36807;&#35843;&#29992;&#20989;&#25968;ngx_list_create&#21019;&#24314;&#30340;&#65292;&#37027;&#20040;&#23601;&#24517;&#39035;&#35843;&#29992;&#27492;&#20989;&#25968;&#21435;&#21021;&#22987;&#21270;&#65292;&#21542;&#21017;&#65292;&#20320;&#24448;&#36825;&#20010;list&#37324;&#36861;&#21152;&#20803;&#32032;&#23601;&#21487;&#33021;&#24341;&#21457;&#19981;&#21487;&#39044;&#30693;&#30340;&#34892;&#20026;&#65292;&#20134;&#25110;&#31243;&#24207;&#20250;&#23849;&#28291;!&#10;&#10;&#10;&#10;&#10;&#10;ngx_queue_t(100%)&#10;~~~~~~~~~~~~~~~~~~~&#10;&#10;&#10;ngx_queue_t&#26159;nginx&#20013;&#30340;&#21452;&#21521;&#38142;&#34920;&#65292;&#22312;nginx&#28304;&#30721;&#30446;&#24405;src/core&#19979;&#38754;&#30340;ngx_queue.h|c&#37324;&#38754;&#12290;&#23427;&#30340;&#21407;&#22411;&#22914;&#19979;&#65306;&#10;&#10;.. code:: c&#10;&#10;    typedef struct ngx_queue_s ngx_queue_t;&#10;&#10;    struct ngx_queue_s &#123;&#10;        ngx_queue_t  *prev;&#10;        ngx_queue_t  *next;&#10;    &#125;;&#10;&#10;&#19981;&#21516;&#20110;&#25945;&#31185;&#20070;&#20013;&#23558;&#38142;&#34920;&#33410;&#28857;&#30340;&#25968;&#25454;&#25104;&#21592;&#22768;&#26126;&#22312;&#38142;&#34920;&#33410;&#28857;&#30340;&#32467;&#26500;&#20307;&#20013;&#65292;ngx_queue_t&#21482;&#26159;&#22768;&#26126;&#20102;&#21069;&#21521;&#21644;&#21518;&#21521;&#25351;&#38024;&#12290;&#22312;&#20351;&#29992;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#39318;&#20808;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;&#21736;&#20853;&#33410;&#28857;(&#23545;&#20110;&#21518;&#32493;&#20855;&#20307;&#23384;&#25918;&#25968;&#25454;&#30340;&#33410;&#28857;&#65292;&#25105;&#20204;&#31216;&#20043;&#20026;&#25968;&#25454;&#33410;&#28857;)&#65292;&#27604;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_queue_t free;&#10;&#10;&#25509;&#19979;&#26469;&#38656;&#35201;&#36827;&#34892;&#21021;&#22987;&#21270;&#65292;&#36890;&#36807;&#23439;ngx_queue_init()&#26469;&#23454;&#29616;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_queue_init(&#38;free);&#10;&#10;ngx_queue_init()&#30340;&#23439;&#23450;&#20041;&#22914;&#19979;&#65306;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_queue_init(q)     \&#10;        (q)-&#62;prev = q;            \&#10;        (q)-&#62;next = q;&#10;&#10;&#21487;&#35265;&#21021;&#22987;&#30340;&#26102;&#20505;&#21736;&#20853;&#33410;&#28857;&#30340; prev &#21644; next &#37117;&#25351;&#21521;&#33258;&#24049;&#65292;&#22240;&#27492;&#20854;&#23454;&#26159;&#19968;&#20010;&#31354;&#38142;&#34920;&#12290;ngx_queue_empty()&#21487;&#20197;&#29992;&#26469;&#21028;&#26029;&#19968;&#20010;&#38142;&#34920;&#26159;&#21542;&#20026;&#31354;&#65292;&#20854;&#23454;&#29616;&#20063;&#24456;&#31616;&#21333;&#65292;&#23601;&#26159;&#65306;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_queue_empty(h)    \&#10;        (h == (h)-&#62;prev)&#10;&#10;&#37027;&#20040;&#22914;&#20309;&#22768;&#26126;&#19968;&#20010;&#20855;&#26377;&#25968;&#25454;&#20803;&#32032;&#30340;&#38142;&#34920;&#33410;&#28857;&#21602;&#65311;&#21482;&#35201;&#22312;&#30456;&#24212;&#30340;&#32467;&#26500;&#20307;&#20013;&#21152;&#19978;&#19968;&#20010; ngx_queue_t &#30340;&#25104;&#21592;&#23601;&#34892;&#20102;&#12290;&#27604;&#22914;ngx_http_upstream_keepalive_module&#20013;&#30340;ngx_http_upstream_keepalive_cache_t&#65306;&#10;&#10;.. code:: c&#10;&#10;    typedef struct &#123;&#10;        ngx_http_upstream_keepalive_srv_conf_t  *conf;&#10;&#10;        ngx_queue_t                        queue;&#10;        ngx_connection_t                  *connection;&#10;&#10;        socklen_t                          socklen;&#10;        u_char                             sockaddr[NGX_SOCKADDRLEN];&#10;    &#125; ngx_http_upstream_keepalive_cache_t;&#10;&#10;&#23545;&#20110;&#27599;&#19968;&#20010;&#36825;&#26679;&#30340;&#25968;&#25454;&#33410;&#28857;&#65292;&#21487;&#20197;&#36890;&#36807;ngx_queue_insert_head()&#26469;&#28155;&#21152;&#21040;&#38142;&#34920;&#20013;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#26159;&#21736;&#20853;&#33410;&#28857;&#65292;&#31532;&#20108;&#20010;&#21442;&#25968;&#26159;&#25968;&#25454;&#33410;&#28857;&#65292;&#27604;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_http_upstream_keepalive_cache_t cache;&#10;    ngx_queue_insert_head(&#38;free, &#38;cache.queue);&#10;&#10;&#30456;&#24212;&#30340;&#20960;&#20010;&#23439;&#23450;&#20041;&#22914;&#19979;&#65306;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_queue_insert_head(h, x)                         \&#10;        (x)-&#62;next = (h)-&#62;next;                                  \&#10;        (x)-&#62;next-&#62;prev = x;                                    \&#10;        (x)-&#62;prev = h;                                          \&#10;        (h)-&#62;next = x&#10;&#10;    #define ngx_queue_insert_after   ngx_queue_insert_head&#10;&#10;    #define ngx_queue_insert_tail(h, x)                          \&#10;        (x)-&#62;prev = (h)-&#62;prev;                                   \&#10;        (x)-&#62;prev-&#62;next = x;                                     \&#10;        (x)-&#62;next = h;                                           \&#10;        (h)-&#62;prev = x&#10;&#10;ngx_queue_insert_head()&#21644;ngx_queue_insert_after()&#37117;&#26159;&#24448;&#22836;&#37096;&#28155;&#21152;&#33410;&#28857;&#65292;ngx_queue_insert_tail()&#26159;&#24448;&#23614;&#37096;&#28155;&#21152;&#33410;&#28857;&#12290;&#20174;&#20195;&#30721;&#21487;&#20197;&#30475;&#20986;&#21736;&#20853;&#33410;&#28857;&#30340; prev &#25351;&#21521;&#38142;&#34920;&#30340;&#23614;&#25968;&#25454;&#33410;&#28857;&#65292;next &#25351;&#21521;&#38142;&#34920;&#30340;&#22836;&#25968;&#25454;&#33410;&#28857;&#12290;&#21478;&#22806;ngx_queue_head()&#21644;ngx_queue_last()&#36825;&#20004;&#20010;&#23439;&#20998;&#21035;&#21487;&#20197;&#24471;&#21040;&#22836;&#33410;&#28857;&#21644;&#23614;&#33410;&#28857;&#12290;&#10;&#10;&#37027;&#20551;&#22914;&#29616;&#22312;&#26377;&#19968;&#20010;ngx_queue_t *q &#25351;&#21521;&#30340;&#26159;&#38142;&#34920;&#20013;&#30340;&#25968;&#25454;&#33410;&#28857;&#30340;queue&#25104;&#21592;&#65292;&#22914;&#20309;&#24471;&#21040;ngx_http_upstream_keepalive_cache_t&#30340;&#25968;&#25454;&#21602;&#65311; nginx&#25552;&#20379;&#20102;ngx_queue_data()&#23439;&#26469;&#24471;&#21040;ngx_http_upstream_keepalive_cache_t&#30340;&#25351;&#38024;&#65292;&#20363;&#22914;&#65306;&#10;&#10;.. code:: c&#10;&#10;    ngx_http_upstream_keepalive_cache_t *cache = ngx_queue_data(q,&#10;                                                     ngx_http_upstream_keepalive_cache_t,&#10;                                                     queue);&#10;&#10;&#10;&#20063;&#35768;&#24744;&#24050;&#32463;&#21487;&#20197;&#29468;&#21040;ngx_queue_data&#26159;&#36890;&#36807;&#22320;&#22336;&#30456;&#20943;&#26469;&#24471;&#21040;&#30340;&#65306;&#10;&#10;.. code:: c&#10;&#10;    #define ngx_queue_data(q, type, link)                        \&#10;        (type *) ((u_char *) q - offsetof(type, link))&#10;&#10;&#10;&#21478;&#22806;nginx&#20063;&#25552;&#20379;&#20102;ngx_queue_remove()&#23439;&#26469;&#20174;&#38142;&#34920;&#20013;&#21024;&#38500;&#19968;&#20010;&#25968;&#25454;&#33410;&#28857;&#65292;&#20197;&#21450;ngx_queue_add()&#29992;&#26469;&#23558;&#19968;&#20010;&#38142;&#34920;&#28155;&#21152;&#21040;&#21478;&#19968;&#20010;&#38142;&#34920;&#12290;&#10;&#10;&#10;&#10;&#10;&#10;nginx&#30340;&#37197;&#32622;&#31995;&#32479;(100%)&#10;------------------------&#10;&#10;nginx&#30340;&#37197;&#32622;&#31995;&#32479;&#30001;&#19968;&#20010;&#20027;&#37197;&#32622;&#25991;&#20214;&#21644;&#20854;&#20182;&#19968;&#20123;&#36741;&#21161;&#30340;&#37197;&#32622;&#25991;&#20214;&#26500;&#25104;&#12290;&#36825;&#20123;&#37197;&#32622;&#25991;&#20214;&#22343;&#26159;&#32431;&#25991;&#26412;&#25991;&#20214;&#65292;&#20840;&#37096;&#20301;&#20110;nginx&#23433;&#35013;&#30446;&#24405;&#19979;&#30340;conf&#30446;&#24405;&#19979;&#12290;&#10;&#10;&#37197;&#32622;&#25991;&#20214;&#20013;&#20197;#&#24320;&#22987;&#30340;&#34892;&#65292;&#25110;&#32773;&#26159;&#21069;&#38754;&#26377;&#33509;&#24178;&#31354;&#26684;&#25110;&#32773;TAB&#65292;&#28982;&#21518;&#20877;&#36319;#&#30340;&#34892;&#65292;&#37117;&#34987;&#35748;&#20026;&#26159;&#27880;&#37322;&#65292;&#20063;&#23601;&#26159;&#21482;&#23545;&#32534;&#36753;&#26597;&#30475;&#25991;&#20214;&#30340;&#29992;&#25143;&#26377;&#24847;&#20041;&#65292;&#31243;&#24207;&#22312;&#35835;&#21462;&#36825;&#20123;&#27880;&#37322;&#34892;&#30340;&#26102;&#20505;&#65292;&#20854;&#23454;&#38469;&#30340;&#20869;&#23481;&#26159;&#34987;&#24573;&#30053;&#30340;&#12290;&#10;&#10;&#30001;&#20110;&#38500;&#20027;&#37197;&#32622;&#25991;&#20214;nginx.conf&#20197;&#22806;&#30340;&#25991;&#20214;&#37117;&#26159;&#22312;&#26576;&#20123;&#24773;&#20917;&#19979;&#25165;&#20351;&#29992;&#30340;&#65292;&#32780;&#21482;&#26377;&#20027;&#37197;&#32622;&#25991;&#20214;&#26159;&#22312;&#20219;&#20309;&#24773;&#20917;&#19979;&#37117;&#34987;&#20351;&#29992;&#30340;&#12290;&#25152;&#20197;&#22312;&#36825;&#37324;&#25105;&#20204;&#23601;&#20197;&#20027;&#37197;&#32622;&#25991;&#20214;&#20026;&#20363;&#65292;&#26469;&#35299;&#37322;nginx&#30340;&#37197;&#32622;&#31995;&#32479;&#12290;&#10;&#10;&#22312;nginx.conf&#20013;&#65292;&#21253;&#21547;&#33509;&#24178;&#37197;&#32622;&#39033;&#12290;&#27599;&#20010;&#37197;&#32622;&#39033;&#30001;&#37197;&#32622;&#25351;&#20196;&#21644;&#25351;&#20196;&#21442;&#25968;2&#20010;&#37096;&#20998;&#26500;&#25104;&#12290;&#25351;&#20196;&#21442;&#25968;&#20063;&#23601;&#26159;&#37197;&#32622;&#25351;&#20196;&#23545;&#24212;&#30340;&#37197;&#32622;&#20540;&#12290;&#10;&#10;&#10;&#10;&#10;&#10;&#25351;&#20196;&#27010;&#36848;&#10;~~~~~~~~~~~~~~~~~~~~&#10;&#37197;&#32622;&#25351;&#20196;&#26159;&#19968;&#20010;&#23383;&#31526;&#20018;&#65292;&#21487;&#20197;&#29992;&#21333;&#24341;&#21495;&#25110;&#32773;&#21452;&#24341;&#21495;&#25324;&#36215;&#26469;&#65292;&#20063;&#21487;&#20197;&#19981;&#25324;&#12290;&#20294;&#26159;&#22914;&#26524;&#37197;&#32622;&#25351;&#20196;&#21253;&#21547;&#31354;&#26684;&#65292;&#19968;&#23450;&#35201;&#24341;&#36215;&#26469;&#12290;&#10;&#10;&#10;&#25351;&#20196;&#21442;&#25968;&#10;~~~~~~~~~~~~~~~~~~~~&#10;&#10;&#25351;&#20196;&#30340;&#21442;&#25968;&#20351;&#29992;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;&#31354;&#26684;&#25110;&#32773;TAB&#23383;&#31526;&#19982;&#25351;&#20196;&#20998;&#24320;&#12290;&#25351;&#20196;&#30340;&#21442;&#25968;&#26377;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;TOKEN&#20018;&#32452;&#25104;&#12290;TOKEN&#20018;&#20043;&#38388;&#30001;&#31354;&#26684;&#25110;&#32773;TAB&#38190;&#20998;&#38548;&#12290;&#10;&#10;TOKEN&#20018;&#20998;&#20026;&#31616;&#21333;&#23383;&#31526;&#20018;&#25110;&#32773;&#26159;&#22797;&#21512;&#37197;&#32622;&#22359;&#12290;&#22797;&#21512;&#37197;&#32622;&#22359;&#21363;&#26159;&#30001;&#22823;&#25324;&#21495;&#25324;&#36215;&#26469;&#30340;&#19968;&#22534;&#20869;&#23481;&#12290;&#19968;&#20010;&#22797;&#21512;&#37197;&#32622;&#22359;&#20013;&#21487;&#33021;&#21253;&#21547;&#33509;&#24178;&#20854;&#20182;&#30340;&#37197;&#32622;&#25351;&#20196;&#12290;&#10;&#10;&#22914;&#26524;&#19968;&#20010;&#37197;&#32622;&#25351;&#20196;&#30340;&#21442;&#25968;&#20840;&#37096;&#30001;&#31616;&#21333;&#23383;&#31526;&#20018;&#26500;&#25104;&#65292;&#20063;&#23601;&#26159;&#19981;&#21253;&#21547;&#22797;&#21512;&#37197;&#32622;&#22359;&#65292;&#37027;&#20040;&#25105;&#20204;&#23601;&#35828;&#36825;&#20010;&#37197;&#32622;&#25351;&#20196;&#26159;&#19968;&#20010;&#31616;&#21333;&#37197;&#32622;&#39033;&#65292;&#21542;&#21017;&#31216;&#20043;&#20026;&#22797;&#26434;&#37197;&#32622;&#39033;&#12290;&#20363;&#22914;&#19979;&#38754;&#36825;&#20010;&#26159;&#19968;&#20010;&#31616;&#21333;&#37197;&#32622;&#39033;&#65306;&#10;&#10;.. code::&#10;&#10;    error_page   500 502 503 504  /50x.html;&#10;&#10;&#10;&#23545;&#20110;&#31616;&#21333;&#37197;&#32622;&#65292;&#37197;&#32622;&#39033;&#30340;&#32467;&#23614;&#20351;&#29992;&#20998;&#21495;&#32467;&#26463;&#12290;&#23545;&#20110;&#22797;&#26434;&#37197;&#32622;&#39033;&#65292;&#21253;&#21547;&#22810;&#20010;TOKEN&#20018;&#30340;&#65292;&#19968;&#33324;&#37117;&#26159;&#31616;&#21333;TOKEN&#20018;&#25918;&#22312;&#21069;&#38754;&#65292;&#22797;&#21512;&#37197;&#32622;&#22359;&#19968;&#33324;&#20301;&#20110;&#26368;&#21518;&#65292;&#32780;&#19988;&#20854;&#32467;&#23614;&#65292;&#24182;&#19981;&#38656;&#35201;&#20877;&#28155;&#21152;&#20998;&#21495;&#12290;&#20363;&#22914;&#19979;&#38754;&#36825;&#20010;&#22797;&#26434;&#37197;&#32622;&#39033;&#65306;&#10;&#10;.. code::&#10;&#10;        location / &#123;&#10;            root   /home/jizhao/nginx-book/build/html;&#10;            index  index.html index.htm;&#10;        &#125;&#10;&#10;&#10;&#10;&#25351;&#20196;&#19978;&#19979;&#25991;&#10;~~~~~~~~~~~~~~~~~~~~~~~&#10;&#10;nginx.conf&#20013;&#30340;&#37197;&#32622;&#20449;&#24687;&#65292;&#26681;&#25454;&#20854;&#36923;&#36753;&#19978;&#30340;&#24847;&#20041;&#65292;&#23545;&#23427;&#20204;&#36827;&#34892;&#20102;&#20998;&#31867;&#65292;&#20063;&#23601;&#26159;&#20998;&#25104;&#20102;&#22810;&#20010;&#20316;&#29992;&#22495;&#65292;&#25110;&#32773;&#31216;&#20043;&#20026;&#37197;&#32622;&#25351;&#20196;&#19978;&#19979;&#25991;&#12290;&#19981;&#21516;&#30340;&#20316;&#29992;&#22495;&#21547;&#26377;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;&#37197;&#32622;&#39033;&#12290;&#10;&#10;&#24403;&#21069;nginx&#25903;&#25345;&#30340;&#20960;&#20010;&#25351;&#20196;&#19978;&#19979;&#25991;&#65306;&#10;&#10;:main: nginx&#22312;&#36816;&#34892;&#26102;&#19982;&#20855;&#20307;&#19994;&#21153;&#21151;&#33021;&#65288;&#27604;&#22914;http&#26381;&#21153;&#25110;&#32773;email&#26381;&#21153;&#20195;&#29702;&#65289;&#26080;&#20851;&#30340;&#19968;&#20123;&#21442;&#25968;&#65292;&#27604;&#22914;&#24037;&#20316;&#36827;&#31243;&#25968;&#65292;&#36816;&#34892;&#30340;&#36523;&#20221;&#31561;&#12290;&#10;:http: &#19982;&#25552;&#20379;http&#26381;&#21153;&#30456;&#20851;&#30340;&#19968;&#20123;&#37197;&#32622;&#21442;&#25968;&#12290;&#20363;&#22914;&#65306;&#26159;&#21542;&#20351;&#29992;keepalive&#21834;&#65292;&#26159;&#21542;&#20351;&#29992;gzip&#36827;&#34892;&#21387;&#32553;&#31561;&#12290;&#10;:server: http&#26381;&#21153;&#19978;&#25903;&#25345;&#33509;&#24178;&#34394;&#25311;&#20027;&#26426;&#12290;&#27599;&#20010;&#34394;&#25311;&#20027;&#26426;&#19968;&#20010;&#23545;&#24212;&#30340;server&#37197;&#32622;&#39033;&#65292;&#37197;&#32622;&#39033;&#37324;&#38754;&#21253;&#21547;&#35813;&#34394;&#25311;&#20027;&#26426;&#30456;&#20851;&#30340;&#37197;&#32622;&#12290;&#22312;&#25552;&#20379;mail&#26381;&#21153;&#30340;&#20195;&#29702;&#26102;&#65292;&#20063;&#21487;&#20197;&#24314;&#31435;&#33509;&#24178;server.&#27599;&#20010;server&#36890;&#36807;&#30417;&#21548;&#30340;&#22320;&#22336;&#26469;&#21306;&#20998;&#12290;&#10;:location: http&#26381;&#21153;&#20013;&#65292;&#26576;&#20123;&#29305;&#23450;&#30340;URL&#23545;&#24212;&#30340;&#19968;&#31995;&#21015;&#37197;&#32622;&#39033;&#12290;&#10;:mail: &#23454;&#29616;email&#30456;&#20851;&#30340;SMTP/IMAP/POP3&#20195;&#29702;&#26102;&#65292;&#20849;&#20139;&#30340;&#19968;&#20123;&#37197;&#32622;&#39033;&#65288;&#22240;&#20026;&#21487;&#33021;&#23454;&#29616;&#22810;&#20010;&#20195;&#29702;&#65292;&#24037;&#20316;&#22312;&#22810;&#20010;&#30417;&#21548;&#22320;&#22336;&#19978;&#65289;&#12290;&#10;&#10;&#25351;&#20196;&#19978;&#19979;&#25991;&#65292;&#21487;&#33021;&#26377;&#21253;&#21547;&#30340;&#24773;&#20917;&#20986;&#29616;&#12290;&#20363;&#22914;&#65306;&#36890;&#24120;http&#19978;&#19979;&#25991;&#21644;mail&#19978;&#19979;&#25991;&#19968;&#23450;&#26159;&#20986;&#29616;&#22312;main&#19978;&#19979;&#25991;&#37324;&#30340;&#12290;&#22312;&#19968;&#20010;&#19978;&#19979;&#25991;&#37324;&#65292;&#21487;&#33021;&#21253;&#21547;&#21478;&#22806;&#19968;&#31181;&#31867;&#22411;&#30340;&#19978;&#19979;&#25991;&#22810;&#27425;&#12290;&#20363;&#22914;&#65306;&#22914;&#26524;http&#26381;&#21153;&#65292;&#25903;&#25345;&#20102;&#22810;&#20010;&#34394;&#25311;&#20027;&#26426;&#65292;&#37027;&#20040;&#22312;http&#19978;&#19979;&#25991;&#37324;&#65292;&#23601;&#20250;&#20986;&#29616;&#22810;&#20010;server&#19978;&#19979;&#25991;&#12290;&#10;&#10;&#25105;&#20204;&#26469;&#30475;&#19968;&#20010;&#31034;&#20363;&#37197;&#32622;&#65306;&#10;&#10;.. code::&#10;&#10;    user  nobody;&#10;    worker_processes  1;&#10;    error_log  logs/error.log  info;&#10;&#10;    events &#123;&#10;        worker_connections  1024;&#10;    &#125;&#10;&#10;    http &#123;  &#10;        server &#123;  &#10;            listen          80;  &#10;            server_name     www.linuxidc.com;  &#10;            access_log      logs/linuxidc.access.log main;  &#10;            location / &#123;  &#10;                index index.html;  &#10;                root  /var/www/linuxidc.com/htdocs;  &#10;            &#125;  &#10;        &#125;  &#10;&#10;        server &#123;  &#10;            listen          80;  &#10;            server_name     www.Androidj.com;  &#10;            access_log      logs/androidj.access.log main;  &#10;            location / &#123;  &#10;                index index.html;  &#10;                root  /var/www/androidj.com/htdocs;  &#10;            &#125;  &#10;        &#125;  &#10;    &#125;&#10;      &#10;    mail &#123;&#10;        auth_http  127.0.0.1:80/auth.php;&#10;        pop3_capabilities  &#34;TOP&#34;  &#34;USER&#34;;&#10;        imap_capabilities  &#34;IMAP4rev1&#34;  &#34;UIDPLUS&#34;;&#10;       &#10;        server &#123;&#10;            listen     110;&#10;            protocol   pop3;&#10;            proxy      on;&#10;        &#125;&#10;        server &#123;&#10;            listen      25;&#10;            protocol    smtp;&#10;            proxy       on;&#10;            smtp_auth   login plain;&#10;            xclient     off;&#10;        &#125;&#10;    &#125;&#10;&#10;&#10;&#22312;&#36825;&#20010;&#37197;&#32622;&#20013;&#65292;&#19978;&#38754;&#25552;&#21040;&#20010;&#20116;&#31181;&#37197;&#32622;&#25351;&#20196;&#19978;&#19979;&#25991;&#37117;&#23384;&#22312;&#12290;&#10;&#10;&#23384;&#22312;&#20110;main&#19978;&#19979;&#25991;&#20013;&#30340;&#37197;&#32622;&#25351;&#20196;&#22914;&#19979;:&#10;&#10;- user&#10;- worker_processes&#10;- error_log&#10;- events&#10;- http&#10;- mail&#10;&#10;&#23384;&#22312;&#20110;http&#19978;&#19979;&#25991;&#20013;&#30340;&#25351;&#20196;&#22914;&#19979;:&#10;&#10;- server&#10;&#10;&#23384;&#22312;&#20110;mail&#19978;&#19979;&#25991;&#20013;&#30340;&#25351;&#20196;&#22914;&#19979;&#65306;&#10;&#10;- server&#10;- auth_http&#10;- imap_capabilities&#10;&#10;&#23384;&#22312;&#20110;server&#19978;&#19979;&#25991;&#20013;&#30340;&#37197;&#32622;&#25351;&#20196;&#22914;&#19979;&#65306;&#10;&#10;- listen&#10;- server_name&#10;- access_log&#10;- location&#10;- protocol&#10;- proxy&#10;- smtp_auth&#10;- xclient&#10;&#10;&#23384;&#22312;&#20110;location&#19978;&#19979;&#25991;&#20013;&#30340;&#25351;&#20196;&#22914;&#19979;&#65306;&#10;&#10;- index&#10;- root&#10;&#10;&#10;&#24403;&#28982;&#65292;&#36825;&#37324;&#21482;&#26159;&#19968;&#20123;&#31034;&#20363;&#12290;&#20855;&#20307;&#26377;&#21738;&#20123;&#37197;&#32622;&#25351;&#20196;&#65292;&#20197;&#21450;&#36825;&#20123;&#37197;&#32622;&#25351;&#20196;&#21487;&#20197;&#20986;&#29616;&#22312;&#20160;&#20040;&#26679;&#30340;&#19978;&#19979;&#25991;&#20013;&#65292;&#38656;&#35201;&#21442;&#32771;nginx&#30340;&#20351;&#29992;&#25991;&#26723;&#12290;&#10;&#10;nginx&#30340;&#27169;&#22359;&#21270;&#20307;&#31995;&#32467;&#26500;&#10;---------------------------------&#10;&#10;nginx&#30340;&#20869;&#37096;&#32467;&#26500;&#26159;&#30001;&#26680;&#24515;&#37096;&#20998;&#21644;&#19968;&#31995;&#21015;&#30340;&#21151;&#33021;&#27169;&#22359;&#25152;&#32452;&#25104;&#12290;&#36825;&#26679;&#21010;&#20998;&#26159;&#20026;&#20102;&#20351;&#24471;&#27599;&#20010;&#27169;&#22359;&#30340;&#21151;&#33021;&#30456;&#23545;&#31616;&#21333;&#65292;&#20415;&#20110;&#24320;&#21457;&#65292;&#21516;&#26102;&#20063;&#20415;&#20110;&#23545;&#31995;&#32479;&#36827;&#34892;&#21151;&#33021;&#25193;&#23637;&#12290;&#20026;&#20102;&#20415;&#20110;&#25551;&#36848;&#65292;&#19979;&#25991;&#20013;&#25105;&#20204;&#23558;&#20351;&#29992;nginx core&#26469;&#31216;&#21628;nginx&#30340;&#26680;&#24515;&#21151;&#33021;&#37096;&#20998;&#12290;&#10;&#10;nginx&#25552;&#20379;&#20102;web&#26381;&#21153;&#22120;&#30340;&#22522;&#30784;&#21151;&#33021;&#65292;&#21516;&#26102;&#25552;&#20379;&#20102;web&#26381;&#21153;&#21453;&#21521;&#20195;&#29702;&#65292;email&#26381;&#21153;&#21453;&#21521;&#20195;&#29702;&#21151;&#33021;&#12290;nginx core&#23454;&#29616;&#20102;&#24213;&#23618;&#30340;&#36890;&#35759;&#21327;&#35758;&#65292;&#20026;&#20854;&#20182;&#27169;&#22359;&#21644;nginx&#36827;&#31243;&#26500;&#24314;&#20102;&#22522;&#26412;&#30340;&#36816;&#34892;&#26102;&#29615;&#22659;&#65292;&#24182;&#19988;&#26500;&#24314;&#20102;&#20854;&#20182;&#21508;&#27169;&#22359;&#30340;&#21327;&#20316;&#22522;&#30784;&#12290;&#38500;&#27492;&#20043;&#22806;&#65292;&#25110;&#32773;&#35828;&#22823;&#37096;&#20998;&#19982;&#21327;&#35758;&#30456;&#20851;&#30340;&#65292;&#25110;&#32773;&#24212;&#29992;&#30456;&#20851;&#30340;&#21151;&#33021;&#37117;&#26159;&#22312;&#36825;&#20123;&#27169;&#22359;&#20013;&#25152;&#23454;&#29616;&#30340;&#12290;&#10;&#10;&#10;&#27169;&#22359;&#27010;&#36848;&#10;------------------&#10;&#10;nginx&#23558;&#21508;&#21151;&#33021;&#27169;&#22359;&#32452;&#32455;&#25104;&#19968;&#26465;&#38142;&#65292;&#24403;&#26377;&#35831;&#27714;&#21040;&#36798;&#30340;&#26102;&#20505;&#65292;&#35831;&#27714;&#20381;&#27425;&#32463;&#36807;&#36825;&#26465;&#38142;&#19978;&#30340;&#37096;&#20998;&#25110;&#32773;&#20840;&#37096;&#27169;&#22359;&#65292;&#36827;&#34892;&#22788;&#29702;&#12290;&#27599;&#20010;&#27169;&#22359;&#23454;&#29616;&#29305;&#23450;&#30340;&#21151;&#33021;&#12290;&#20363;&#22914;&#65292;&#23454;&#29616;&#23545;&#35831;&#27714;&#35299;&#21387;&#32553;&#30340;&#27169;&#22359;&#65292;&#23454;&#29616;SSI&#30340;&#27169;&#22359;&#65292;&#23454;&#29616;&#19982;&#19978;&#28216;&#26381;&#21153;&#22120;&#36827;&#34892;&#36890;&#35759;&#30340;&#27169;&#22359;&#65292;&#23454;&#29616;&#19982;FastCGI&#26381;&#21153;&#36827;&#34892;&#36890;&#35759;&#30340;&#27169;&#22359;&#12290;&#10;&#10;&#26377;&#20004;&#20010;&#27169;&#22359;&#27604;&#36739;&#29305;&#27530;&#65292;&#20182;&#20204;&#23621;&#20110;nginx core&#21644;&#21508;&#21151;&#33021;&#27169;&#22359;&#30340;&#20013;&#38388;&#12290;&#36825;&#20004;&#20010;&#27169;&#22359;&#23601;&#26159;http&#27169;&#22359;&#21644;mail&#27169;&#22359;&#12290;&#36825;2&#20010;&#27169;&#22359;&#22312;nginx core&#20043;&#19978;&#23454;&#29616;&#20102;&#21478;&#22806;&#19968;&#23618;&#25277;&#35937;&#65292;&#22788;&#29702;&#19982;HTTP&#21327;&#35758;&#21644;email&#30456;&#20851;&#21327;&#35758;&#65288;SMTP/POP3/IMAP&#65289;&#26377;&#20851;&#30340;&#20107;&#20214;&#65292;&#24182;&#19988;&#30830;&#20445;&#36825;&#20123;&#20107;&#20214;&#33021;&#34987;&#20197;&#27491;&#30830;&#30340;&#39034;&#24207;&#35843;&#29992;&#20854;&#20182;&#30340;&#19968;&#20123;&#21151;&#33021;&#27169;&#22359;&#12290;&#10;&#10;&#30446;&#21069;HTTP&#21327;&#35758;&#26159;&#34987;&#23454;&#29616;&#22312;http&#27169;&#22359;&#20013;&#30340;&#65292;&#20294;&#26159;&#26377;&#21487;&#33021;&#23558;&#26469;&#34987;&#21093;&#31163;&#21040;&#19968;&#20010;&#21333;&#29420;&#30340;&#27169;&#22359;&#20013;&#65292;&#20197;&#25193;&#23637;nginx&#25903;&#25345;SPDY&#21327;&#35758;&#12290;&#10;&#10;&#27169;&#22359;&#30340;&#20998;&#31867;</span><br></pre></td></tr></table></figure></p>
<p>nginx的模块根据其功能基本上可以分为以下几种类型：</p>
<p>:event module: 搭建了独立于操作系统的事件处理机制的框架，及提供了各具体事件的处理。包括ngx_events_module， ngx_event_core_module和ngx_epoll_module等。nginx具体使用何种事件处理模块，这依赖于具体的操作系统和编译选项。</p>
<p>:phase handler: 此类型的模块也被直接称为handler模块。主要负责处理客户端请求并产生待响应内容，比如ngx_http_static_module模块，负责客户端的静态页面请求处理并将对应的磁盘文件准备为响应内容输出。</p>
<p>:output filter: 也称为filter模块，主要是负责对输出的内容进行处理，可以对输出进行修改。例如，可以实现对输出的所有html页面增加预定义的footbar一类的工作，或者对输出的图片的URL进行替换之类的工作。</p>
<p>:upstream: upstream模块实现反向代理的功能，将真正的请求转发到后端服务器上，并从后端服务器上读取响应，发回客户端。upstream模块是一种特殊的handler，只不过响应内容不是真正由自己产生的，而是从后端服务器上读取的。</p>
<p>:load-balancer: 负载均衡模块，实现特定的算法，在众多的后端服务器中，选择一个服务器出来作为某个请求的转发服务器。</p>
<h2 id="nginx的请求处理">nginx的请求处理</h2><p>nginx使用一个多进程模型来对外提供服务，其中一个master进程，多个worker进程。master进程负责管理nginx本身和其他worker进程。</p>
<p>所有实际上的业务处理逻辑都在worker进程。worker进程中有一个函数，执行无限循环，不断处理收到的来自客户端的请求，并进行处理，直到整个nginx服务被停止。</p>
<p>worker进程中，ngx_worker_process_cycle()函数就是这个无限循环的处理函数。在这个函数中，一个请求的简单处理流程如下：</p>
<h1 id=")_操作系统提供的机制（例如epoll,_kqueue等）产生相关的事件。">) 操作系统提供的机制（例如epoll, kqueue等）产生相关的事件。</h1><h1 id=")_接收和处理这些事件，如是接受到数据，则产生更高层的request对象。">) 接收和处理这些事件，如是接受到数据，则产生更高层的request对象。</h1><h1 id=")_处理request的header和body。">) 处理request的header和body。</h1><h1 id=")_产生响应，并发送回客户端。">) 产生响应，并发送回客户端。</h1><h1 id=")_完成request的处理。">) 完成request的处理。</h1><h1 id=")_重新初始化定时器及其他事件。">) 重新初始化定时器及其他事件。</h1><p>请求的处理流程<br><del>~</del><del>~</del><del>~</del><del>~</del><del>~</del><del>~</del>~~</p>
<p>为了让大家更好的了解nginx中请求处理过程，我们以HTTP Request为例，来做一下详细地说明。</p>
<p>从nginx的内部来看，一个HTTP Request的处理过程涉及到以下几个阶段。</p>
<h1 id=")_初始化HTTP_Request（读取来自客户端的数据，生成HTTP_Request对象，该对象含有该请求所有的信息）。">) 初始化HTTP Request（读取来自客户端的数据，生成HTTP Request对象，该对象含有该请求所有的信息）。</h1><h1 id=")_处理请求头。">) 处理请求头。</h1><h1 id=")_处理请求体。">) 处理请求体。</h1><h1 id=")_如果有的话，调用与此请求（URL或者Location）关联的handler。">) 如果有的话，调用与此请求（URL或者Location）关联的handler。</h1><h1 id=")_依次调用各phase_handler进行处理。">) 依次调用各phase handler进行处理。</h1><p>在这里，我们需要了解一下phase handler这个概念。phase字面的意思，就是阶段。所以phase handlers也就好理解了，就是包含若干个处理阶段的一些handler。</p>
<p>在每一个阶段，包含有若干个handler，再处理到某个阶段的时候，依次调用该阶段的handler对HTTP Request进行处理。</p>
<p>通常情况下，一个phase handler对这个request进行处理，并产生一些输出。通常phase handler是与定义在配置文件中的某个location相关联的。</p>
<p>一个phase handler通常执行以下几项任务：</p>
<h1 id=")_获取location配置。">) 获取location配置。</h1><h1 id=")_产生适当的响应。">) 产生适当的响应。</h1><h1 id=")_发送response_header。">) 发送response header。</h1><h1 id=")_发送response_body。">) 发送response body。</h1><p>当nginx读取到一个HTTP Request的header的时候，nginx首先查找与这个请求关联的虚拟主机的配置。如果找到了这个虚拟主机的配置，那么通常情况下，这个HTTP Request将会经过以下几个阶段的处理（phase handlers）：</p>
<p>:NGX_HTTP_POST_READ_PHASE:      读取请求内容阶段<br>:NGX_HTTP_SERVER_REWRITE_PHASE: Server请求地址重写阶段<br>:NGX_HTTP_FIND_CONFIG_PHASE:    配置查找阶段:<br>:NGX_HTTP_REWRITE_PHASE:        Location请求地址重写阶段<br>:NGX_HTTP_POST_REWRITE_PHASE:   请求地址重写提交阶段<br>:NGX_HTTP_PREACCESS_PHASE:      访问权限检查准备阶段<br>:NGX_HTTP_ACCESS_PHASE: 访问权限检查阶段<br>:NGX_HTTP_POST_ACCESS_PHASE:    访问权限检查提交阶段<br>:NGX_HTTP_TRY_FILES_PHASE:      配置项try_files处理阶段<br>:NGX_HTTP_CONTENT_PHASE:        内容产生阶段<br>:NGX_HTTP_LOG_PHASE:    日志模块处理阶段</p>
<p>在内容产生阶段，为了给一个request产生正确的响应，nginx必须把这个request交给一个合适的content handler去处理。如果这个request对应的location在配置文件中被明确指定了一个content handler，那么nginx就可以通过对location的匹配，直接找到这个对应的handler，并把这个request交给这个content handler去处理。这样的配置指令包括像，perl，flv，proxy_pass，mp4等。</p>
<p>如果一个request对应的location并没有直接有配置的content handler，那么nginx依次尝试:</p>
<h1 id=")_如果一个location里面有配置_random_index_on，那么随机选择一个文件，发送给客户端。">) 如果一个location里面有配置  random_index  on，那么随机选择一个文件，发送给客户端。</h1><h1 id=")_如果一个location里面有配置_index指令，那么发送index指令指明的文件，给客户端。">) 如果一个location里面有配置 index指令，那么发送index指令指明的文件，给客户端。</h1><h1 id=")_如果一个location里面有配置_autoindex_on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。">) 如果一个location里面有配置 autoindex  on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。</h1><h1 id=")_如果这个request对应的location上有设置gzip_static_on，那么就查找是否有对应的-gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。">) 如果这个request对应的location上有设置gzip_static on，那么就查找是否有对应的.gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。</h1><h1 id=")_请求的URI如果对应一个静态文件，static_module就发送静态文件的内容到客户端。">) 请求的URI如果对应一个静态文件，static module就发送静态文件的内容到客户端。</h1><p>内容产生阶段完成以后，生成的输出会被传递到filter模块去进行处理。filter模块也是与location相关的。所有的fiter模块都被组织成一条链。输出会依次穿越所有的filter，直到有一个filter模块的返回值表明已经处理完成。</p>
<p>这里列举几个常见的filter模块，例如：</p>
<h1 id=")_server-side_includes。">) server-side includes。</h1><h1 id=")_XSLT_filtering。">) XSLT filtering。</h1><h1 id=")_图像缩放之类的。">) 图像缩放之类的。</h1><h1 id=")_gzip压缩。">) gzip压缩。</h1><p>在所有的filter中，有几个filter模块需要关注一下。按照调用的顺序依次说明如下：</p>
<p>:write: 写输出到客户端，实际上是写到连接对应的socket上。<br>:postpone: 这个filter是负责subrequest的，也就是子请求的。<br>:copy: 将一些需要复制的buf(文件或者内存)重新复制一份然后交给剩余的body filter处理。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/nginx/">nginx</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/nginx/">nginx</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://i404.github.io/2016/01/14/nginx/" data-title="nginx | i404&#39;s Blog" data-tsina="2179056287" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2015/10/01/git_del_files/"  title="git彻底删除文件">
 <strong>下一篇：</strong><br/> 
 <span>git彻底删除文件
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/01/14/nginx/" data-title="nginx" data-url="http://i404.github.io/2016/01/14/nginx/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx平台初探(100%)"><span class="toc-number">1.</span> <span class="toc-text">nginx平台初探(100%)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初探nginx架构(100%)"><span class="toc-number">1.1.</span> <span class="toc-text">初探nginx架构(100%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx基础概念(100%)"><span class="toc-number">1.2.</span> <span class="toc-text">nginx基础概念(100%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本数据结构(99%)"><span class="toc-number">1.3.</span> <span class="toc-text">基本数据结构(99%)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx的请求处理"><span class="toc-number">1.4.</span> <span class="toc-text">nginx的请求处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_操作系统提供的机制（例如epoll,_kqueue等）产生相关的事件。"><span class="toc-number">2.</span> <span class="toc-text">) 操作系统提供的机制（例如epoll, kqueue等）产生相关的事件。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_接收和处理这些事件，如是接受到数据，则产生更高层的request对象。"><span class="toc-number">3.</span> <span class="toc-text">) 接收和处理这些事件，如是接受到数据，则产生更高层的request对象。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理request的header和body。"><span class="toc-number">4.</span> <span class="toc-text">) 处理request的header和body。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_产生响应，并发送回客户端。"><span class="toc-number">5.</span> <span class="toc-text">) 产生响应，并发送回客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_完成request的处理。"><span class="toc-number">6.</span> <span class="toc-text">) 完成request的处理。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_重新初始化定时器及其他事件。"><span class="toc-number">7.</span> <span class="toc-text">) 重新初始化定时器及其他事件。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_初始化HTTP_Request（读取来自客户端的数据，生成HTTP_Request对象，该对象含有该请求所有的信息）。"><span class="toc-number">8.</span> <span class="toc-text">) 初始化HTTP Request（读取来自客户端的数据，生成HTTP Request对象，该对象含有该请求所有的信息）。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理请求头。"><span class="toc-number">9.</span> <span class="toc-text">) 处理请求头。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_处理请求体。"><span class="toc-number">10.</span> <span class="toc-text">) 处理请求体。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果有的话，调用与此请求（URL或者Location）关联的handler。"><span class="toc-number">11.</span> <span class="toc-text">) 如果有的话，调用与此请求（URL或者Location）关联的handler。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_依次调用各phase_handler进行处理。"><span class="toc-number">12.</span> <span class="toc-text">) 依次调用各phase handler进行处理。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_获取location配置。"><span class="toc-number">13.</span> <span class="toc-text">) 获取location配置。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_产生适当的响应。"><span class="toc-number">14.</span> <span class="toc-text">) 产生适当的响应。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_发送response_header。"><span class="toc-number">15.</span> <span class="toc-text">) 发送response header。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_发送response_body。"><span class="toc-number">16.</span> <span class="toc-text">) 发送response body。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_random_index_on，那么随机选择一个文件，发送给客户端。"><span class="toc-number">17.</span> <span class="toc-text">) 如果一个location里面有配置  random_index  on，那么随机选择一个文件，发送给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_index指令，那么发送index指令指明的文件，给客户端。"><span class="toc-number">18.</span> <span class="toc-text">) 如果一个location里面有配置 index指令，那么发送index指令指明的文件，给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果一个location里面有配置_autoindex_on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。"><span class="toc-number">19.</span> <span class="toc-text">) 如果一个location里面有配置 autoindex  on，那么就发送请求地址对应的服务端路径下的文件列表给客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_如果这个request对应的location上有设置gzip_static_on，那么就查找是否有对应的-gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。"><span class="toc-number">20.</span> <span class="toc-text">) 如果这个request对应的location上有设置gzip_static on，那么就查找是否有对应的.gz文件存在，有的话，就发送这个给客户端（客户端支持gzip的情况下）。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_请求的URI如果对应一个静态文件，static_module就发送静态文件的内容到客户端。"><span class="toc-number">21.</span> <span class="toc-text">) 请求的URI如果对应一个静态文件，static module就发送静态文件的内容到客户端。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_server-side_includes。"><span class="toc-number">22.</span> <span class="toc-text">) server-side includes。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_XSLT_filtering。"><span class="toc-number">23.</span> <span class="toc-text">) XSLT filtering。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_图像缩放之类的。"><span class="toc-number">24.</span> <span class="toc-text">) 图像缩放之类的。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#)_gzip压缩。"><span class="toc-number">25.</span> <span class="toc-text">) gzip压缩。</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Meteor/" title="Meteor">Meteor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/acm/" title="acm">acm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/nginx/" title="nginx">nginx<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/命令/" title="命令">命令<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/数学/" title="数学">数学<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/硬件/" title="硬件">硬件<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Monodb/" style="font-size: 10px;">Monodb</a> <a href="/tags/Monteor/" style="font-size: 10px;">Monteor</a> <a href="/tags/OSX/" style="font-size: 10px;">OSX</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/OpenWRT/" style="font-size: 10px;">OpenWRT</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/acm/" style="font-size: 20px;">acm</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-gc/" style="font-size: 10px;">git gc</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/微信公众平台/" style="font-size: 10px;">微信公众平台</a> <a href="/tags/数学/" style="font-size: 10px;">数学</a> <a href="/tags/蔡勒公式/" style="font-size: 10px;">蔡勒公式</a> <a href="/tags/路由器/" style="font-size: 10px;">路由器</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m i404 <br/>
			This is my blog</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2179056287" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/i404" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:linhaoisbr@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="i404">i404</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"i404"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<script>
var option = {
  engineKey: 'c7a141f555176a75bcc6'
};
(function(w,d,t,u,n,s,e){
  s = d.createElement(t);
  s.src = u;
  s.async = 1;
  w[n] = function(r){
    w[n].opts = r;
  };
  e = d.getElementsByTagName(t)[0];
  e.parentNode.insertBefore(s, e);
})(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
_ts(option);
</script>

<!-- Tiny_search End -->

  </body>
</html>
